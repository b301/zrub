<!DOCTYPE html>
<!-- saved from url=(0033)https://beej.us/guide/bgnet/html/ -->
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang=""><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>Beej's Guide to Network Programming</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    svg {
      height: auto;
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!-- BG custom styling -->
  <style type="text/css">
  /* Fix for line numbers not visible */
  pre.numberSource code > span {
      left: -1em;
  }
  pre.numberSource {
      margin-left: initial;
  }

  /* Put some space after the section numbers */
  span.toc-section-number::after {
      content: "\a0\a0\a0";  /* non-breaking whitespace */
  }

  /* Hide underlines on code number links */
  pre > code.sourceCode > span > a:first-child::before {
      text-decoration: none;
  }

  /* Color the source blocks */
  div.sourceCode {
      background-color: #f0f0f0;
  }

  /* Fix iOS big text rendering issue */
  pre > code.sourceCode > span {
      display: initial;
  }


  /* Color the inline code */
  code:not(.sourceCode) {
      background: #f0f0f0;
      padding-left: 0.2em;
      padding-right: 0.2em;
      border-radius: 0.2em;
  }

  pre.sourceCode {
      border: 1px solid #ccc;
      padding: 0.5em;
      border-radius: 0.2em;
  }

  /* Keep code tags from wrapping in tables */
  tbody code {
      white-space: nowrap;
  }

  /* Prevent hyphenation and hyphen breaks in code*/
  code {
      word-break: keep-all;
  }

  td {
      vertical-align: top;
  }

  body {
      font-size: 12pt;
      max-width: 43em;
      font-family: sans-serif;
  }

  html {
      background: #f9f9f9;
  }

  figure > embed {
      max-width: 100%;
  }

  figure {
      text-align: center;
      margin-top: 2em;
      margin-bottom: 2em;
  }

  figcaption {
      font-size: 0.9em;
      font-style: italic;
      margin-top: 0.6em;
  }

  body {
      counter-reset: figure-counter-major;
      counter-reset: figure-counter-minor;
  }

  figure {
      counter-increment: figure-counter-minor;
  }

  figcaption::before {
      content: "Figure " counter(figure-counter-major) "." counter(figure-counter-minor) ": ";
  }

  blockquote {
      border-left: 2px solid #bbb;
      color: #444;
  }

  /*
  In multipage, we need to reset the figure counter to the chapter
  number. Luckily, this is in the <h1 data-number> attribute. Unluckily,
  there is no way to get this in a general way.

  This doesn't work:

    h1[data-number] {
      counter-set: figure-counter-major attr(data-number);
    }

  Nor this:

    h1[data-number] {
      --figure-counter-major-value: attr(data-number);
      counter-set: figure-counter-major var(--figure-counter-major-value);
    }

  So, dumbly, we have a bunch of rules for all these sections, up to the
  maximum possible section.

  Here's a program to generate them:

    for (let i = 1; i < 100; i++)
        console.log(`h1[data-number="${i}"]{counter-set:figure-counter-major ${i};counter-reset:figure-counter-minor;}`);

  Note to self: never write a book with more than 99 frickin' chapters.
  */

  h1[data-number="1"]{counter-set:figure-counter-major 1;counter-reset:figure-counter-minor;}
  h1[data-number="2"]{counter-set:figure-counter-major 2;counter-reset:figure-counter-minor;}
  h1[data-number="3"]{counter-set:figure-counter-major 3;counter-reset:figure-counter-minor;}
  h1[data-number="4"]{counter-set:figure-counter-major 4;counter-reset:figure-counter-minor;}
  h1[data-number="5"]{counter-set:figure-counter-major 5;counter-reset:figure-counter-minor;}
  h1[data-number="6"]{counter-set:figure-counter-major 6;counter-reset:figure-counter-minor;}
  h1[data-number="7"]{counter-set:figure-counter-major 7;counter-reset:figure-counter-minor;}
  h1[data-number="8"]{counter-set:figure-counter-major 8;counter-reset:figure-counter-minor;}
  h1[data-number="9"]{counter-set:figure-counter-major 9;counter-reset:figure-counter-minor;}
  h1[data-number="10"]{counter-set:figure-counter-major 10;counter-reset:figure-counter-minor;}
  h1[data-number="11"]{counter-set:figure-counter-major 11;counter-reset:figure-counter-minor;}
  h1[data-number="12"]{counter-set:figure-counter-major 12;counter-reset:figure-counter-minor;}
  h1[data-number="13"]{counter-set:figure-counter-major 13;counter-reset:figure-counter-minor;}
  h1[data-number="14"]{counter-set:figure-counter-major 14;counter-reset:figure-counter-minor;}
  h1[data-number="15"]{counter-set:figure-counter-major 15;counter-reset:figure-counter-minor;}
  h1[data-number="16"]{counter-set:figure-counter-major 16;counter-reset:figure-counter-minor;}
  h1[data-number="17"]{counter-set:figure-counter-major 17;counter-reset:figure-counter-minor;}
  h1[data-number="18"]{counter-set:figure-counter-major 18;counter-reset:figure-counter-minor;}
  h1[data-number="19"]{counter-set:figure-counter-major 19;counter-reset:figure-counter-minor;}
  h1[data-number="20"]{counter-set:figure-counter-major 20;counter-reset:figure-counter-minor;}
  h1[data-number="21"]{counter-set:figure-counter-major 21;counter-reset:figure-counter-minor;}
  h1[data-number="22"]{counter-set:figure-counter-major 22;counter-reset:figure-counter-minor;}
  h1[data-number="23"]{counter-set:figure-counter-major 23;counter-reset:figure-counter-minor;}
  h1[data-number="24"]{counter-set:figure-counter-major 24;counter-reset:figure-counter-minor;}
  h1[data-number="25"]{counter-set:figure-counter-major 25;counter-reset:figure-counter-minor;}
  h1[data-number="26"]{counter-set:figure-counter-major 26;counter-reset:figure-counter-minor;}
  h1[data-number="27"]{counter-set:figure-counter-major 27;counter-reset:figure-counter-minor;}
  h1[data-number="28"]{counter-set:figure-counter-major 28;counter-reset:figure-counter-minor;}
  h1[data-number="29"]{counter-set:figure-counter-major 29;counter-reset:figure-counter-minor;}
  h1[data-number="30"]{counter-set:figure-counter-major 30;counter-reset:figure-counter-minor;}
  h1[data-number="31"]{counter-set:figure-counter-major 31;counter-reset:figure-counter-minor;}
  h1[data-number="32"]{counter-set:figure-counter-major 32;counter-reset:figure-counter-minor;}
  h1[data-number="33"]{counter-set:figure-counter-major 33;counter-reset:figure-counter-minor;}
  h1[data-number="34"]{counter-set:figure-counter-major 34;counter-reset:figure-counter-minor;}
  h1[data-number="35"]{counter-set:figure-counter-major 35;counter-reset:figure-counter-minor;}
  h1[data-number="36"]{counter-set:figure-counter-major 36;counter-reset:figure-counter-minor;}
  h1[data-number="37"]{counter-set:figure-counter-major 37;counter-reset:figure-counter-minor;}
  h1[data-number="38"]{counter-set:figure-counter-major 38;counter-reset:figure-counter-minor;}
  h1[data-number="39"]{counter-set:figure-counter-major 39;counter-reset:figure-counter-minor;}
  h1[data-number="40"]{counter-set:figure-counter-major 40;counter-reset:figure-counter-minor;}
  h1[data-number="41"]{counter-set:figure-counter-major 41;counter-reset:figure-counter-minor;}
  h1[data-number="42"]{counter-set:figure-counter-major 42;counter-reset:figure-counter-minor;}
  h1[data-number="43"]{counter-set:figure-counter-major 43;counter-reset:figure-counter-minor;}
  h1[data-number="44"]{counter-set:figure-counter-major 44;counter-reset:figure-counter-minor;}
  h1[data-number="45"]{counter-set:figure-counter-major 45;counter-reset:figure-counter-minor;}
  h1[data-number="46"]{counter-set:figure-counter-major 46;counter-reset:figure-counter-minor;}
  h1[data-number="47"]{counter-set:figure-counter-major 47;counter-reset:figure-counter-minor;}
  h1[data-number="48"]{counter-set:figure-counter-major 48;counter-reset:figure-counter-minor;}
  h1[data-number="49"]{counter-set:figure-counter-major 49;counter-reset:figure-counter-minor;}
  h1[data-number="50"]{counter-set:figure-counter-major 50;counter-reset:figure-counter-minor;}
  h1[data-number="51"]{counter-set:figure-counter-major 51;counter-reset:figure-counter-minor;}
  h1[data-number="52"]{counter-set:figure-counter-major 52;counter-reset:figure-counter-minor;}
  h1[data-number="53"]{counter-set:figure-counter-major 53;counter-reset:figure-counter-minor;}
  h1[data-number="54"]{counter-set:figure-counter-major 54;counter-reset:figure-counter-minor;}
  h1[data-number="55"]{counter-set:figure-counter-major 55;counter-reset:figure-counter-minor;}
  h1[data-number="56"]{counter-set:figure-counter-major 56;counter-reset:figure-counter-minor;}
  h1[data-number="57"]{counter-set:figure-counter-major 57;counter-reset:figure-counter-minor;}
  h1[data-number="58"]{counter-set:figure-counter-major 58;counter-reset:figure-counter-minor;}
  h1[data-number="59"]{counter-set:figure-counter-major 59;counter-reset:figure-counter-minor;}
  h1[data-number="60"]{counter-set:figure-counter-major 60;counter-reset:figure-counter-minor;}
  h1[data-number="61"]{counter-set:figure-counter-major 61;counter-reset:figure-counter-minor;}
  h1[data-number="62"]{counter-set:figure-counter-major 62;counter-reset:figure-counter-minor;}
  h1[data-number="63"]{counter-set:figure-counter-major 63;counter-reset:figure-counter-minor;}
  h1[data-number="64"]{counter-set:figure-counter-major 64;counter-reset:figure-counter-minor;}
  h1[data-number="65"]{counter-set:figure-counter-major 65;counter-reset:figure-counter-minor;}
  h1[data-number="66"]{counter-set:figure-counter-major 66;counter-reset:figure-counter-minor;}
  h1[data-number="67"]{counter-set:figure-counter-major 67;counter-reset:figure-counter-minor;}
  h1[data-number="68"]{counter-set:figure-counter-major 68;counter-reset:figure-counter-minor;}
  h1[data-number="69"]{counter-set:figure-counter-major 69;counter-reset:figure-counter-minor;}
  h1[data-number="70"]{counter-set:figure-counter-major 70;counter-reset:figure-counter-minor;}
  h1[data-number="71"]{counter-set:figure-counter-major 71;counter-reset:figure-counter-minor;}
  h1[data-number="72"]{counter-set:figure-counter-major 72;counter-reset:figure-counter-minor;}
  h1[data-number="73"]{counter-set:figure-counter-major 73;counter-reset:figure-counter-minor;}
  h1[data-number="74"]{counter-set:figure-counter-major 74;counter-reset:figure-counter-minor;}
  h1[data-number="75"]{counter-set:figure-counter-major 75;counter-reset:figure-counter-minor;}
  h1[data-number="76"]{counter-set:figure-counter-major 76;counter-reset:figure-counter-minor;}
  h1[data-number="77"]{counter-set:figure-counter-major 77;counter-reset:figure-counter-minor;}
  h1[data-number="78"]{counter-set:figure-counter-major 78;counter-reset:figure-counter-minor;}
  h1[data-number="79"]{counter-set:figure-counter-major 79;counter-reset:figure-counter-minor;}
  h1[data-number="80"]{counter-set:figure-counter-major 80;counter-reset:figure-counter-minor;}
  h1[data-number="81"]{counter-set:figure-counter-major 81;counter-reset:figure-counter-minor;}
  h1[data-number="82"]{counter-set:figure-counter-major 82;counter-reset:figure-counter-minor;}
  h1[data-number="83"]{counter-set:figure-counter-major 83;counter-reset:figure-counter-minor;}
  h1[data-number="84"]{counter-set:figure-counter-major 84;counter-reset:figure-counter-minor;}
  h1[data-number="85"]{counter-set:figure-counter-major 85;counter-reset:figure-counter-minor;}
  h1[data-number="86"]{counter-set:figure-counter-major 86;counter-reset:figure-counter-minor;}
  h1[data-number="87"]{counter-set:figure-counter-major 87;counter-reset:figure-counter-minor;}
  h1[data-number="88"]{counter-set:figure-counter-major 88;counter-reset:figure-counter-minor;}
  h1[data-number="89"]{counter-set:figure-counter-major 89;counter-reset:figure-counter-minor;}
  h1[data-number="90"]{counter-set:figure-counter-major 90;counter-reset:figure-counter-minor;}
  h1[data-number="91"]{counter-set:figure-counter-major 91;counter-reset:figure-counter-minor;}
  h1[data-number="92"]{counter-set:figure-counter-major 92;counter-reset:figure-counter-minor;}
  h1[data-number="93"]{counter-set:figure-counter-major 93;counter-reset:figure-counter-minor;}
  h1[data-number="94"]{counter-set:figure-counter-major 94;counter-reset:figure-counter-minor;}
  h1[data-number="95"]{counter-set:figure-counter-major 95;counter-reset:figure-counter-minor;}
  h1[data-number="96"]{counter-set:figure-counter-major 96;counter-reset:figure-counter-minor;}
  h1[data-number="97"]{counter-set:figure-counter-major 97;counter-reset:figure-counter-minor;}
  h1[data-number="98"]{counter-set:figure-counter-major 98;counter-reset:figure-counter-minor;}
  h1[data-number="99"]{counter-set:figure-counter-major 99;counter-reset:figure-counter-minor;}


  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Beej's Guide to Network Programming</h1>
<p class="subtitle">Using Internet Sockets</p>
<p class="author">Brian “Beej Jorgensen” Hall</p>
<p class="date">v3.2.5, Copyright © February 13, 2025</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="https://beej.us/guide/bgnet/html/#intro" id="toc-intro"><span class="toc-section-number">1</span> Intro</a>
<ul>
<li><a href="https://beej.us/guide/bgnet/html/#audience" id="toc-audience"><span class="toc-section-number">1.1</span> Audience</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#platform-and-compiler" id="toc-platform-and-compiler"><span class="toc-section-number">1.2</span> Platform and Compiler</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#official-homepage-and-books-for-sale" id="toc-official-homepage-and-books-for-sale"><span class="toc-section-number">1.3</span> Official Homepage and Books For Sale</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#solaris" id="toc-solaris"><span class="toc-section-number">1.4</span> Note for Solaris/SunOS/illumos Programmers</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#windows" id="toc-windows"><span class="toc-section-number">1.5</span> Note for Windows Programmers</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#email-policy" id="toc-email-policy"><span class="toc-section-number">1.6</span> Email Policy</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#mirroring" id="toc-mirroring"><span class="toc-section-number">1.7</span> Mirroring</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#note-for-translators" id="toc-note-for-translators"><span class="toc-section-number">1.8</span> Note for Translators</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#legal" id="toc-legal"><span class="toc-section-number">1.9</span> Copyright, Distribution, and Legal</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#dedication" id="toc-dedication"><span class="toc-section-number">1.10</span> Dedication</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#publishing-information" id="toc-publishing-information"><span class="toc-section-number">1.11</span> Publishing Information</a></li>
</ul></li>
<li><a href="https://beej.us/guide/bgnet/html/#what-is-a-socket" id="toc-what-is-a-socket"><span class="toc-section-number">2</span> What is a socket?</a>
<ul>
<li><a href="https://beej.us/guide/bgnet/html/#two-types-of-internet-sockets" id="toc-two-types-of-internet-sockets"><span class="toc-section-number">2.1</span> Two Types of Internet Sockets</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#lowlevel" id="toc-lowlevel"><span class="toc-section-number">2.2</span> Low level Nonsense and Network Theory</a></li>
</ul></li>
<li><a href="https://beej.us/guide/bgnet/html/#ip-addresses-structs-and-data-munging" id="toc-ip-addresses-structs-and-data-munging"><span class="toc-section-number">3</span> IP Addresses, <code>struct</code>s, and Data Munging</a>
<ul>
<li><a href="https://beej.us/guide/bgnet/html/#ip-addresses-versions-4-and-6" id="toc-ip-addresses-versions-4-and-6"><span class="toc-section-number">3.1</span> IP Addresses, versions 4 and 6</a>
<ul>
<li><a href="https://beej.us/guide/bgnet/html/#subnets" id="toc-subnets"><span class="toc-section-number">3.1.1</span> Subnets</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#port-numbers" id="toc-port-numbers"><span class="toc-section-number">3.1.2</span> Port Numbers</a></li>
</ul></li>
<li><a href="https://beej.us/guide/bgnet/html/#byte-order" id="toc-byte-order"><span class="toc-section-number">3.2</span> Byte Order</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#structs" id="toc-structs"><span class="toc-section-number">3.3</span> <code>struct</code>s</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#ip-addresses-part-deux" id="toc-ip-addresses-part-deux"><span class="toc-section-number">3.4</span> IP Addresses, Part Deux</a>
<ul>
<li><a href="https://beej.us/guide/bgnet/html/#private-or-disconnected-networks" id="toc-private-or-disconnected-networks"><span class="toc-section-number">3.4.1</span> Private (Or Disconnected) Networks</a></li>
</ul></li>
</ul></li>
<li><a href="https://beej.us/guide/bgnet/html/#jumping-from-ipv4-to-ipv6" id="toc-jumping-from-ipv4-to-ipv6"><span class="toc-section-number">4</span> Jumping from IPv4 to IPv6</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#system-calls-or-bust" id="toc-system-calls-or-bust"><span class="toc-section-number">5</span> System Calls or Bust</a>
<ul>
<li><a href="https://beej.us/guide/bgnet/html/#getaddrinfoprepare-to-launch" id="toc-getaddrinfoprepare-to-launch"><span class="toc-section-number">5.1</span> <code>getaddrinfo()</code>—Prepare to launch!</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#socket" id="toc-socket"><span class="toc-section-number">5.2</span> <code>socket()</code>—Get the File Descriptor!</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#bind" id="toc-bind"><span class="toc-section-number">5.3</span> <code>bind()</code>—What port am I on?</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#connect" id="toc-connect"><span class="toc-section-number">5.4</span> <code>connect()</code>—Hey, you!</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#listen" id="toc-listen"><span class="toc-section-number">5.5</span> <code>listen()</code>—Will somebody please call me?</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#acceptthank-you-for-calling-port-3490." id="toc-acceptthank-you-for-calling-port-3490."><span class="toc-section-number">5.6</span> <code>accept()</code>—“Thank you for calling port 3490.”</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#sendrecv" id="toc-sendrecv"><span class="toc-section-number">5.7</span> <code>send()</code> and <code>recv()</code>—Talk to me, baby!</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#sendtorecv" id="toc-sendtorecv"><span class="toc-section-number">5.8</span> <code>sendto()</code> and <code>recvfrom()</code>—Talk to me, DGRAM-style</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#close-and-shutdownget-outta-my-face" id="toc-close-and-shutdownget-outta-my-face"><span class="toc-section-number">5.9</span> <code>close()</code> and <code>shutdown()</code>—Get outta my face!</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#getpeernamewho-are-you" id="toc-getpeernamewho-are-you"><span class="toc-section-number">5.10</span> <code>getpeername()</code>—Who are you?</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#gethostnamewho-am-i" id="toc-gethostnamewho-am-i"><span class="toc-section-number">5.11</span> <code>gethostname()</code>—Who am I?</a></li>
</ul></li>
<li><a href="https://beej.us/guide/bgnet/html/#client-server-background" id="toc-client-server-background"><span class="toc-section-number">6</span> Client-Server Background</a>
<ul>
<li><a href="https://beej.us/guide/bgnet/html/#a-simple-stream-server" id="toc-a-simple-stream-server"><span class="toc-section-number">6.1</span> A Simple Stream Server</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#a-simple-stream-client" id="toc-a-simple-stream-client"><span class="toc-section-number">6.2</span> A Simple Stream Client</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#datagram" id="toc-datagram"><span class="toc-section-number">6.3</span> Datagram Sockets</a></li>
</ul></li>
<li><a href="https://beej.us/guide/bgnet/html/#slightly-advanced-techniques" id="toc-slightly-advanced-techniques"><span class="toc-section-number">7</span> Slightly Advanced Techniques</a>
<ul>
<li><a href="https://beej.us/guide/bgnet/html/#blocking" id="toc-blocking"><span class="toc-section-number">7.1</span> Blocking</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#poll" id="toc-poll"><span class="toc-section-number">7.2</span> <code>poll()</code>—Synchronous I/O Multiplexing</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#select" id="toc-select"><span class="toc-section-number">7.3</span> <code>select()</code>—Synchronous I/O Multiplexing, Old School</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#sendall" id="toc-sendall"><span class="toc-section-number">7.4</span> Handling Partial <code>send()</code>s</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#serialization" id="toc-serialization"><span class="toc-section-number">7.5</span> Serialization—How to Pack Data</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#sonofdataencap" id="toc-sonofdataencap"><span class="toc-section-number">7.6</span> Son of Data Encapsulation</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#broadcast-packetshello-world" id="toc-broadcast-packetshello-world"><span class="toc-section-number">7.7</span> Broadcast Packets—Hello, World!</a></li>
</ul></li>
<li><a href="https://beej.us/guide/bgnet/html/#common-questions" id="toc-common-questions"><span class="toc-section-number">8</span> Common Questions</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#man-pages" id="toc-man-pages"><span class="toc-section-number">9</span> Man Pages</a>
<ul>
<li><a href="https://beej.us/guide/bgnet/html/#acceptman" id="toc-acceptman"><span class="toc-section-number">9.1</span> <code>accept()</code></a></li>
<li><a href="https://beej.us/guide/bgnet/html/#bindman" id="toc-bindman"><span class="toc-section-number">9.2</span> <code>bind()</code></a></li>
<li><a href="https://beej.us/guide/bgnet/html/#connectman" id="toc-connectman"><span class="toc-section-number">9.3</span> <code>connect()</code></a></li>
<li><a href="https://beej.us/guide/bgnet/html/#closeman" id="toc-closeman"><span class="toc-section-number">9.4</span> <code>close()</code></a></li>
<li><a href="https://beej.us/guide/bgnet/html/#getaddrinfoman" id="toc-getaddrinfoman"><span class="toc-section-number">9.5</span> <code>getaddrinfo()</code>, <code>freeaddrinfo()</code>, <code>gai_strerror()</code></a></li>
<li><a href="https://beej.us/guide/bgnet/html/#gethostnameman" id="toc-gethostnameman"><span class="toc-section-number">9.6</span> <code>gethostname()</code></a></li>
<li><a href="https://beej.us/guide/bgnet/html/#gethostbynameman" id="toc-gethostbynameman"><span class="toc-section-number">9.7</span> <code>gethostbyname()</code>, <code>gethostbyaddr()</code></a></li>
<li><a href="https://beej.us/guide/bgnet/html/#getnameinfoman" id="toc-getnameinfoman"><span class="toc-section-number">9.8</span> <code>getnameinfo()</code></a></li>
<li><a href="https://beej.us/guide/bgnet/html/#getpeernameman" id="toc-getpeernameman"><span class="toc-section-number">9.9</span> <code>getpeername()</code></a></li>
<li><a href="https://beej.us/guide/bgnet/html/#errnoman" id="toc-errnoman"><span class="toc-section-number">9.10</span> <code>errno</code></a></li>
<li><a href="https://beej.us/guide/bgnet/html/#fcntlman" id="toc-fcntlman"><span class="toc-section-number">9.11</span> <code>fcntl()</code></a></li>
<li><a href="https://beej.us/guide/bgnet/html/#htonsman" id="toc-htonsman"><span class="toc-section-number">9.12</span> <code>htons()</code>, <code>htonl()</code>, <code>ntohs()</code>, <code>ntohl()</code></a></li>
<li><a href="https://beej.us/guide/bgnet/html/#inet_ntoaman" id="toc-inet_ntoaman"><span class="toc-section-number">9.13</span> <code>inet_ntoa()</code>, <code>inet_aton()</code>, <code>inet_addr</code></a></li>
<li><a href="https://beej.us/guide/bgnet/html/#inet_ntopman" id="toc-inet_ntopman"><span class="toc-section-number">9.14</span> <code>inet_ntop()</code>, <code>inet_pton()</code></a></li>
<li><a href="https://beej.us/guide/bgnet/html/#listenman" id="toc-listenman"><span class="toc-section-number">9.15</span> <code>listen()</code></a></li>
<li><a href="https://beej.us/guide/bgnet/html/#perrorman" id="toc-perrorman"><span class="toc-section-number">9.16</span> <code>perror()</code>, <code>strerror()</code></a></li>
<li><a href="https://beej.us/guide/bgnet/html/#pollman" id="toc-pollman"><span class="toc-section-number">9.17</span> <code>poll()</code></a></li>
<li><a href="https://beej.us/guide/bgnet/html/#recvman" id="toc-recvman"><span class="toc-section-number">9.18</span> <code>recv()</code>, <code>recvfrom()</code></a></li>
<li><a href="https://beej.us/guide/bgnet/html/#selectman" id="toc-selectman"><span class="toc-section-number">9.19</span> <code>select()</code></a></li>
<li><a href="https://beej.us/guide/bgnet/html/#setsockoptman" id="toc-setsockoptman"><span class="toc-section-number">9.20</span> <code>setsockopt()</code>, <code>getsockopt()</code></a></li>
<li><a href="https://beej.us/guide/bgnet/html/#sendman" id="toc-sendman"><span class="toc-section-number">9.21</span> <code>send()</code>, <code>sendto()</code></a></li>
<li><a href="https://beej.us/guide/bgnet/html/#shutdownman" id="toc-shutdownman"><span class="toc-section-number">9.22</span> <code>shutdown()</code></a></li>
<li><a href="https://beej.us/guide/bgnet/html/#socketman" id="toc-socketman"><span class="toc-section-number">9.23</span> <code>socket()</code></a></li>
<li><a href="https://beej.us/guide/bgnet/html/#structsockaddrman" id="toc-structsockaddrman"><span class="toc-section-number">9.24</span> <code>struct sockaddr</code> and pals</a></li>
</ul></li>
<li><a href="https://beej.us/guide/bgnet/html/#more-references" id="toc-more-references"><span class="toc-section-number">10</span> More References</a>
<ul>
<li><a href="https://beej.us/guide/bgnet/html/#books" id="toc-books"><span class="toc-section-number">10.1</span> Books</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#web-references" id="toc-web-references"><span class="toc-section-number">10.2</span> Web References</a></li>
<li><a href="https://beej.us/guide/bgnet/html/#rfcs" id="toc-rfcs"><span class="toc-section-number">10.3</span> RFCs</a></li>
</ul></li>
</ul>
</nav>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="1" id="intro"><span class="header-section-number">1</span> Intro</h1>
<!--
Beej's Guide to Network Programming book source

# vim: ts=4:sw=4:nosi:et:tw=72
-->
<!--
    History:

    2.3.2:        socket man page
    2.3.3:        sockaddr_in man page
    2.3.4:        bind, listen man page
    2.3.5:        connect man page
    2.3.6:        listen, perror man page
    2.3.7:        errno man page
    2.3.8:        htonl etc man page
    2.3.9:        close man page, expanded man page leader
    2.3.10:        inet_ntoa, setsockopt man pages
    2.3.11:        getpeername man page
    2.3.12:        send/sendto man pages
    2.3.13:        shutdown man pages
    2.3.14:        gethostname man pages, fix inet_aton links
    2.3.15:        fcntl man page
    2.3.16:        recv/recvfrom man page
    2.3.17:        gethostbyname/gethostbyaddr man page
    2.3.18:        changed GET / to GET / HTTP/1.0
    2.3.19:        added select() man page
    2.3.20:        added poll() man page
    2.3.21:        section on NAT and reserved networks
    2.3.22:        typo fixes in sects "man" and "privnet"
    2.3.23:        added broadcast packets section
    2.3.24:        manpage prototype changed to code, subtitle moved out of title
    2.4.0:        big overhaul, serialization stuff
    2.4.1:        minor text changes in intro
    2.4.2:        changed all sizeofs to use variable names instead of types
    2.4.3:        fix myaddr->my_addr in listener.c, sockaddr_inman example
    2.4.4:        fix myaddr->my_addr in server.c
    2.4.5:        fix 14->18 in son of data encap
    3.0.0:        IPv6 overhaul
    3.0.1:        sa-to-sa6 typo fix
    3.0.2:        typo fixes
    3.0.3:        typo fixes
    3.0.4:        cut-n-paste errors, selectserver hints fix
    3.0.5:        typo fixes
    3.0.6:        typo fixes
    3.0.7:        typo fixes, added front matter
    3.0.8:        getpeername() code fixes
    3.0.9:        getpeername() code fixes, this time fer sure
    3.0.10:        bind() man page code fix, comment changes
    3.0.11:        socket syscall section code fix, comment changes
    3.0.12:        typos in "IP Addresses, structs, and Data Munging"
    3.0.13:        amp removals, note about errno and multithreading
    3.0.14:        type changes to listener.c, pack2.c
    3.0.15:        fix inet_pton example
    3.0.16:        fix simple server output, optlen in getsockopt man page
    3.0.17:        fix small typo
    3.0.18:        reverse perror and close calls in getaddrinfo
    3.0.19:        add notes about O_NONBLOCK with select() under Linux
    3.0.20:        fix missing .fd in poll() example
    3.0.21:        change sizeof(int) to sizeof yes
    3.0.22:     C99 updates, bug fixes, markdown
    3.0.23:     Book reference and URL updates
    3.1.0:      Section on poll()
    3.1.1:      Add WSL note, telnot
    3.1.2:      pollserver.c bugfix
    3.1.3:      Fix freeaddrinfo memleak
    3.1.4:      Fix accept example header files
    3.1.5:      Fix dgram AF_UNSPEC
-->
<!-- prevent hyphenation of the following words: -->
<!--
Don't know how to make this work with underscores. I love
you, Knuth, but... daaahm.

\hyphenation{gai_strerr}
-->
<!--
\hyphenation{inet_ntoa}
\hyphenation{inet_aton}
\hyphenation{inet_addr}
\hyphenation{inet_ntop}
\hyphenation{inet_pton}
-->
<!--
\hyphenation{sockaddr_in}
\hyphenation{in_addr}
\hyphenation{sockaddr_in6}
\hyphenation{in6_addr}
-->
<p>Hey! Socket programming got you down? Is this stuff just a little too difficult to figure out from the <code>man</code> pages? You want to do cool Internet programming, but you don’t have time to wade through a gob of <code>struct</code>s trying to figure out if you have to call <code>bind()</code> before you <code>connect()</code>, etc., etc.</p>
<p>Well, guess what! I’ve already done this nasty business, and I’m dying to share the information with everyone! You’ve come to the right place. This document should give the average competent C programmer the edge s/he needs to get a grip on this networking noise.</p>
<p>And check it out: I’ve finally caught up with the future (just in the nick of time, too!) and have updated the Guide for IPv6! Enjoy!</p>
<h2 data-number="1.1" id="audience"><span class="header-section-number">1.1</span> Audience</h2>
<p>This document has been written as a tutorial, not a complete reference. It is probably at its best when read by individuals who are just starting out with socket programming and are looking for a foothold. It is certainly not the <em>complete and total</em> guide to sockets programming, by any means.</p>
<p>Hopefully, though, it’ll be just enough for those man pages to start making sense… <code>:-)</code></p>
<h2 data-number="1.2" id="platform-and-compiler"><span class="header-section-number">1.2</span> Platform and Compiler</h2>
<p>The code contained within this document was compiled on a Linux PC using Gnu’s <code>gcc</code> compiler. It should, however, build on just about any platform that uses <code>gcc</code>. Naturally, this doesn’t apply if you’re programming for Windows—see the <a href="https://beej.us/guide/bgnet/html/#windows">section on Windows programming</a>, below.</p>
<h2 data-number="1.3" id="official-homepage-and-books-for-sale"><span class="header-section-number">1.3</span> Official Homepage and Books For Sale</h2>
<p>This official location of this document is:</p>
<ul>
<li><a href="https://beej.us/guide/bgnet/"><code>https://beej.us/guide/bgnet/</code></a></li>
</ul>
<p>There you will also find example code and translations of the guide into various languages.</p>
<p>To buy nicely bound print copies (some call them “books”), visit:</p>
<ul>
<li><a href="https://beej.us/guide/url/bgbuy"><code>https://beej.us/guide/url/bgbuy</code></a></li>
</ul>
<p>I’ll appreciate the purchase because it helps sustain my document-writing lifestyle!</p>
<h2 data-number="1.4" id="solaris"><span class="header-section-number">1.4</span> Note for Solaris/SunOS/illumos Programmers</h2>
<p>When compiling for a Solaris variant or SunOS, you need to specify some extra command-line switches for linking in the proper libraries. In order to do this, simply add “<code>-lnsl -lsocket -lresolv</code>” to the end of the compile command, like so:</p>
<pre><code>$ cc -o server server.c -lnsl -lsocket -lresolv</code></pre>
<p>If you still get errors, you could try further adding a <code>-lxnet</code> to the end of that command line. I don’t know what that does, exactly, but some people seem to need it.</p>
<p>Another place that you might find problems is in the call to <code>setsockopt()</code>. The prototype differs from that on my Linux box, so instead of:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="https://beej.us/guide/bgnet/html/#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> yes<span class="op">=</span><span class="dv">1</span><span class="op">;</span></span></code></pre></div>
<p>enter this:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb3-1"><a href="https://beej.us/guide/bgnet/html/#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> yes<span class="op">=</span><span class="ch">'1'</span><span class="op">;</span></span></code></pre></div>
<p>As I don’t have a Sun box, I haven’t tested any of the above information—it’s just what people have told me through email.</p>
<h2 data-number="1.5" id="windows"><span class="header-section-number">1.5</span> Note for Windows Programmers</h2>
<p>At this point in the guide, historically, I’ve done a bit of bagging on Windows, simply due to the fact that I don’t like it very much. But then Windows and Microsoft (as a company) got a lot better. Windows 9 and 10 coupled with WSL (below) actually were decent operating systems. Not really a lot to complain about.</p>
<p>Well, a little—for example, I’m writing this (in 2025) on a 2015 laptop that used to run Windows 10. Eventually it got too slow and I installed Linux on it. And have been using it ever since.</p>
<p>And now the news is out that Windows 11 will require beefier hardware than Windows 10. I’m not a fan of that. The OS should be as unobtrusive as possible and not require you to spend more money. The extra CPU power should be for apps, not the OS!</p>
<p>So I still encourage you to try <a href="https://www.linux.com/">Linux</a><a href="https://beej.us/guide/bgnet/html/#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>, <a href="https://bsd.org/">BSD</a><a href="https://beej.us/guide/bgnet/html/#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>, <a href="https://www.illumos.org/">illumos</a><a href="https://beej.us/guide/bgnet/html/#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> or some other flavor of Unix, instead.</p>
<p>How’d that soapbox get there?</p>
<p>But people like what they like, and you Windows folk will be pleased to know that this information is generally applicable to Windows, with a few minor changes.</p>
<p>Oh, hey, the soapbox is back!</p>
<p>One thing that you should strongly consider is the <a href="https://learn.microsoft.com/en-us/windows/wsl/">Windows Subsystem for Linux</a><a href="https://beej.us/guide/bgnet/html/#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>. This basically allows you to install a Linux VM-ish thing on Windows 10. That will also definitely get you situated, and you’ll be able to build and run these programs as is.</p>
<p>Another thing you can do is install <a href="https://cygwin.com/">Cygwin</a><a href="https://beej.us/guide/bgnet/html/#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>, which is a collection of Unix tools for Windows. I’ve heard on the grapevine that doing so allows all these programs to compile unmodified, but I’ve never tried it.</p>
<p>Some of you might want to do things the Pure Windows Way. That’s very gutsy of you, and this is what you have to do: run out and get Unix immediately! No, no—I’m kidding. I’m supposed to be Windows-friendly(er) these days…</p>
<p>Okay, okay. I’ll get on with it.</p>
<p></p>
<p>This is what you’ll have to do: first, ignore pretty much all of the system header files I mention in here. Instead, include:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb4-1"><a href="https://beej.us/guide/bgnet/html/#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;winsock2.h&gt;</span></span>
<span id="cb4-2"><a href="https://beej.us/guide/bgnet/html/#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;ws2tcpip.h&gt;</span></span></code></pre></div>
<p><code>winsock2</code> is the “new” (circa 1994) version of the Windows socket library.</p>
<p>Unfortunately, if you include <code>windows.h</code>, it automatically pulls in the older <code>winsock.h</code> (version 1) header file which conflicts with <code>winsock2.h</code>! Fun times.</p>
<p>So if you have to include <code>windows.h</code>, you need to define a macro to get it to <em>not</em> include the older header:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb5-1"><a href="https://beej.us/guide/bgnet/html/#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define WIN32_LEAN_AND_MEAN  </span><span class="co">// Say this...</span></span>
<span id="cb5-2"><a href="https://beej.us/guide/bgnet/html/#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="https://beej.us/guide/bgnet/html/#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;windows.h&gt;</span><span class="pp">         </span><span class="co">// And now we can include that.</span></span>
<span id="cb5-4"><a href="https://beej.us/guide/bgnet/html/#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;winsock2.h&gt;</span><span class="pp">        </span><span class="co">// And this.</span></span></code></pre></div>
<p>Wait! You also have to make a call to <code>WSAStartup()</code> before doing anything else with the sockets library. You pass in the Winsock version you desire to this function (e.g.&nbsp;version 2.2). And then you can check the result to make sure that version is available.</p>
<p>The code to do that looks something like this:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb6-1"><a href="https://beej.us/guide/bgnet/html/#cb6-1"></a><span class="pp">#include </span><span class="im">&lt;winsock2.h&gt;</span></span>
<span id="cb6-2"><a href="https://beej.us/guide/bgnet/html/#cb6-2"></a></span>
<span id="cb6-3"><a href="https://beej.us/guide/bgnet/html/#cb6-3"></a><span class="op">{</span></span>
<span id="cb6-4"><a href="https://beej.us/guide/bgnet/html/#cb6-4"></a>    WSADATA wsaData<span class="op">;</span></span>
<span id="cb6-5"><a href="https://beej.us/guide/bgnet/html/#cb6-5"></a></span>
<span id="cb6-6"><a href="https://beej.us/guide/bgnet/html/#cb6-6"></a>    <span class="cf">if</span> <span class="op">(</span>WSAStartup<span class="op">(</span>MAKEWORD<span class="op">(</span><span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">),</span> <span class="op">&amp;</span>wsaData<span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-7"><a href="https://beej.us/guide/bgnet/html/#cb6-7"></a>        fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">"WSAStartup failed.</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb6-8"><a href="https://beej.us/guide/bgnet/html/#cb6-8"></a>        exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb6-9"><a href="https://beej.us/guide/bgnet/html/#cb6-9"></a>    <span class="op">}</span></span>
<span id="cb6-10"><a href="https://beej.us/guide/bgnet/html/#cb6-10"></a></span>
<span id="cb6-11"><a href="https://beej.us/guide/bgnet/html/#cb6-11"></a>    <span class="cf">if</span> <span class="op">(</span>LOBYTE<span class="op">(</span>wsaData<span class="op">.</span>wVersion<span class="op">)</span> <span class="op">!=</span> <span class="dv">2</span> <span class="op">||</span></span>
<span id="cb6-12"><a href="https://beej.us/guide/bgnet/html/#cb6-12"></a>        HIBYTE<span class="op">(</span>wsaData<span class="op">.</span>wVersion<span class="op">)</span> <span class="op">!=</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb6-13"><a href="https://beej.us/guide/bgnet/html/#cb6-13"></a>    <span class="op">{</span></span>
<span id="cb6-14"><a href="https://beej.us/guide/bgnet/html/#cb6-14"></a>        fprintf<span class="op">(</span>stderr<span class="op">,</span><span class="st">"Version 2.2 of Winsock not available.</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb6-15"><a href="https://beej.us/guide/bgnet/html/#cb6-15"></a>        WSACleanup<span class="op">();</span></span>
<span id="cb6-16"><a href="https://beej.us/guide/bgnet/html/#cb6-16"></a>        exit<span class="op">(</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb6-17"><a href="https://beej.us/guide/bgnet/html/#cb6-17"></a>    <span class="op">}</span></span></code></pre></div>
<p>Note that call to <code>WSACleanup()</code> in there. That’s what you want to call when you’re done with the Winsock library.</p>
<p>You also have to tell your compiler to link in the Winsock library, called <code>ws2_32.lib</code> for Winsock 2. Under VC++, this can be done through the <code>Project</code> menu, under <code>Settings...</code>. Click the <code>Link</code> tab, and look for the box titled “Object/library modules”. Add “ws2_32.lib” (or whichever lib is your preference) to that list.</p>
<p>Or so I hear.</p>
<p>Once you do that, the rest of the examples in this tutorial should generally apply, with a few exceptions. For one thing, you can’t use <code>close()</code> to close a socket—you need to use <code>closesocket()</code>, instead. Also, <code>select()</code> only works with socket descriptors, not file descriptors (like <code>0</code> for <code>stdin</code>).</p>
<p>There is also a socket class that you can use, <a href="https://learn.microsoft.com/en-us/cpp/mfc/reference/csocket-class?view=msvc-170"><code>CSocket</code></a> Check your compiler’s help pages for more information.</p>
<p>To get more information about Winsock, <a href="https://learn.microsoft.com/en-us/windows/win32/winsock/windows-sockets-start-page-2">check out the official page at Microsoft</a>.</p>
<p>Finally, I hear that Windows has no <code>fork()</code> system call which is, unfortunately, used in some of my examples. Maybe you have to link in a POSIX library or something to get it to work, or you can use <code>CreateProcess()</code> instead. <code>fork()</code> takes no arguments, and <code>CreateProcess()</code> takes about 48 billion arguments. If you’re not up to that, the <code>CreateThread()</code> is a little easier to digest…unfortunately a discussion about multithreading is beyond the scope of this document. I can only talk about so much, you know!</p>
<p>Extra finally, Steven Mitchell has <a href="https://www.tallyhawk.net/WinsockExamples/">ported a number of the examples</a><a href="https://beej.us/guide/bgnet/html/#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> to Winsock. Check that stuff out.</p>
<h2 data-number="1.6" id="email-policy"><span class="header-section-number">1.6</span> Email Policy</h2>
<p>I’m generally available to help out with email questions so feel free to write in, but I can’t guarantee a response. I lead a pretty busy life and there are times when I just can’t answer a question you have. When that’s the case, I usually just delete the message. It’s nothing personal; I just won’t ever have the time to give the detailed answer you require.</p>
<p>As a rule, the more complex the question, the less likely I am to respond. If you can narrow down your question before mailing it and be sure to include any pertinent information (like platform, compiler, error messages you’re getting, and anything else you think might help me troubleshoot), you’re much more likely to get a response. For more pointers, read ESR’s document, <a href="http://www.catb.org/~esr/faqs/smart-questions.html">How To Ask Questions The Smart Way</a><a href="https://beej.us/guide/bgnet/html/#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>.</p>
<p>If you don’t get a response, hack on it some more, try to find the answer, and if it’s still elusive, then write me again with the information you’ve found and hopefully it will be enough for me to help out.</p>
<p>Now that I’ve badgered you about how to write and not write me, I’d just like to let you know that I <em>fully</em> appreciate all the praise the guide has received over the years. It’s a real morale boost, and it gladdens me to hear that it is being used for good! <code>:-)</code> Thank you!</p>
<h2 data-number="1.7" id="mirroring"><span class="header-section-number">1.7</span> Mirroring</h2>
<p> You are more than welcome to mirror this site, whether publicly or privately. If you publicly mirror the site and want me to link to it from the main page, drop me a line at <a href="https://beej.us/guide/bgnet/html/beej@beej.us"><code>beej@beej.us</code></a>.</p>
<h2 data-number="1.8" id="note-for-translators"><span class="header-section-number">1.8</span> Note for Translators</h2>
<p> If you want to translate the guide into another language, write me at <a href="https://beej.us/guide/bgnet/html/beej@beej.us"><code>beej@beej.us</code></a> and I’ll link to your translation from the main page. Feel free to add your name and contact info to the translation.</p>
<p>This source markdown document uses UTF-8 encoding.</p>
<p>Please note the license restrictions in the <a href="https://beej.us/guide/bgnet/html/#legal">Copyright, Distribution, and Legal</a> section, below.</p>
<p>If you want me to host the translation, just ask. I’ll also link to it if you want to host it; either way is fine.</p>
<h2 data-number="1.9" id="legal"><span class="header-section-number">1.9</span> Copyright, Distribution, and Legal</h2>
<p>Beej’s Guide to Network Programming is Copyright © 2019 Brian “Beej Jorgensen” Hall.</p>
<p>With specific exceptions for source code and translations, below, this work is licensed under the Creative Commons Attribution- Noncommercial- No Derivative Works 3.0 License. To view a copy of this license, visit</p>
<p><a href="https://creativecommons.org/licenses/by-nc-nd/3.0/"><code>https://creativecommons.org/licenses/by-nc-nd/3.0/</code></a></p>
<p>or send a letter to Creative Commons, 171 Second Street, Suite 300, San Francisco, California, 94105, USA.</p>
<p>One specific exception to the “No Derivative Works” portion of the license is as follows: this guide may be freely translated into any language, provided the translation is accurate, and the guide is reprinted in its entirety. The same license restrictions apply to the translation as to the original guide. The translation may also include the name and contact information for the translator.</p>
<p>The C source code presented in this document is hereby granted to the public domain, and is completely free of any license restriction.</p>
<p>Educators are freely encouraged to recommend or supply copies of this guide to their students.</p>
<p>Unless otherwise mutually agreed by the parties in writing, the author offers the work as-is and makes no representations or warranties of any kind concerning the work, express, implied, statutory or otherwise, including, without limitation, warranties of title, merchantability, fitness for a particular purpose, noninfringement, or the absence of latent or other defects, accuracy, or the presence of absence of errors, whether or not discoverable.</p>
<p>Except to the extent required by applicable law, in no event will the author be liable to you on any legal theory for any special, incidental, consequential, punitive or exemplary damages arising out of the use of the work, even if the author has been advised of the possibility of such damages.</p>
<p>Contact <a href="mailto:beej@beej.us"><code>beej@beej.us</code></a> for more information.</p>
<h2 data-number="1.10" id="dedication"><span class="header-section-number">1.10</span> Dedication</h2>
<p>Thanks to everyone who has helped in the past and future with me getting this guide written. And thank you to all the people who produce the Free software and packages that I use to make the Guide: GNU, Linux, Slackware, vim, Python, Inkscape, pandoc, many others. And finally a big thank-you to the literally thousands of you who have written in with suggestions for improvements and words of encouragement.</p>
<p>I dedicate this guide to some of my biggest heroes and inpirators in the world of computers: Donald Knuth, Bruce Schneier, W. Richard Stevens, and The Woz, my Readership, and the entire Free and Open Source Software Community.</p>
<h2 data-number="1.11" id="publishing-information"><span class="header-section-number">1.11</span> Publishing Information</h2>
<p>This book is written in Markdown using the vim editor on an Arch Linux box loaded with GNU tools. The cover “art” and diagrams are produced with Inkscape. The Markdown is converted to HTML and LaTex/PDF by Python, Pandoc and XeLaTeX, using Liberation fonts. The toolchain is composed of 100% Free and Open Source Software.</p>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="2" id="what-is-a-socket"><span class="header-section-number">2</span> What is a socket?</h1>
<p>You hear talk of “sockets” all the time, and perhaps you are wondering just what they are exactly. Well, they’re this: a way to speak to other programs using standard Unix file descriptors.</p>
<p>What?</p>
<p>Ok—you may have heard some Unix hacker state, “Jeez, <em>everything</em> in Unix is a file!” What that person may have been talking about is the fact that when Unix programs do any sort of I/O, they do it by reading or writing to a file descriptor. A file descriptor is simply an integer associated with an open file. But (and here’s the catch), that file can be a network connection, a FIFO, a pipe, a terminal, a real on-the-disk file, or just about anything else. Everything in Unix <em>is</em> a file! So when you want to communicate with another program over the Internet you’re gonna do it through a file descriptor, you’d better believe it.</p>
<p>“Where do I get this file descriptor for network communication, Mr. Smarty-Pants?” is probably the last question on your mind right now, but I’m going to answer it anyway: You make a call to the <code>socket()</code> system routine. It returns the socket descriptor, and you communicate through it using the specialized <code>send()</code> and <code>recv()</code> (<a href="https://beej.us/guide/bgnet/html/#sendman"><code>man send</code></a>, <a href="https://beej.us/guide/bgnet/html/#recvman"><code>man recv</code></a>) socket calls.</p>
<p>“But, hey!” you might be exclaiming right about now. “If it’s a file descriptor, why in the name of Neptune can’t I just use the normal <code>read()</code> and <code>write()</code> calls to communicate through the socket?” The short answer is, “You can!” The longer answer is, “You can, but <code>send()</code> and <code>recv()</code> offer much greater control over your data transmission.”</p>
<p>What next? How about this: there are all kinds of sockets. There are DARPA Internet addresses (Internet Sockets), path names on a local node (Unix Sockets), CCITT X.25 addresses (X.25 Sockets that you can safely ignore), and probably many others depending on which Unix flavor you run. This document deals only with the first: Internet Sockets.</p>
<h2 data-number="2.1" id="two-types-of-internet-sockets"><span class="header-section-number">2.1</span> Two Types of Internet Sockets</h2>
<p>What’s this? There are two types of Internet sockets? Yes. Well, no. I’m lying. There are more, but I didn’t want to scare you. I’m only going to talk about two types here. Except for this sentence, where I’m going to tell you that “Raw Sockets” are also very powerful and you should look them up.</p>
<p>All right, already. What are the two types? One is “Stream Sockets”; the other is “Datagram Sockets”, which may hereafter be referred to as “<code>SOCK_STREAM</code>” and “<code>SOCK_DGRAM</code>”, respectively. Datagram sockets are sometimes called “connectionless sockets”. (Though they can be <code>connect()</code>’d if you really want. See <a href="https://beej.us/guide/bgnet/html/#connect"><code>connect()</code></a>, below.)</p>
<p>Stream sockets are reliable two-way connected communication streams. If you output two items into the socket in the order “1, 2”, they will arrive in the order “1, 2” at the opposite end. They will also be error-free. I’m so certain, in fact, they will be error-free, that I’m just going to put my fingers in my ears and chant <em>la la la la</em> if anyone tries to claim otherwise.</p>
<p>What uses stream sockets? Well, you may have heard of the <code>telnet</code> or <code>ssh</code> applications, yes? They use stream sockets. All the characters you type need to arrive in the same order you type them, right? Also, web browsers use the Hypertext Transfer Protocol (HTTP) which uses stream sockets to get pages. Indeed, if you telnet to a web site on port 80, and type “<code>GET / HTTP/1.0</code>” and hit RETURN twice, it’ll dump the HTML back at you!</p>
<blockquote>
<p>If you don’t have <code>telnet</code> installed and don’t want to install it, or your <code>telnet</code> is being picky about connecting to clients, the guide comes with a <code>telnet</code>-like program called <a href="https://beej.us/guide/bgnet/source/examples/telnot.c"><code>telnot</code></a><a href="https://beej.us/guide/bgnet/html/#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>. This should work well for all the needs of the guide. (Note that telnet is actually a <a href="https://tools.ietf.org/html/rfc854">spec’d networking protocol</a><a href="https://beej.us/guide/bgnet/html/#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a>, and <code>telnot</code> doesn’t implement this protocol at all.)</p>
</blockquote>
<p>How do stream sockets achieve this high level of data transmission quality? They use a protocol called “The Transmission Control Protocol”, otherwise known as “TCP” (see <a href="https://tools.ietf.org/html/rfc793">RFC 793</a><a href="https://beej.us/guide/bgnet/html/#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a> for extremely detailed info on TCP). TCP makes sure your data arrives sequentially and error-free. You may have heard “TCP” before as the better half of “TCP/IP” where “IP” stands for “Internet Protocol” (see <a href="https://tools.ietf.org/html/rfc791">RFC 791</a><a href="https://beej.us/guide/bgnet/html/#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a>). IP deals primarily with Internet routing and is not generally responsible for data integrity.</p>
<p></p>
<p>Cool. What about Datagram sockets? Why are they called connectionless? What is the deal, here, anyway? Why are they unreliable? Well, here are some facts: if you send a datagram, it may arrive. It may arrive out of order. If it arrives, the data within the packet will be error-free.</p>
<p>Datagram sockets also use IP for routing, but they don’t use TCP; they use the “User Datagram Protocol”, or “UDP” (see <a href="https://tools.ietf.org/html/rfc768">RFC 768</a><a href="https://beej.us/guide/bgnet/html/#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a>).</p>
<p>Why are they connectionless? Well, basically, it’s because you don’t have to maintain an open connection as you do with stream sockets. You just build a packet, slap an IP header on it with destination information, and send it out. No connection needed. They are generally used either when a TCP stack is unavailable or when a few dropped packets here and there don’t mean the end of the Universe. Sample applications: <code>tftp</code> (trivial file transfer protocol, a little brother to FTP), <code>dhcpcd</code> (a DHCP client), multiplayer games, streaming audio, video conferencing, etc.</p>
<p></p>
<p>“Wait a minute! <code>tftp</code> and <code>dhcpcd</code> are used to transfer binary applications from one host to another! Data can’t be lost if you expect the application to work when it arrives! What kind of dark magic is this?”</p>
<p>Well, my human friend, <code>tftp</code> and similar programs have their own protocol on top of UDP. For example, the tftp protocol says that for each packet that gets sent, the recipient has to send back a packet that says, “I got it!” (an “ACK” packet). If the sender of the original packet gets no reply in, say, five seconds, he’ll re-transmit the packet until he finally gets an ACK. This acknowledgment procedure is very important when implementing reliable <code>SOCK_DGRAM</code> applications.</p>
<p>For unreliable applications like games, audio, or video, you just ignore the dropped packets, or perhaps try to cleverly compensate for them. (Quake players will know the manifestation this effect by the technical term: <em>accursed lag</em>. The word “accursed”, in this case, represents any extremely profane utterance.)</p>
<p>Why would you use an unreliable underlying protocol? Two reasons: speed and speed. It’s way faster to fire-and-forget than it is to keep track of what has arrived safely and make sure it’s in order and all that. If you’re sending chat messages, TCP is great; if you’re sending 40 positional updates per second of the players in the world, maybe it doesn’t matter so much if one or two get dropped, and UDP is a good choice.</p>
<h2 data-number="2.2" id="lowlevel"><span class="header-section-number">2.2</span> Low level Nonsense and Network Theory</h2>
<p>Since I just mentioned layering of protocols, it’s time to talk about how networks really work, and to show some examples of how <code>SOCK_DGRAM</code> packets are built. Practically, you can probably skip this section. It’s good background, however.</p>
<figure>
<embed src="dataencap.svg" title="[Encapsulated Protocols Diagram]">
<figcaption aria-hidden="true">Data Encapsulation.</figcaption>
</figure>
<p>Hey, kids, it’s time to learn about <em>Data Encapsulation</em>! This is very very important. It’s so important that you might just learn about it if you take the networks course here at Chico State <code>;-)</code>. Basically, it says this: a packet is born, the packet is wrapped (“encapsulated”) in a header (and rarely a footer) by the first protocol (say, the TFTP protocol), then the whole thing (TFTP header included) is encapsulated again by the next protocol (say, UDP), then again by the next (IP), then again by the final protocol on the hardware (physical) layer (say, Ethernet).</p>
<p>When another computer receives the packet, the hardware strips the Ethernet header, the kernel strips the IP and UDP headers, the TFTP program strips the TFTP header, and it finally has the data.</p>
<p>Now I can finally talk about the infamous <em>Layered Network Model</em> (aka “ISO/OSI”). This Network Model describes a system of network functionality that has many advantages over other models. For instance, you can write sockets programs that are exactly the same without caring how the data is physically transmitted (serial, thin Ethernet, AUI, whatever) because programs on lower levels deal with it for you. The actual network hardware and topology is transparent to the socket programmer.</p>
<p>Without any further ado, I’ll present the layers of the full-blown model. Remember this for network class exams:</p>
<ul>
<li>Application</li>
<li>Presentation</li>
<li>Session</li>
<li>Transport</li>
<li>Network</li>
<li>Data Link</li>
<li>Physical</li>
</ul>
<p>The Physical Layer is the hardware (serial, Ethernet, etc.). The Application Layer is just about as far from the physical layer as you can imagine—it’s the place where users interact with the network.</p>
<p>Now, this model is so general you could probably use it as an automobile repair guide if you really wanted to. A layered model more consistent with Unix might be:</p>
<ul>
<li>Application Layer (<em>telnet, ftp, etc.</em>)</li>
<li>Host-to-Host Transport Layer (<em>TCP, UDP</em>)</li>
<li>Internet Layer (<em>IP and routing</em>)</li>
<li>Network Access Layer (<em>Ethernet, wi-fi, or whatever</em>)</li>
</ul>
<p>At this point in time, you can probably see how these layers correspond to the encapsulation of the original data.</p>
<p>See how much work there is in building a simple packet? Jeez! And you have to type in the packet headers yourself using “<code>cat</code>”! Just kidding. All you have to do for stream sockets is <code>send()</code> the data out. All you have to do for datagram sockets is encapsulate the packet in the method of your choosing and <code>sendto()</code> it out. The kernel builds the Transport Layer and Internet Layer on for you and the hardware does the Network Access Layer. Ah, modern technology.</p>
<p>So ends our brief foray into network theory. Oh yes, I forgot to tell you everything I wanted to say about routing: nothing! That’s right, I’m not going to talk about it at all. The router strips the packet to the IP header, consults its routing table, <em>blah blah blah</em>. Check out the <a href="https://tools.ietf.org/html/rfc791">IP RFC</a><a href="https://beej.us/guide/bgnet/html/#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a> if you really really care. If you never learn about it, well, you’ll live.</p>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="3" id="ip-addresses-structs-and-data-munging"><span class="header-section-number">3</span> IP Addresses, <code>struct</code>s, and Data Munging</h1>
<p>Here’s the part of the game where we get to talk code for a change.</p>
<p>But first, let’s discuss more non-code! Yay! First I want to talk about IP addresses and ports for just a tad so we have that sorted out. Then we’ll talk about how the sockets API stores and manipulates IP addresses and other data.</p>
<h2 data-number="3.1" id="ip-addresses-versions-4-and-6"><span class="header-section-number">3.1</span> IP Addresses, versions 4 and 6</h2>
<p>In the good old days back when Ben Kenobi was still called Obi Wan Kenobi, there was a wonderful network routing system called The Internet Protocol Version 4, also called IPv4. It had addresses made up of four bytes (A.K.A. four “octets”), and was commonly written in “dots and numbers” form, like so: <code>192.0.2.111</code>.</p>
<p>You’ve probably seen it around.</p>
<p>In fact, as of this writing, virtually every site on the Internet uses IPv4.</p>
<p>Everyone, including Obi Wan, was happy. Things were great, until some naysayer by the name of Vint Cerf warned everyone that we were about to run out of IPv4 addresses!</p>
<p>(Besides warning everyone of the Coming IPv4 Apocalypse Of Doom And Gloom, <a href="https://en.wikipedia.org/wiki/Vint_Cerf">Vint Cerf</a><a href="https://beej.us/guide/bgnet/html/#fn14" class="footnote-ref" id="fnref14" role="doc-noteref"><sup>14</sup></a> is also well-known for being The Father Of The Internet. So I really am in no position to second-guess his judgment.)</p>
<p>Run out of addresses? How could this be? I mean, there are like billions of IP addresses in a 32-bit IPv4 address. Do we really have billions of computers out there?</p>
<p>Yes.</p>
<p>Also, in the beginning, when there were only a few computers and everyone thought a billion was an impossibly large number, some big organizations were generously allocated millions of IP addresses for their own use. (Such as Xerox, MIT, Ford, HP, IBM, GE, AT&amp;T, and some little company called Apple, to name a few.)</p>
<p>In fact, if it weren’t for several stopgap measures, we would have run out a long time ago.</p>
<p>But now we’re living in an era where we’re talking about every human having an IP address, every computer, every calculator, every phone, every parking meter, and (why not) every puppy dog, as well.</p>
<p>And so, IPv6 was born. Since Vint Cerf is probably immortal (even if his physical form should pass on, heaven forbid, he is probably already existing as some kind of hyper-intelligent <a href="https://en.wikipedia.org/wiki/ELIZA">ELIZA</a><a href="https://beej.us/guide/bgnet/html/#fn15" class="footnote-ref" id="fnref15" role="doc-noteref"><sup>15</sup></a> program out in the depths of the Internet2), no one wants to have to hear him say again “I told you so” if we don’t have enough addresses in the next version of the Internet Protocol.</p>
<p>What does this suggest to you?</p>
<p>That we need a <em>lot</em> more addresses. That we need not just twice as many addresses, not a billion times as many, not a thousand trillion times as many, but <em>79 MILLION BILLION TRILLION times as many possible addresses!</em> That’ll show ’em!</p>
<p>You’re saying, “Beej, is that true? I have every reason to disbelieve large numbers.” Well, the difference between 32 bits and 128 bits might not sound like a lot; it’s only 96 more bits, right? But remember, we’re talking powers here: 32 bits represents some 4 billion numbers (2<sup>32</sup>), while 128 bits represents about 340 trillion trillion trillion numbers (for real, 2<sup>128</sup>). That’s like a million IPv4 Internets for <em>every single star in the Universe</em>.</p>
<p>Forget this dots-and-numbers look of IPv4, too; now we’ve got a hexadecimal representation, with each two-byte chunk separated by a colon, like this:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode default"><code class="sourceCode default"><span id="cb7-1"><a href="https://beej.us/guide/bgnet/html/#cb7-1" aria-hidden="true" tabindex="-1"></a>2001:0db8:c9d2:aee5:73e3:934a:a5ae:9551</span></code></pre></div>
<p>That’s not all! Lots of times, you’ll have an IP address with lots of zeros in it, and you can compress them between two colons. And you can leave off leading zeros for each byte pair. For instance, each of these pairs of addresses are equivalent:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode default"><code class="sourceCode default"><span id="cb8-1"><a href="https://beej.us/guide/bgnet/html/#cb8-1" aria-hidden="true" tabindex="-1"></a>2001:0db8:c9d2:0012:0000:0000:0000:0051</span>
<span id="cb8-2"><a href="https://beej.us/guide/bgnet/html/#cb8-2" aria-hidden="true" tabindex="-1"></a>2001:db8:c9d2:12::51</span>
<span id="cb8-3"><a href="https://beej.us/guide/bgnet/html/#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="https://beej.us/guide/bgnet/html/#cb8-4" aria-hidden="true" tabindex="-1"></a>2001:0db8:ab00:0000:0000:0000:0000:0000</span>
<span id="cb8-5"><a href="https://beej.us/guide/bgnet/html/#cb8-5" aria-hidden="true" tabindex="-1"></a>2001:db8:ab00::</span>
<span id="cb8-6"><a href="https://beej.us/guide/bgnet/html/#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="https://beej.us/guide/bgnet/html/#cb8-7" aria-hidden="true" tabindex="-1"></a>0000:0000:0000:0000:0000:0000:0000:0001</span>
<span id="cb8-8"><a href="https://beej.us/guide/bgnet/html/#cb8-8" aria-hidden="true" tabindex="-1"></a>::1</span></code></pre></div>
<p>The address <code>::1</code> is the <em>loopback address</em>. It always means “this machine I’m running on now”. In IPv4, the loopback address is <code>127.0.0.1</code>.</p>
<p>Finally, there’s an IPv4-compatibility mode for IPv6 addresses that you might come across. If you want, for example, to represent the IPv4 address <code>192.0.2.33</code> as an IPv6 address, you use the following notation: “<code>::ffff:192.0.2.33</code>”.</p>
<p>We’re talking serious fun.</p>
<p>In fact, it’s such serious fun, that the Creators of IPv6 have quite cavalierly lopped off trillions and trillions of addresses for reserved use, but we have so many, frankly, who’s even counting anymore? There are plenty left over for every man, woman, child, puppy, and parking meter on every planet in the galaxy. And believe me, every planet in the galaxy has parking meters. You know it’s true.</p>
<h3 data-number="3.1.1" id="subnets"><span class="header-section-number">3.1.1</span> Subnets</h3>
<p>For organizational reasons, it’s sometimes convenient to declare that “this first part of this IP address up through this bit is the <em>network portion</em> of the IP address, and the remainder is the <em>host portion</em>.</p>
<p>For instance, with IPv4, you might have <code>192.0.2.12</code>, and we could say that the first three bytes are the network and the last byte was the host. Or, put another way, we’re talking about host <code>12</code> on network <code>192.0.2.0</code> (see how we zero out the byte that was the host).</p>
<p>And now for more outdated information! Ready? In the Ancient Times, there were “classes” of subnets, where the first one, two, or three bytes of the address was the network part. If you were lucky enough to have one byte for the network and three for the host, you could have 24 bits-worth of hosts on your network (16 million or so). That was a “Class A” network. On the opposite end was a “Class C”, with three bytes of network, and one byte of host (256 hosts, minus a couple that were reserved).</p>
<p>So as you can see, there were just a few Class As, a huge pile of Class Cs, and some Class Bs in the middle.</p>
<p>The network portion of the IP address is described by something called the <em>netmask</em>, which you bitwise-AND with the IP address to get the network number out of it. The netmask usually looks something like <code>255.255.255.0</code>. (E.g. with that netmask, if your IP is <code>192.0.2.12</code>, then your network is <code>192.0.2.12</code> AND <code>255.255.255.0</code> which gives <code>192.0.2.0</code>.)</p>
<p>Unfortunately, it turned out that this wasn’t fine-grained enough for the eventual needs of the Internet; we were running out of Class C networks quite quickly, and we were most definitely out of Class As, so don’t even bother to ask. To remedy this, The Powers That Be allowed for the netmask to be an arbitrary number of bits, not just 8, 16, or 24. So you might have a netmask of, say <code>255.255.255.252</code>, which is 30 bits of network, and 2 bits of host allowing for four hosts on the network. (Note that the netmask is <em>ALWAYS</em> a bunch of 1-bits followed by a bunch of 0-bits.)</p>
<p>But it’s a bit unwieldy to use a big string of numbers like <code>255.192.0.0</code> as a netmask. First of all, people don’t have an intuitive idea of how many bits that is, and secondly, it’s really not compact. So the New Style came along, and it’s much nicer. You just put a slash after the IP address, and then follow that by the number of network bits in decimal. Like this: <code>192.0.2.12/30</code>.</p>
<p>Or, for IPv6, something like this: <code>2001:db8::/32</code> or <code>2001:db8:5413:4028::9db9/64</code>.</p>
<h3 data-number="3.1.2" id="port-numbers"><span class="header-section-number">3.1.2</span> Port Numbers</h3>
<p>If you’ll kindly remember, I presented you earlier with the <a href="https://beej.us/guide/bgnet/html/#lowlevel">Layered Network Model</a> which had the Internet Layer (IP) split off from the Host-to-Host Transport Layer (TCP and UDP). Get up to speed on that before the next paragraph.</p>
<p>Turns out that besides an IP address (used by the IP layer), there is another address that is used by TCP (stream sockets) and, coincidentally, by UDP (datagram sockets). It is the <em>port number</em>. It’s a 16-bit number that’s like the local address for the connection.</p>
<p>Think of the IP address as the street address of a hotel, and the port number as the room number. That’s a decent analogy; maybe later I’ll come up with one involving the automobile industry.</p>
<p>Say you want to have a computer that handles incoming mail AND web services—how do you differentiate between the two on a computer with a single IP address?</p>
<p>Well, different services on the Internet have different well-known port numbers. You can see them all in <a href="https://www.iana.org/assignments/port-numbers">the Big IANA Port List</a><a href="https://beej.us/guide/bgnet/html/#fn16" class="footnote-ref" id="fnref16" role="doc-noteref"><sup>16</sup></a> or, if you’re on a Unix box, in your <code>/etc/services</code> file. HTTP (the web) is port 80, telnet is port 23, SMTP is port 25, the game <a href="https://en.wikipedia.org/wiki/Doom_(1993_video_game)">DOOM</a><a href="https://beej.us/guide/bgnet/html/#fn17" class="footnote-ref" id="fnref17" role="doc-noteref"><sup>17</sup></a> used port 666, etc. and so on. Ports under 1024 are often considered special, and usually require special OS privileges to use.</p>
<p>And that’s about it!</p>
<h2 data-number="3.2" id="byte-order"><span class="header-section-number">3.2</span> Byte Order</h2>
<p> By Order of the Realm! There shall be two byte orderings, hereafter to be known as Lame and Magnificent!</p>
<p>I joke, but one really is better than the other. <code>:-)</code></p>
<p>There really is no easy way to say this, so I’ll just blurt it out: your computer might have been storing bytes in reverse order behind your back. I know! No one wanted to have to tell you.</p>
<p>The thing is, everyone in the Internet world has generally agreed that if you want to represent the two-byte hex number, say <code>b34f</code>, you’ll store it in two sequential bytes <code>b3</code> followed by <code>4f</code>. Makes sense, and, as <a href="https://en.wikipedia.org/wiki/Wilford_Brimley">Wilford Brimley</a><a href="https://beej.us/guide/bgnet/html/#fn18" class="footnote-ref" id="fnref18" role="doc-noteref"><sup>18</sup></a> would tell you, it’s the Right Thing To Do. This number, stored with the big end first, is called <em>Big-Endian</em>.</p>
<p>Unfortunately, a <em>few</em> computers scattered here and there throughout the world, namely anything with an Intel or Intel-compatible processor, store the bytes reversed, so <code>b34f</code> would be stored in memory as the sequential bytes <code>4f</code> followed by <code>b3</code>. This storage method is called <em>Little-Endian</em>.</p>
<p>But wait, I’m not done with terminology yet! The more-sane <em>Big-Endian</em> is also called <em>Network Byte Order</em> because that’s the order us network types like.</p>
<p>Your computer stores numbers in <em>Host Byte Order</em>. If it’s an Intel 80x86, Host Byte Order is Little-Endian. If it’s a Motorola 68k, Host Byte Order is Big-Endian. If it’s a PowerPC, Host Byte Order is… well, it depends!</p>
<p>A lot of times when you’re building packets or filling out data structures you’ll need to make sure your two- and four-byte numbers are in Network Byte Order. But how can you do this if you don’t know the native Host Byte Order?</p>
<p>Good news! You just get to assume the Host Byte Order isn’t right, and you always run the value through a function to set it to Network Byte Order. The function will do the magic conversion if it has to, and this way your code is portable to machines of differing endianness.</p>
<p>All righty. There are two types of numbers that you can convert: <code>short</code> (two bytes) and <code>long</code> (four bytes). These functions work for the <code>unsigned</code> variations as well. Say you want to convert a <code>short</code> from Host Byte Order to Network Byte Order. Start with “h” for “host”, follow it with “to”, then “n” for “network”, and “s” for “short”: h-to-n-s, or <code>htons()</code> (read: “Host to Network Short”).</p>
<p>It’s almost too easy…</p>
<p>You can use every combination of “n”, “h”, “s”, and “l” you want, not counting the really stupid ones. For example, there is NOT a <code>stolh()</code> (“Short to Long Host”) function—not at this party, anyway. But there are:</p>
<table>
<colgroup>
<col style="width: 26%">
<col style="width: 73%">
</colgroup>
<thead>
<tr class="header">
<th>Function</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>htons()</code></td>
<td><code>h</code>ost <code>to</code> <code>n</code>etwork <code>s</code>hort</td>
</tr>
<tr class="even">
<td><code>htonl()</code></td>
<td><code>h</code>ost <code>to</code> <code>n</code>etwork <code>l</code>ong</td>
</tr>
<tr class="odd">
<td><code>ntohs()</code></td>
<td><code>n</code>etwork <code>to</code> <code>h</code>ost <code>s</code>hort</td>
</tr>
<tr class="even">
<td><code>ntohl()</code></td>
<td><code>n</code>etwork <code>to</code> <code>h</code>ost <code>l</code>ong</td>
</tr>
</tbody>
</table>
<p>Basically, you’ll want to convert the numbers to Network Byte Order before they go out on the wire, and convert them to Host Byte Order as they come in off the wire.</p>
<p>I don’t know of a 64-bit variant, sorry. And if you want to do floating point, check out the section on <a href="https://beej.us/guide/bgnet/html/#serialization">Serialization</a>, far below.</p>
<p>Assume the numbers in this document are in Host Byte Order unless I say otherwise.</p>
<h2 data-number="3.3" id="structs"><span class="header-section-number">3.3</span> <code>struct</code>s</h2>
<p>Well, we’re finally here. It’s time to talk about programming. In this section, I’ll cover various data types used by the sockets interface, since some of them are a real bear to figure out.</p>
<p>First the easy one: a socket descriptor. A socket descriptor is the following type:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb9-1"><a href="https://beej.us/guide/bgnet/html/#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span></code></pre></div>
<p>Just a regular <code>int</code>.</p>
<p>Things get weird from here, so just read through and bear with me.</p>
<p>My First Struct™—<code>struct addrinfo</code>. This structure is a more recent invention, and is used to prep the socket address structures for subsequent use. It’s also used in host name lookups, and service name lookups. That’ll make more sense later when we get to actual usage, but just know for now that it’s one of the first things you’ll call when making a connection.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb10-1"><a href="https://beej.us/guide/bgnet/html/#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> addrinfo <span class="op">{</span></span>
<span id="cb10-2"><a href="https://beej.us/guide/bgnet/html/#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span>              ai_flags<span class="op">;</span>     <span class="co">// AI_PASSIVE, AI_CANONNAME, etc.</span></span>
<span id="cb10-3"><a href="https://beej.us/guide/bgnet/html/#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span>              ai_family<span class="op">;</span>    <span class="co">// AF_INET, AF_INET6, AF_UNSPEC</span></span>
<span id="cb10-4"><a href="https://beej.us/guide/bgnet/html/#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span>              ai_socktype<span class="op">;</span>  <span class="co">// SOCK_STREAM, SOCK_DGRAM</span></span>
<span id="cb10-5"><a href="https://beej.us/guide/bgnet/html/#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span>              ai_protocol<span class="op">;</span>  <span class="co">// use 0 for "any"</span></span>
<span id="cb10-6"><a href="https://beej.us/guide/bgnet/html/#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span>           ai_addrlen<span class="op">;</span>   <span class="co">// size of ai_addr in bytes</span></span>
<span id="cb10-7"><a href="https://beej.us/guide/bgnet/html/#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> sockaddr <span class="op">*</span>ai_addr<span class="op">;</span>      <span class="co">// struct sockaddr_in or _in6</span></span>
<span id="cb10-8"><a href="https://beej.us/guide/bgnet/html/#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span>            <span class="op">*</span>ai_canonname<span class="op">;</span> <span class="co">// full canonical hostname</span></span>
<span id="cb10-9"><a href="https://beej.us/guide/bgnet/html/#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="https://beej.us/guide/bgnet/html/#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> addrinfo <span class="op">*</span>ai_next<span class="op">;</span>      <span class="co">// linked list, next node</span></span>
<span id="cb10-11"><a href="https://beej.us/guide/bgnet/html/#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>You’ll load this struct up a bit, and then call <code>getaddrinfo()</code>. It’ll return a pointer to a new linked list of these structures filled out with all the goodies you need.</p>
<p>You can force it to use IPv4 or IPv6 in the <code>ai_family</code> field, or leave it as <code>AF_UNSPEC</code> to use whatever. This is cool because your code can be IP version-agnostic.</p>
<p>Note that this is a linked list: <code>ai_next</code> points at the next element—there could be several results for you to choose from. I’d use the first result that worked, but you might have different business needs; I don’t know everything, man!</p>
<p>You’ll see that the <code>ai_addr</code> field in the <code>struct addrinfo</code> is a pointer to a <code>struct sockaddr</code>. This is where we start getting into the nitty-gritty details of what’s inside an IP address structure.</p>
<p>You might not usually need to write to these structures; oftentimes, a call to <code>getaddrinfo()</code> to fill out your <code>struct addrinfo</code> for you is all you’ll need. You <em>will</em>, however, have to peer inside these <code>struct</code>s to get the values out, so I’m presenting them here.</p>
<p>(Also, all the code written before <code>struct addrinfo</code> was invented we packed all this stuff by hand, so you’ll see a lot of IPv4 code out in the wild that does exactly that. You know, in old versions of this guide and so on.)</p>
<p>Some <code>struct</code>s are IPv4, some are IPv6, and some are both. I’ll make notes of which are what.</p>
<p>Anyway, the <code>struct sockaddr</code> holds socket address information for many types of sockets.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb11-1"><a href="https://beej.us/guide/bgnet/html/#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> sockaddr <span class="op">{</span></span>
<span id="cb11-2"><a href="https://beej.us/guide/bgnet/html/#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">short</span>    sa_family<span class="op">;</span>    <span class="co">// address family, AF_xxx</span></span>
<span id="cb11-3"><a href="https://beej.us/guide/bgnet/html/#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span>              sa_data<span class="op">[</span><span class="dv">14</span><span class="op">];</span>  <span class="co">// 14 bytes of protocol address</span></span>
<span id="cb11-4"><a href="https://beej.us/guide/bgnet/html/#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="op">};</span> </span></code></pre></div>
<p><code>sa_family</code> can be a variety of things, but it’ll be <code>AF_INET</code> (IPv4) or <code>AF_INET6</code> (IPv6) for everything we do in this document. <code>sa_data</code> contains a destination address and port number for the socket. This is rather unwieldy since you don’t want to tediously pack the address in the <code>sa_data</code> by hand.</p>
<p>To deal with <code>struct sockaddr</code>, programmers created a parallel structure: <code>struct sockaddr_in</code> (“in” for “Internet”) to be used with IPv4.</p>
<p>And <em>this is the important</em> bit: a pointer to a <code>struct sockaddr_in</code> can be cast to a pointer to a <code>struct sockaddr</code> and vice-versa. So even though <code>connect()</code> wants a <code>struct sockaddr*</code>, you can still use a <code>struct sockaddr_in</code> and cast it at the last minute!</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb12-1"><a href="https://beej.us/guide/bgnet/html/#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">// (IPv4 only--see struct sockaddr_in6 for IPv6)</span></span>
<span id="cb12-2"><a href="https://beej.us/guide/bgnet/html/#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="https://beej.us/guide/bgnet/html/#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> sockaddr_in <span class="op">{</span></span>
<span id="cb12-4"><a href="https://beej.us/guide/bgnet/html/#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">short</span> <span class="dt">int</span>          sin_family<span class="op">;</span>  <span class="co">// Address family, AF_INET</span></span>
<span id="cb12-5"><a href="https://beej.us/guide/bgnet/html/#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">short</span> <span class="dt">int</span> sin_port<span class="op">;</span>    <span class="co">// Port number</span></span>
<span id="cb12-6"><a href="https://beej.us/guide/bgnet/html/#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> in_addr     sin_addr<span class="op">;</span>    <span class="co">// Internet address</span></span>
<span id="cb12-7"><a href="https://beej.us/guide/bgnet/html/#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">char</span>      sin_zero<span class="op">[</span><span class="dv">8</span><span class="op">];</span> <span class="co">// Same size as struct sockaddr</span></span>
<span id="cb12-8"><a href="https://beej.us/guide/bgnet/html/#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>This structure makes it easy to reference elements of the socket address. Note that <code>sin_zero</code> (which is included to pad the structure to the length of a <code>struct sockaddr</code>) should be set to all zeros with the function <code>memset()</code>. Also, notice that <code>sin_family</code> corresponds to <code>sa_family</code> in a <code>struct sockaddr</code> and should be set to “<code>AF_INET</code>”. Finally, the <code>sin_port</code> must be in <em>Network Byte Order</em> (by using <code>htons()</code>!)</p>
<p>Let’s dig deeper! You see the <code>sin_addr</code> field is a <code>struct in_addr</code>. What is that thing? Well, not to be overly dramatic, but it’s one of the scariest unions of all time:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb13-1"><a href="https://beej.us/guide/bgnet/html/#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">// (IPv4 only--see struct in6_addr for IPv6)</span></span>
<span id="cb13-2"><a href="https://beej.us/guide/bgnet/html/#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="https://beej.us/guide/bgnet/html/#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Internet address (a structure for historical reasons)</span></span>
<span id="cb13-4"><a href="https://beej.us/guide/bgnet/html/#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> in_addr <span class="op">{</span></span>
<span id="cb13-5"><a href="https://beej.us/guide/bgnet/html/#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> s_addr<span class="op">;</span> <span class="co">// that's a 32-bit int (4 bytes)</span></span>
<span id="cb13-6"><a href="https://beej.us/guide/bgnet/html/#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>Whoa! Well, it <em>used</em> to be a union, but now those days seem to be gone. Good riddance. So if you have declared <code>ina</code> to be of type <code>struct sockaddr_in</code>, then <code>ina.sin_addr.s_addr</code> references the 4-byte IP address (in Network Byte Order). Note that even if your system still uses the God-awful union for <code>struct in_addr</code>, you can still reference the 4-byte IP address in exactly the same way as I did above (this due to <code>#define</code>s).</p>
<p>What about IPv6? Similar <code>struct</code>s exist for it, as well:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb14-1"><a href="https://beej.us/guide/bgnet/html/#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">// (IPv6 only--see struct sockaddr_in and struct in_addr for IPv4)</span></span>
<span id="cb14-2"><a href="https://beej.us/guide/bgnet/html/#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="https://beej.us/guide/bgnet/html/#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> sockaddr_in6 <span class="op">{</span></span>
<span id="cb14-4"><a href="https://beej.us/guide/bgnet/html/#cb14-4" aria-hidden="true" tabindex="-1"></a>    u_int16_t       sin6_family<span class="op">;</span>   <span class="co">// address family, AF_INET6</span></span>
<span id="cb14-5"><a href="https://beej.us/guide/bgnet/html/#cb14-5" aria-hidden="true" tabindex="-1"></a>    u_int16_t       sin6_port<span class="op">;</span>     <span class="co">// port number, Network Byte Order</span></span>
<span id="cb14-6"><a href="https://beej.us/guide/bgnet/html/#cb14-6" aria-hidden="true" tabindex="-1"></a>    u_int32_t       sin6_flowinfo<span class="op">;</span> <span class="co">// IPv6 flow information</span></span>
<span id="cb14-7"><a href="https://beej.us/guide/bgnet/html/#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> in6_addr sin6_addr<span class="op">;</span>     <span class="co">// IPv6 address</span></span>
<span id="cb14-8"><a href="https://beej.us/guide/bgnet/html/#cb14-8" aria-hidden="true" tabindex="-1"></a>    u_int32_t       sin6_scope_id<span class="op">;</span> <span class="co">// Scope ID</span></span>
<span id="cb14-9"><a href="https://beej.us/guide/bgnet/html/#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb14-10"><a href="https://beej.us/guide/bgnet/html/#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="https://beej.us/guide/bgnet/html/#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> in6_addr <span class="op">{</span></span>
<span id="cb14-12"><a href="https://beej.us/guide/bgnet/html/#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">char</span>   s6_addr<span class="op">[</span><span class="dv">16</span><span class="op">];</span>   <span class="co">// IPv6 address</span></span>
<span id="cb14-13"><a href="https://beej.us/guide/bgnet/html/#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>Note that IPv6 has an IPv6 address and a port number, just like IPv4 has an IPv4 address and a port number.</p>
<p>Also note that I’m not going to talk about the IPv6 flow information or Scope ID fields for the moment… this is just a starter guide. <code>:-)</code></p>
<p>Last but not least, here is another simple structure, <code>struct sockaddr_storage</code> that is designed to be large enough to hold both IPv4 and IPv6 structures. See, for some calls, sometimes you don’t know in advance if it’s going to fill out your <code>struct sockaddr</code> with an IPv4 or IPv6 address. So you pass in this parallel structure, very similar to <code>struct sockaddr</code> except larger, and then cast it to the type you need:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb15-1"><a href="https://beej.us/guide/bgnet/html/#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> sockaddr_storage <span class="op">{</span></span>
<span id="cb15-2"><a href="https://beej.us/guide/bgnet/html/#cb15-2" aria-hidden="true" tabindex="-1"></a>    sa_family_t  ss_family<span class="op">;</span>     <span class="co">// address family</span></span>
<span id="cb15-3"><a href="https://beej.us/guide/bgnet/html/#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="https://beej.us/guide/bgnet/html/#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// all this is padding, implementation specific, ignore it:</span></span>
<span id="cb15-5"><a href="https://beej.us/guide/bgnet/html/#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span>      __ss_pad1<span class="op">[</span>_SS_PAD1SIZE<span class="op">];</span></span>
<span id="cb15-6"><a href="https://beej.us/guide/bgnet/html/#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int64_t</span>   __ss_align<span class="op">;</span></span>
<span id="cb15-7"><a href="https://beej.us/guide/bgnet/html/#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span>      __ss_pad2<span class="op">[</span>_SS_PAD2SIZE<span class="op">];</span></span>
<span id="cb15-8"><a href="https://beej.us/guide/bgnet/html/#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>What’s important is that you can see the address family in the <code>ss_family</code> field—check this to see if it’s <code>AF_INET</code> or <code>AF_INET6</code> (for IPv4 or IPv6). Then you can cast it to a <code>struct sockaddr_in</code> or <code>struct sockaddr_in6</code> if you wanna.</p>
<h2 data-number="3.4" id="ip-addresses-part-deux"><span class="header-section-number">3.4</span> IP Addresses, Part Deux</h2>
<p>Fortunately for you, there are a bunch of functions that allow you to manipulate IP addresses. No need to figure them out by hand and stuff them in a <code>long</code> with the <code>&lt;&lt;</code> operator.</p>
<p>First, let’s say you have a <code>struct sockaddr_in ina</code>, and you have an IP address “<code>10.12.110.57</code>” or “<code>2001:db8:63b3:1::3490</code>” that you want to store into it. The function you want to use, <code>inet_pton()</code>, converts an IP address in numbers-and-dots notation into either a <code>struct in_addr</code> or a <code>struct in6_addr</code> depending on whether you specify <code>AF_INET</code> or <code>AF_INET6</code>. (“<code>pton</code>” stands for “presentation to network”—you can call it “printable to network” if that’s easier to remember.) The conversion can be made as follows:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb16-1"><a href="https://beej.us/guide/bgnet/html/#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> sockaddr_in sa<span class="op">;</span> <span class="co">// IPv4</span></span>
<span id="cb16-2"><a href="https://beej.us/guide/bgnet/html/#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> sockaddr_in6 sa6<span class="op">;</span> <span class="co">// IPv6</span></span>
<span id="cb16-3"><a href="https://beej.us/guide/bgnet/html/#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="https://beej.us/guide/bgnet/html/#cb16-4" aria-hidden="true" tabindex="-1"></a>inet_pton<span class="op">(</span>AF_INET<span class="op">,</span> <span class="st">"10.12.110.57"</span><span class="op">,</span> <span class="op">&amp;(</span>sa<span class="op">.</span>sin_addr<span class="op">));</span> <span class="co">// IPv4</span></span>
<span id="cb16-5"><a href="https://beej.us/guide/bgnet/html/#cb16-5" aria-hidden="true" tabindex="-1"></a>inet_pton<span class="op">(</span>AF_INET6<span class="op">,</span> <span class="st">"2001:db8:63b3:1::3490"</span><span class="op">,</span> <span class="op">&amp;(</span>sa6<span class="op">.</span>sin6_addr<span class="op">));</span> <span class="co">// IPv6</span></span></code></pre></div>
<p>(Quick note: the old way of doing things used a function called <code>inet_addr()</code> or another function called <code>inet_aton()</code>; these are now obsolete and don’t work with IPv6.)</p>
<p>Now, the above code snippet isn’t very robust because there is no error checking. See, <code>inet_pton()</code> returns <code>-1</code> on error, or 0 if the address is messed up. So check to make sure the result is greater than 0 before using!</p>
<p>All right, now you can convert string IP addresses to their binary representations. What about the other way around? What if you have a <code>struct in_addr</code> and you want to print it in numbers-and-dots notation? (Or a <code>struct in6_addr</code> that you want in, uh, “hex-and-colons” notation.) In this case, you’ll want to use the function <code>inet_ntop()</code> (“ntop” means “network to presentation”—you can call it “network to printable” if that’s easier to remember), like this:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb17-1"><a href="https://beej.us/guide/bgnet/html/#cb17-1"></a><span class="co">// IPv4:</span></span>
<span id="cb17-2"><a href="https://beej.us/guide/bgnet/html/#cb17-2"></a></span>
<span id="cb17-3"><a href="https://beej.us/guide/bgnet/html/#cb17-3"></a><span class="dt">char</span> ip4<span class="op">[</span>INET_ADDRSTRLEN<span class="op">];</span>  <span class="co">// space to hold the IPv4 string</span></span>
<span id="cb17-4"><a href="https://beej.us/guide/bgnet/html/#cb17-4"></a><span class="kw">struct</span> sockaddr_in sa<span class="op">;</span>      <span class="co">// pretend this is loaded with something</span></span>
<span id="cb17-5"><a href="https://beej.us/guide/bgnet/html/#cb17-5"></a></span>
<span id="cb17-6"><a href="https://beej.us/guide/bgnet/html/#cb17-6"></a>inet_ntop<span class="op">(</span>AF_INET<span class="op">,</span> <span class="op">&amp;(</span>sa<span class="op">.</span>sin_addr<span class="op">),</span> ip4<span class="op">,</span> INET_ADDRSTRLEN<span class="op">);</span></span>
<span id="cb17-7"><a href="https://beej.us/guide/bgnet/html/#cb17-7"></a></span>
<span id="cb17-8"><a href="https://beej.us/guide/bgnet/html/#cb17-8"></a>printf<span class="op">(</span><span class="st">"The IPv4 address is: </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> ip4<span class="op">);</span></span>
<span id="cb17-9"><a href="https://beej.us/guide/bgnet/html/#cb17-9"></a></span>
<span id="cb17-10"><a href="https://beej.us/guide/bgnet/html/#cb17-10"></a></span>
<span id="cb17-11"><a href="https://beej.us/guide/bgnet/html/#cb17-11"></a><span class="co">// IPv6:</span></span>
<span id="cb17-12"><a href="https://beej.us/guide/bgnet/html/#cb17-12"></a></span>
<span id="cb17-13"><a href="https://beej.us/guide/bgnet/html/#cb17-13"></a><span class="dt">char</span> ip6<span class="op">[</span>INET6_ADDRSTRLEN<span class="op">];</span> <span class="co">// space to hold the IPv6 string</span></span>
<span id="cb17-14"><a href="https://beej.us/guide/bgnet/html/#cb17-14"></a><span class="kw">struct</span> sockaddr_in6 sa6<span class="op">;</span>    <span class="co">// pretend this is loaded with something</span></span>
<span id="cb17-15"><a href="https://beej.us/guide/bgnet/html/#cb17-15"></a></span>
<span id="cb17-16"><a href="https://beej.us/guide/bgnet/html/#cb17-16"></a>inet_ntop<span class="op">(</span>AF_INET6<span class="op">,</span> <span class="op">&amp;(</span>sa6<span class="op">.</span>sin6_addr<span class="op">),</span> ip6<span class="op">,</span> INET6_ADDRSTRLEN<span class="op">);</span></span>
<span id="cb17-17"><a href="https://beej.us/guide/bgnet/html/#cb17-17"></a></span>
<span id="cb17-18"><a href="https://beej.us/guide/bgnet/html/#cb17-18"></a>printf<span class="op">(</span><span class="st">"The address is: </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> ip6<span class="op">);</span></span></code></pre></div>
<p>When you call it, you’ll pass the address type (IPv4 or IPv6), the address, a pointer to a string to hold the result, and the maximum length of that string. (Two macros conveniently hold the size of the string you’ll need to hold the largest IPv4 or IPv6 address: <code>INET_ADDRSTRLEN</code> and <code>INET6_ADDRSTRLEN</code>.)</p>
<p>(Another quick note to mention once again the old way of doing things: the historical function to do this conversion was called <code>inet_ntoa()</code>. It’s also obsolete and won’t work with IPv6.)</p>
<p>Lastly, these functions only work with numeric IP addresses—they won’t do any nameserver DNS lookup on a hostname, like “<code>www.example.com</code>”. You will use <code>getaddrinfo()</code> to do that, as you’ll see later on.</p>
<h3 data-number="3.4.1" id="private-or-disconnected-networks"><span class="header-section-number">3.4.1</span> Private (Or Disconnected) Networks</h3>
<p> Lots of places have a firewall that hides the network from the rest of the world for their own protection. And often times, the firewall translates “internal” IP addresses to “external” (that everyone else in the world knows) IP addresses using a process called <em>Network Address Translation</em>, or NAT.</p>
<p>Are you getting nervous yet? “Where’s he going with all this weird stuff?”</p>
<p>Well, relax and buy yourself a non-alcoholic (or alcoholic) drink, because as a beginner, you don’t even have to worry about NAT, since it’s done for you transparently. But I wanted to talk about the network behind the firewall in case you started getting confused by the network numbers you were seeing.</p>
<p>For instance, I have a firewall at home. I have two static IPv4 addresses allocated to me by the DSL company, and yet I have seven computers on the network. How is this possible? Two computers can’t share the same IP address, or else the data wouldn’t know which one to go to!</p>
<p>The answer is: they don’t share the same IP addresses. They are on a private network with 24 million IP addresses allocated to it. They are all just for me. Well, all for me as far as anyone else is concerned. Here’s what’s happening:</p>
<p>If I log into a remote computer, it tells me I’m logged in from 192.0.2.33 which is the public IP address my ISP has provided to me. But if I ask my local computer what its IP address is, it says 10.0.0.5. Who is translating the IP address from one to the other? That’s right, the firewall! It’s doing NAT!</p>
<p><code>10.x.x.x</code> is one of a few reserved networks that are only to be used either on fully disconnected networks, or on networks that are behind firewalls. The details of which private network numbers are available for you to use are outlined in <a href="https://tools.ietf.org/html/rfc1918">RFC 1918</a><a href="https://beej.us/guide/bgnet/html/#fn19" class="footnote-ref" id="fnref19" role="doc-noteref"><sup>19</sup></a>, but some common ones you’ll see are <code>10.x.x.x</code> and <code>192.168.x.x</code>, where <code>x</code> is 0-255, generally. Less common is <code>172.y.x.x</code>, where <code>y</code> goes between 16 and 31.</p>
<p>Networks behind a NATing firewall don’t <em>need</em> to be on one of these reserved networks, but they commonly are.</p>
<p>(Fun fact! My external IP address isn’t really <code>192.0.2.33</code>. The <code>192.0.2.x</code> network is reserved for make-believe “real” IP addresses to be used in documentation, just like this guide! Wowzers!)</p>
<p> IPv6 has private networks, too, in a sense. They’ll start with <code>fdXX:</code> (or maybe in the future <code>fcXX:</code>), as per <a href="https://tools.ietf.org/html/rfc4193">RFC 4193</a><a href="https://beej.us/guide/bgnet/html/#fn20" class="footnote-ref" id="fnref20" role="doc-noteref"><sup>20</sup></a>. NAT and IPv6 don’t generally mix, however (unless you’re doing the IPv6 to IPv4 gateway thing which is beyond the scope of this document)—in theory you’ll have so many addresses at your disposal that you won’t need to use NAT any longer. But if you want to allocate addresses for yourself on a network that won’t route outside, this is how to do it.</p>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="4" id="jumping-from-ipv4-to-ipv6"><span class="header-section-number">4</span> Jumping from IPv4 to IPv6</h1>
<p></p>
<p>But I just want to know what to change in my code to get it going with IPv6! Tell me now!</p>
<p>Ok! Ok!</p>
<p>Almost everything in here is something I’ve gone over, above, but it’s the short version for the impatient. (Of course, there is more than this, but this is what applies to the guide.)</p>
<ol type="1">
<li><p>First of all, try to use <a href="https://beej.us/guide/bgnet/html/#structs"><code>getaddrinfo()</code></a> to get all the <code>struct sockaddr</code> info, instead of packing the structures by hand. This will keep you IP version-agnostic, and will eliminate many of the subsequent steps.</p></li>
<li><p>Any place that you find you’re hard-coding anything related to the IP version, try to wrap up in a helper function.</p></li>
<li><p>Change <code>AF_INET</code> to <code>AF_INET6</code>.</p></li>
<li><p>Change <code>PF_INET</code> to <code>PF_INET6</code>.</p></li>
<li><p>Change <code>INADDR_ANY</code> assignments to <code>in6addr_any</code> assignments, which are slightly different:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb18-1"><a href="https://beej.us/guide/bgnet/html/#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> sockaddr_in sa<span class="op">;</span></span>
<span id="cb18-2"><a href="https://beej.us/guide/bgnet/html/#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> sockaddr_in6 sa6<span class="op">;</span></span>
<span id="cb18-3"><a href="https://beej.us/guide/bgnet/html/#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="https://beej.us/guide/bgnet/html/#cb18-4" aria-hidden="true" tabindex="-1"></a>sa<span class="op">.</span>sin_addr<span class="op">.</span>s_addr <span class="op">=</span> INADDR_ANY<span class="op">;</span>  <span class="co">// use my IPv4 address</span></span>
<span id="cb18-5"><a href="https://beej.us/guide/bgnet/html/#cb18-5" aria-hidden="true" tabindex="-1"></a>sa6<span class="op">.</span>sin6_addr <span class="op">=</span> in6addr_any<span class="op">;</span> <span class="co">// use my IPv6 address</span></span></code></pre></div>
<p>Also, the value <code>IN6ADDR_ANY_INIT</code> can be used as an initializer when the <code>struct in6_addr</code> is declared, like so:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb19-1"><a href="https://beej.us/guide/bgnet/html/#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> in6_addr ia6 <span class="op">=</span> IN6ADDR_ANY_INIT<span class="op">;</span></span></code></pre></div></li>
<li><p>Instead of <code>struct sockaddr_in</code> use <code>struct sockaddr_in6</code>, being sure to add “6” to the fields as appropriate (see <a href="https://beej.us/guide/bgnet/html/#structs"><code>struct</code>s</a>, above). There is no <code>sin6_zero</code> field.</p></li>
<li><p>Instead of <code>struct in_addr</code> use <code>struct in6_addr</code>, being sure to add “6” to the fields as appropriate (see <a href="https://beej.us/guide/bgnet/html/#structs"><code>struct</code>s</a>, above).</p></li>
<li><p>Instead of <code>inet_aton()</code> or <code>inet_addr()</code>, use <code>inet_pton()</code>.</p></li>
<li><p>Instead of <code>inet_ntoa()</code>, use <code>inet_ntop()</code>.</p></li>
<li><p>Instead of <code>gethostbyname()</code>, use the superior <code>getaddrinfo()</code>.</p></li>
<li><p>Instead of <code>gethostbyaddr()</code>, use the superior <code>getnameinfo()</code> (although <code>gethostbyaddr()</code> can still work with IPv6).</p></li>
<li><p><code>INADDR_BROADCAST</code> no longer works. Use IPv6 multicast instead.</p></li>
</ol>
<p><em>Et voila</em>!</p>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="5" id="system-calls-or-bust"><span class="header-section-number">5</span> System Calls or Bust</h1>
<p>This is the section where we get into the system calls (and other library calls) that allow you to access the network functionality of a Unix box, or any box that supports the sockets API for that matter (BSD, Windows, Linux, Mac, what-have-you.) When you call one of these functions, the kernel takes over and does all the work for you automagically.</p>
<p>The place most people get stuck around here is what order to call these things in. In that, the <code>man</code> pages are no use, as you’ve probably discovered. Well, to help with that dreadful situation, I’ve tried to lay out the system calls in the following sections in <em>exactly</em> (approximately) the same order that you’ll need to call them in your programs.</p>
<p>That, coupled with a few pieces of sample code here and there, some milk and cookies (which I fear you will have to supply yourself), and some raw guts and courage, and you’ll be beaming data around the Internet like the Son of Jon Postel!</p>
<p><em>(Please note that for brevity, many code snippets below do not include necessary error checking. And they very commonly assume that the result from calls to <code>getaddrinfo()</code> succeed and return a valid entry in the linked list. Both of these situations are properly addressed in the stand-alone programs, though, so use those as a model.)</em></p>
<h2 data-number="5.1" id="getaddrinfoprepare-to-launch"><span class="header-section-number">5.1</span> <code>getaddrinfo()</code>—Prepare to launch!</h2>
<p> This is a real workhorse of a function with a lot of options, but usage is actually pretty simple. It helps set up the <code>struct</code>s you need later on.</p>
<p>A tiny bit of history: it used to be that you would use a function called <code>gethostbyname()</code> to do DNS lookups. Then you’d load that information by hand into a <code>struct sockaddr_in</code>, and use that in your calls.</p>
<p>This is no longer necessary, thankfully. (Nor is it desirable, if you want to write code that works for both IPv4 and IPv6!) In these modern times, you now have the function <code>getaddrinfo()</code> that does all kinds of good stuff for you, including DNS and service name lookups, and fills out the <code>struct</code>s you need, besides!</p>
<p>Let’s take a look!</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb20-1"><a href="https://beej.us/guide/bgnet/html/#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb20-2"><a href="https://beej.us/guide/bgnet/html/#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/socket.h&gt;</span></span>
<span id="cb20-3"><a href="https://beej.us/guide/bgnet/html/#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;netdb.h&gt;</span></span>
<span id="cb20-4"><a href="https://beej.us/guide/bgnet/html/#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="https://beej.us/guide/bgnet/html/#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> getaddrinfo<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>node<span class="op">,</span>     <span class="co">// e.g. "www.example.com" or IP</span></span>
<span id="cb20-6"><a href="https://beej.us/guide/bgnet/html/#cb20-6" aria-hidden="true" tabindex="-1"></a>                <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>service<span class="op">,</span>  <span class="co">// e.g. "http" or port number</span></span>
<span id="cb20-7"><a href="https://beej.us/guide/bgnet/html/#cb20-7" aria-hidden="true" tabindex="-1"></a>                <span class="dt">const</span> <span class="kw">struct</span> addrinfo <span class="op">*</span>hints<span class="op">,</span></span>
<span id="cb20-8"><a href="https://beej.us/guide/bgnet/html/#cb20-8" aria-hidden="true" tabindex="-1"></a>                <span class="kw">struct</span> addrinfo <span class="op">**</span>res<span class="op">);</span></span></code></pre></div>
<p>You give this function three input parameters, and it gives you a pointer to a linked-list, <code>res</code>, of results.</p>
<p>The <code>node</code> parameter is the host name to connect to, or an IP address.</p>
<p>Next is the parameter <code>service</code>, which can be a port number, like “80”, or the name of a particular service (found in <a href="https://www.iana.org/assignments/port-numbers">The IANA Port List</a><a href="https://beej.us/guide/bgnet/html/#fn21" class="footnote-ref" id="fnref21" role="doc-noteref"><sup>21</sup></a> or the <code>/etc/services</code> file on your Unix machine) like “http” or “ftp” or “telnet” or “smtp” or whatever.</p>
<p>Finally, the <code>hints</code> parameter points to a <code>struct addrinfo</code> that you’ve already filled out with relevant information.</p>
<p>Here’s a sample call if you’re a server who wants to listen on your host’s IP address, port 3490. Note that this doesn’t actually do any listening or network setup; it merely sets up structures we’ll use later:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb21-1"><a href="https://beej.us/guide/bgnet/html/#cb21-1"></a><span class="dt">int</span> status<span class="op">;</span></span>
<span id="cb21-2"><a href="https://beej.us/guide/bgnet/html/#cb21-2"></a><span class="kw">struct</span> addrinfo hints<span class="op">;</span></span>
<span id="cb21-3"><a href="https://beej.us/guide/bgnet/html/#cb21-3"></a><span class="kw">struct</span> addrinfo <span class="op">*</span>servinfo<span class="op">;</span>  <span class="co">// will point to the results</span></span>
<span id="cb21-4"><a href="https://beej.us/guide/bgnet/html/#cb21-4"></a></span>
<span id="cb21-5"><a href="https://beej.us/guide/bgnet/html/#cb21-5"></a>memset<span class="op">(&amp;</span>hints<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">sizeof</span> hints<span class="op">);</span> <span class="co">// make sure the struct is empty</span></span>
<span id="cb21-6"><a href="https://beej.us/guide/bgnet/html/#cb21-6"></a>hints<span class="op">.</span>ai_family <span class="op">=</span> AF_UNSPEC<span class="op">;</span>     <span class="co">// don't care IPv4 or IPv6</span></span>
<span id="cb21-7"><a href="https://beej.us/guide/bgnet/html/#cb21-7"></a>hints<span class="op">.</span>ai_socktype <span class="op">=</span> SOCK_STREAM<span class="op">;</span> <span class="co">// TCP stream sockets</span></span>
<span id="cb21-8"><a href="https://beej.us/guide/bgnet/html/#cb21-8"></a>hints<span class="op">.</span>ai_flags <span class="op">=</span> AI_PASSIVE<span class="op">;</span>     <span class="co">// fill in my IP for me</span></span>
<span id="cb21-9"><a href="https://beej.us/guide/bgnet/html/#cb21-9"></a></span>
<span id="cb21-10"><a href="https://beej.us/guide/bgnet/html/#cb21-10"></a><span class="cf">if</span> <span class="op">((</span>status <span class="op">=</span> getaddrinfo<span class="op">(</span>NULL<span class="op">,</span> <span class="st">"3490"</span><span class="op">,</span> <span class="op">&amp;</span>hints<span class="op">,</span> <span class="op">&amp;</span>servinfo<span class="op">))</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-11"><a href="https://beej.us/guide/bgnet/html/#cb21-11"></a>    fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">"getaddrinfo error: </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> gai_strerror<span class="op">(</span>status<span class="op">));</span></span>
<span id="cb21-12"><a href="https://beej.us/guide/bgnet/html/#cb21-12"></a>    exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb21-13"><a href="https://beej.us/guide/bgnet/html/#cb21-13"></a><span class="op">}</span></span>
<span id="cb21-14"><a href="https://beej.us/guide/bgnet/html/#cb21-14"></a></span>
<span id="cb21-15"><a href="https://beej.us/guide/bgnet/html/#cb21-15"></a><span class="co">// servinfo now points to a linked list of 1 or more struct addrinfos</span></span>
<span id="cb21-16"><a href="https://beej.us/guide/bgnet/html/#cb21-16"></a></span>
<span id="cb21-17"><a href="https://beej.us/guide/bgnet/html/#cb21-17"></a><span class="co">// ... do everything until you don't need servinfo anymore ....</span></span>
<span id="cb21-18"><a href="https://beej.us/guide/bgnet/html/#cb21-18"></a></span>
<span id="cb21-19"><a href="https://beej.us/guide/bgnet/html/#cb21-19"></a>freeaddrinfo<span class="op">(</span>servinfo<span class="op">);</span> <span class="co">// free the linked-list</span></span></code></pre></div>
<p>Notice that I set the <code>ai_family</code> to <code>AF_UNSPEC</code>, thereby saying that I don’t care if we use IPv4 or IPv6. You can set it to <code>AF_INET</code> or <code>AF_INET6</code> if you want one or the other specifically.</p>
<p>Also, you’ll see the <code>AI_PASSIVE</code> flag in there; this tells <code>getaddrinfo()</code> to assign the address of my local host to the socket structures. This is nice because then you don’t have to hardcode it. (Or you can put a specific address in as the first parameter to <code>getaddrinfo()</code> where I currently have <code>NULL</code>, up there.)</p>
<p>Then we make the call. If there’s an error (<code>getaddrinfo()</code> returns non-zero), we can print it out using the function <code>gai_strerror()</code>, as you see. If everything works properly, though, <code>servinfo</code> will point to a linked list of <code>struct addrinfo</code>s, each of which contains a <code>struct sockaddr</code> of some kind that we can use later! Nifty!</p>
<p>Finally, when we’re eventually all done with the linked list that <code>getaddrinfo()</code> so graciously allocated for us, we can (and should) free it all up with a call to <code>freeaddrinfo()</code>.</p>
<p>Here’s a sample call if you’re a client who wants to connect to a particular server, say “www.example.net” port 3490. Again, this doesn’t actually connect, but it sets up the structures we’ll use later:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb22-1"><a href="https://beej.us/guide/bgnet/html/#cb22-1"></a><span class="dt">int</span> status<span class="op">;</span></span>
<span id="cb22-2"><a href="https://beej.us/guide/bgnet/html/#cb22-2"></a><span class="kw">struct</span> addrinfo hints<span class="op">;</span></span>
<span id="cb22-3"><a href="https://beej.us/guide/bgnet/html/#cb22-3"></a><span class="kw">struct</span> addrinfo <span class="op">*</span>servinfo<span class="op">;</span>  <span class="co">// will point to the results</span></span>
<span id="cb22-4"><a href="https://beej.us/guide/bgnet/html/#cb22-4"></a></span>
<span id="cb22-5"><a href="https://beej.us/guide/bgnet/html/#cb22-5"></a>memset<span class="op">(&amp;</span>hints<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">sizeof</span> hints<span class="op">);</span> <span class="co">// make sure the struct is empty</span></span>
<span id="cb22-6"><a href="https://beej.us/guide/bgnet/html/#cb22-6"></a>hints<span class="op">.</span>ai_family <span class="op">=</span> AF_UNSPEC<span class="op">;</span>     <span class="co">// don't care IPv4 or IPv6</span></span>
<span id="cb22-7"><a href="https://beej.us/guide/bgnet/html/#cb22-7"></a>hints<span class="op">.</span>ai_socktype <span class="op">=</span> SOCK_STREAM<span class="op">;</span> <span class="co">// TCP stream sockets</span></span>
<span id="cb22-8"><a href="https://beej.us/guide/bgnet/html/#cb22-8"></a></span>
<span id="cb22-9"><a href="https://beej.us/guide/bgnet/html/#cb22-9"></a><span class="co">// get ready to connect</span></span>
<span id="cb22-10"><a href="https://beej.us/guide/bgnet/html/#cb22-10"></a>status <span class="op">=</span> getaddrinfo<span class="op">(</span><span class="st">"www.example.net"</span><span class="op">,</span> <span class="st">"3490"</span><span class="op">,</span> <span class="op">&amp;</span>hints<span class="op">,</span> <span class="op">&amp;</span>servinfo<span class="op">);</span></span>
<span id="cb22-11"><a href="https://beej.us/guide/bgnet/html/#cb22-11"></a></span>
<span id="cb22-12"><a href="https://beej.us/guide/bgnet/html/#cb22-12"></a><span class="co">// servinfo now points to a linked list of 1 or more struct addrinfos</span></span>
<span id="cb22-13"><a href="https://beej.us/guide/bgnet/html/#cb22-13"></a></span>
<span id="cb22-14"><a href="https://beej.us/guide/bgnet/html/#cb22-14"></a><span class="co">// etc.</span></span></code></pre></div>
<p>I keep saying that <code>servinfo</code> is a linked list with all kinds of address information. Let’s write a quick demo program to show off this information. <a href="https://beej.us/guide/bgnet/source/examples/showip.c">This short program</a><a href="https://beej.us/guide/bgnet/html/#fn22" class="footnote-ref" id="fnref22" role="doc-noteref"><sup>22</sup></a> will print the IP addresses for whatever host you specify on the command line:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb23-1"><a href="https://beej.us/guide/bgnet/html/#cb23-1"></a><span class="co">/*</span></span>
<span id="cb23-2"><a href="https://beej.us/guide/bgnet/html/#cb23-2"></a><span class="co">** showip.c -- show IP addresses for a host given on the command line</span></span>
<span id="cb23-3"><a href="https://beej.us/guide/bgnet/html/#cb23-3"></a><span class="co">*/</span></span>
<span id="cb23-4"><a href="https://beej.us/guide/bgnet/html/#cb23-4"></a></span>
<span id="cb23-5"><a href="https://beej.us/guide/bgnet/html/#cb23-5"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb23-6"><a href="https://beej.us/guide/bgnet/html/#cb23-6"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb23-7"><a href="https://beej.us/guide/bgnet/html/#cb23-7"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb23-8"><a href="https://beej.us/guide/bgnet/html/#cb23-8"></a><span class="pp">#include </span><span class="im">&lt;sys/socket.h&gt;</span></span>
<span id="cb23-9"><a href="https://beej.us/guide/bgnet/html/#cb23-9"></a><span class="pp">#include </span><span class="im">&lt;netdb.h&gt;</span></span>
<span id="cb23-10"><a href="https://beej.us/guide/bgnet/html/#cb23-10"></a><span class="pp">#include </span><span class="im">&lt;arpa/inet.h&gt;</span></span>
<span id="cb23-11"><a href="https://beej.us/guide/bgnet/html/#cb23-11"></a><span class="pp">#include </span><span class="im">&lt;netinet/in.h&gt;</span></span>
<span id="cb23-12"><a href="https://beej.us/guide/bgnet/html/#cb23-12"></a></span>
<span id="cb23-13"><a href="https://beej.us/guide/bgnet/html/#cb23-13"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>argv<span class="op">[])</span></span>
<span id="cb23-14"><a href="https://beej.us/guide/bgnet/html/#cb23-14"></a><span class="op">{</span></span>
<span id="cb23-15"><a href="https://beej.us/guide/bgnet/html/#cb23-15"></a>    <span class="kw">struct</span> addrinfo hints<span class="op">,</span> <span class="op">*</span>res<span class="op">,</span> <span class="op">*</span>p<span class="op">;</span></span>
<span id="cb23-16"><a href="https://beej.us/guide/bgnet/html/#cb23-16"></a>    <span class="dt">int</span> status<span class="op">;</span></span>
<span id="cb23-17"><a href="https://beej.us/guide/bgnet/html/#cb23-17"></a>    <span class="dt">char</span> ipstr<span class="op">[</span>INET6_ADDRSTRLEN<span class="op">];</span></span>
<span id="cb23-18"><a href="https://beej.us/guide/bgnet/html/#cb23-18"></a></span>
<span id="cb23-19"><a href="https://beej.us/guide/bgnet/html/#cb23-19"></a>    <span class="cf">if</span> <span class="op">(</span>argc <span class="op">!=</span> <span class="dv">2</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-20"><a href="https://beej.us/guide/bgnet/html/#cb23-20"></a>        fprintf<span class="op">(</span>stderr<span class="op">,</span><span class="st">"usage: showip hostname</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb23-21"><a href="https://beej.us/guide/bgnet/html/#cb23-21"></a>        <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb23-22"><a href="https://beej.us/guide/bgnet/html/#cb23-22"></a>    <span class="op">}</span></span>
<span id="cb23-23"><a href="https://beej.us/guide/bgnet/html/#cb23-23"></a></span>
<span id="cb23-24"><a href="https://beej.us/guide/bgnet/html/#cb23-24"></a>    memset<span class="op">(&amp;</span>hints<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">sizeof</span> hints<span class="op">);</span></span>
<span id="cb23-25"><a href="https://beej.us/guide/bgnet/html/#cb23-25"></a>    hints<span class="op">.</span>ai_family <span class="op">=</span> AF_UNSPEC<span class="op">;</span> <span class="co">// AF_INET or AF_INET6 to force version</span></span>
<span id="cb23-26"><a href="https://beej.us/guide/bgnet/html/#cb23-26"></a>    hints<span class="op">.</span>ai_socktype <span class="op">=</span> SOCK_STREAM<span class="op">;</span></span>
<span id="cb23-27"><a href="https://beej.us/guide/bgnet/html/#cb23-27"></a></span>
<span id="cb23-28"><a href="https://beej.us/guide/bgnet/html/#cb23-28"></a>    <span class="cf">if</span> <span class="op">((</span>status <span class="op">=</span> getaddrinfo<span class="op">(</span>argv<span class="op">[</span><span class="dv">1</span><span class="op">],</span> NULL<span class="op">,</span> <span class="op">&amp;</span>hints<span class="op">,</span> <span class="op">&amp;</span>res<span class="op">))</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-29"><a href="https://beej.us/guide/bgnet/html/#cb23-29"></a>        fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">"getaddrinfo: </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> gai_strerror<span class="op">(</span>status<span class="op">));</span></span>
<span id="cb23-30"><a href="https://beej.us/guide/bgnet/html/#cb23-30"></a>        <span class="cf">return</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb23-31"><a href="https://beej.us/guide/bgnet/html/#cb23-31"></a>    <span class="op">}</span></span>
<span id="cb23-32"><a href="https://beej.us/guide/bgnet/html/#cb23-32"></a></span>
<span id="cb23-33"><a href="https://beej.us/guide/bgnet/html/#cb23-33"></a>    printf<span class="op">(</span><span class="st">"IP addresses for </span><span class="sc">%s</span><span class="st">:</span><span class="sc">\n\n</span><span class="st">"</span><span class="op">,</span> argv<span class="op">[</span><span class="dv">1</span><span class="op">]);</span></span>
<span id="cb23-34"><a href="https://beej.us/guide/bgnet/html/#cb23-34"></a></span>
<span id="cb23-35"><a href="https://beej.us/guide/bgnet/html/#cb23-35"></a>    <span class="cf">for</span><span class="op">(</span>p <span class="op">=</span> res<span class="op">;</span>p <span class="op">!=</span> NULL<span class="op">;</span> p <span class="op">=</span> p<span class="op">-&gt;</span>ai_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-36"><a href="https://beej.us/guide/bgnet/html/#cb23-36"></a>        <span class="dt">void</span> <span class="op">*</span>addr<span class="op">;</span></span>
<span id="cb23-37"><a href="https://beej.us/guide/bgnet/html/#cb23-37"></a>        <span class="dt">char</span> <span class="op">*</span>ipver<span class="op">;</span></span>
<span id="cb23-38"><a href="https://beej.us/guide/bgnet/html/#cb23-38"></a></span>
<span id="cb23-39"><a href="https://beej.us/guide/bgnet/html/#cb23-39"></a>        <span class="co">// get the pointer to the address itself,</span></span>
<span id="cb23-40"><a href="https://beej.us/guide/bgnet/html/#cb23-40"></a>        <span class="co">// different fields in IPv4 and IPv6:</span></span>
<span id="cb23-41"><a href="https://beej.us/guide/bgnet/html/#cb23-41"></a>        <span class="cf">if</span> <span class="op">(</span>p<span class="op">-&gt;</span>ai_family <span class="op">==</span> AF_INET<span class="op">)</span> <span class="op">{</span> <span class="co">// IPv4</span></span>
<span id="cb23-42"><a href="https://beej.us/guide/bgnet/html/#cb23-42"></a>            <span class="kw">struct</span> sockaddr_in <span class="op">*</span>ipv4 <span class="op">=</span> <span class="op">(</span><span class="kw">struct</span> sockaddr_in <span class="op">*)</span>p<span class="op">-&gt;</span>ai_addr<span class="op">;</span></span>
<span id="cb23-43"><a href="https://beej.us/guide/bgnet/html/#cb23-43"></a>            addr <span class="op">=</span> <span class="op">&amp;(</span>ipv4<span class="op">-&gt;</span>sin_addr<span class="op">);</span></span>
<span id="cb23-44"><a href="https://beej.us/guide/bgnet/html/#cb23-44"></a>            ipver <span class="op">=</span> <span class="st">"IPv4"</span><span class="op">;</span></span>
<span id="cb23-45"><a href="https://beej.us/guide/bgnet/html/#cb23-45"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span> <span class="co">// IPv6</span></span>
<span id="cb23-46"><a href="https://beej.us/guide/bgnet/html/#cb23-46"></a>            <span class="kw">struct</span> sockaddr_in6 <span class="op">*</span>ipv6 <span class="op">=</span> <span class="op">(</span><span class="kw">struct</span> sockaddr_in6 <span class="op">*)</span>p<span class="op">-&gt;</span>ai_addr<span class="op">;</span></span>
<span id="cb23-47"><a href="https://beej.us/guide/bgnet/html/#cb23-47"></a>            addr <span class="op">=</span> <span class="op">&amp;(</span>ipv6<span class="op">-&gt;</span>sin6_addr<span class="op">);</span></span>
<span id="cb23-48"><a href="https://beej.us/guide/bgnet/html/#cb23-48"></a>            ipver <span class="op">=</span> <span class="st">"IPv6"</span><span class="op">;</span></span>
<span id="cb23-49"><a href="https://beej.us/guide/bgnet/html/#cb23-49"></a>        <span class="op">}</span></span>
<span id="cb23-50"><a href="https://beej.us/guide/bgnet/html/#cb23-50"></a></span>
<span id="cb23-51"><a href="https://beej.us/guide/bgnet/html/#cb23-51"></a>        <span class="co">// convert the IP to a string and print it:</span></span>
<span id="cb23-52"><a href="https://beej.us/guide/bgnet/html/#cb23-52"></a>        inet_ntop<span class="op">(</span>p<span class="op">-&gt;</span>ai_family<span class="op">,</span> addr<span class="op">,</span> ipstr<span class="op">,</span> <span class="kw">sizeof</span> ipstr<span class="op">);</span></span>
<span id="cb23-53"><a href="https://beej.us/guide/bgnet/html/#cb23-53"></a>        printf<span class="op">(</span><span class="st">"  </span><span class="sc">%s</span><span class="st">: </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> ipver<span class="op">,</span> ipstr<span class="op">);</span></span>
<span id="cb23-54"><a href="https://beej.us/guide/bgnet/html/#cb23-54"></a>    <span class="op">}</span></span>
<span id="cb23-55"><a href="https://beej.us/guide/bgnet/html/#cb23-55"></a></span>
<span id="cb23-56"><a href="https://beej.us/guide/bgnet/html/#cb23-56"></a>    freeaddrinfo<span class="op">(</span>res<span class="op">);</span> <span class="co">// free the linked list</span></span>
<span id="cb23-57"><a href="https://beej.us/guide/bgnet/html/#cb23-57"></a></span>
<span id="cb23-58"><a href="https://beej.us/guide/bgnet/html/#cb23-58"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb23-59"><a href="https://beej.us/guide/bgnet/html/#cb23-59"></a><span class="op">}</span></span></code></pre></div>
<p>As you see, the code calls <code>getaddrinfo()</code> on whatever you pass on the command line, that fills out the linked list pointed to by <code>res</code>, and then we can iterate over the list and print stuff out or do whatever.</p>
<p>(There’s a little bit of ugliness there where we have to dig into the different types of <code>struct sockaddr</code>s depending on the IP version. Sorry about that! I’m not sure of a better way around it.)</p>
<p>Sample run! Everyone loves screenshots:</p>
<pre><code>$ showip www.example.net
IP addresses for www.example.net:

  IPv4: 192.0.2.88

$ showip ipv6.example.com
IP addresses for ipv6.example.com:

  IPv4: 192.0.2.101
  IPv6: 2001:db8:8c00:22::171</code></pre>
<p>Now that we have that under control, we’ll use the results we get from <code>getaddrinfo()</code> to pass to other socket functions and, at long last, get our network connection established! Keep reading!</p>
<h2 data-number="5.2" id="socket"><span class="header-section-number">5.2</span> <code>socket()</code>—Get the File Descriptor!</h2>
<p>I guess I can put it off no longer—I have to talk about the <code>socket()</code> system call. Here’s the breakdown:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb25-1"><a href="https://beej.us/guide/bgnet/html/#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb25-2"><a href="https://beej.us/guide/bgnet/html/#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/socket.h&gt;</span></span>
<span id="cb25-3"><a href="https://beej.us/guide/bgnet/html/#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="https://beej.us/guide/bgnet/html/#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> socket<span class="op">(</span><span class="dt">int</span> domain<span class="op">,</span> <span class="dt">int</span> type<span class="op">,</span> <span class="dt">int</span> protocol<span class="op">);</span> </span></code></pre></div>
<p>But what are these arguments? They allow you to say what kind of socket you want (IPv4 or IPv6, stream or datagram, and TCP or UDP).</p>
<p>It used to be people would hardcode these values, and you can absolutely still do that. (<code>domain</code> is <code>PF_INET</code> or <code>PF_INET6</code>, <code>type</code> is <code>SOCK_STREAM</code> or <code>SOCK_DGRAM</code>, and <code>protocol</code> can be set to <code>0</code> to choose the proper protocol for the given <code>type</code>. Or you can call <code>getprotobyname()</code> to look up the protocol you want, “tcp” or “udp”.)</p>
<p>(This <code>PF_INET</code> thing is a close relative of the <code>AF_INET</code> that you can use when initializing the <code>sin_family</code> field in your <code>struct sockaddr_in</code>. In fact, they’re so closely related that they actually have the same value, and many programmers will call <code>socket()</code> and pass <code>AF_INET</code> as the first argument instead of <code>PF_INET</code>. Now, get some milk and cookies, because it’s time for a story. Once upon a time, a long time ago, it was thought that maybe an address family (what the “AF” in “<code>AF_INET</code>” stands for) might support several protocols that were referred to by their protocol family (what the “PF” in “<code>PF_INET</code>” stands for). That didn’t happen. And they all lived happily ever after, The End. So the most correct thing to do is to use <code>AF_INET</code> in your <code>struct sockaddr_in</code> and <code>PF_INET</code> in your call to <code>socket()</code>.)</p>
<p>Anyway, enough of that. What you really want to do is use the values from the results of the call to <code>getaddrinfo()</code>, and feed them into <code>socket()</code> directly like this:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb26-1"><a href="https://beej.us/guide/bgnet/html/#cb26-1"></a><span class="dt">int</span> s<span class="op">;</span></span>
<span id="cb26-2"><a href="https://beej.us/guide/bgnet/html/#cb26-2"></a><span class="kw">struct</span> addrinfo hints<span class="op">,</span> <span class="op">*</span>res<span class="op">;</span></span>
<span id="cb26-3"><a href="https://beej.us/guide/bgnet/html/#cb26-3"></a></span>
<span id="cb26-4"><a href="https://beej.us/guide/bgnet/html/#cb26-4"></a><span class="co">// do the lookup</span></span>
<span id="cb26-5"><a href="https://beej.us/guide/bgnet/html/#cb26-5"></a><span class="co">// [pretend we already filled out the "hints" struct]</span></span>
<span id="cb26-6"><a href="https://beej.us/guide/bgnet/html/#cb26-6"></a>getaddrinfo<span class="op">(</span><span class="st">"www.example.com"</span><span class="op">,</span> <span class="st">"http"</span><span class="op">,</span> <span class="op">&amp;</span>hints<span class="op">,</span> <span class="op">&amp;</span>res<span class="op">);</span></span>
<span id="cb26-7"><a href="https://beej.us/guide/bgnet/html/#cb26-7"></a></span>
<span id="cb26-8"><a href="https://beej.us/guide/bgnet/html/#cb26-8"></a><span class="co">// again, you should do error-checking on getaddrinfo(), and walk</span></span>
<span id="cb26-9"><a href="https://beej.us/guide/bgnet/html/#cb26-9"></a><span class="co">// the "res" linked list looking for valid entries instead of just</span></span>
<span id="cb26-10"><a href="https://beej.us/guide/bgnet/html/#cb26-10"></a><span class="co">// assuming the first one is good (like many of these examples do).</span></span>
<span id="cb26-11"><a href="https://beej.us/guide/bgnet/html/#cb26-11"></a><span class="co">// See the section on client/server for real examples.</span></span>
<span id="cb26-12"><a href="https://beej.us/guide/bgnet/html/#cb26-12"></a></span>
<span id="cb26-13"><a href="https://beej.us/guide/bgnet/html/#cb26-13"></a>s <span class="op">=</span> socket<span class="op">(</span>res<span class="op">-&gt;</span>ai_family<span class="op">,</span> res<span class="op">-&gt;</span>ai_socktype<span class="op">,</span> res<span class="op">-&gt;</span>ai_protocol<span class="op">);</span></span></code></pre></div>
<p><code>socket()</code> simply returns to you a <em>socket descriptor</em> that you can use in later system calls, or <code>-1</code> on error. The global variable <code>errno</code> is set to the error’s value (see the <a href="https://beej.us/guide/bgnet/html/#errnoman"><code>errno</code></a> man page for more details, and a quick note on using <code>errno</code> in multithreaded programs).</p>
<p>Fine, fine, fine, but what good is this socket? The answer is that it’s really no good by itself, and you need to read on and make more system calls for it to make any sense.</p>
<h2 data-number="5.3" id="bind"><span class="header-section-number">5.3</span> <code>bind()</code>—What port am I on?</h2>
<p> Once you have a socket, you might have to associate that socket with a port on your local machine. (This is commonly done if you’re going to <code>listen()</code> for incoming connections on a specific port—multiplayer network games do this when they tell you to “connect to 192.168.5.10 port 3490”.) The port number is used by the kernel to match an incoming packet to a certain process’s socket descriptor. If you’re going to only be doing a <code>connect()</code> (because you’re the client, not the server), this is probably unnecessary. Read it anyway, just for kicks.</p>
<p>Here is the synopsis for the <code>bind()</code> system call:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb27-1"><a href="https://beej.us/guide/bgnet/html/#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb27-2"><a href="https://beej.us/guide/bgnet/html/#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/socket.h&gt;</span></span>
<span id="cb27-3"><a href="https://beej.us/guide/bgnet/html/#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="https://beej.us/guide/bgnet/html/#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> bind<span class="op">(</span><span class="dt">int</span> sockfd<span class="op">,</span> <span class="kw">struct</span> sockaddr <span class="op">*</span>my_addr<span class="op">,</span> <span class="dt">int</span> addrlen<span class="op">);</span></span></code></pre></div>
<p><code>sockfd</code> is the socket file descriptor returned by <code>socket()</code>. <code>my_addr</code> is a pointer to a <code>struct sockaddr</code> that contains information about your address, namely, port and IP address. <code>addrlen</code> is the length in bytes of that address.</p>
<p>Whew. That’s a bit to absorb in one chunk. Let’s have an example that binds the socket to the host the program is running on, port 3490:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb28-1"><a href="https://beej.us/guide/bgnet/html/#cb28-1"></a><span class="kw">struct</span> addrinfo hints<span class="op">,</span> <span class="op">*</span>res<span class="op">;</span></span>
<span id="cb28-2"><a href="https://beej.us/guide/bgnet/html/#cb28-2"></a><span class="dt">int</span> sockfd<span class="op">;</span></span>
<span id="cb28-3"><a href="https://beej.us/guide/bgnet/html/#cb28-3"></a></span>
<span id="cb28-4"><a href="https://beej.us/guide/bgnet/html/#cb28-4"></a><span class="co">// first, load up address structs with getaddrinfo():</span></span>
<span id="cb28-5"><a href="https://beej.us/guide/bgnet/html/#cb28-5"></a></span>
<span id="cb28-6"><a href="https://beej.us/guide/bgnet/html/#cb28-6"></a>memset<span class="op">(&amp;</span>hints<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">sizeof</span> hints<span class="op">);</span></span>
<span id="cb28-7"><a href="https://beej.us/guide/bgnet/html/#cb28-7"></a>hints<span class="op">.</span>ai_family <span class="op">=</span> AF_UNSPEC<span class="op">;</span>  <span class="co">// use IPv4 or IPv6, whichever</span></span>
<span id="cb28-8"><a href="https://beej.us/guide/bgnet/html/#cb28-8"></a>hints<span class="op">.</span>ai_socktype <span class="op">=</span> SOCK_STREAM<span class="op">;</span></span>
<span id="cb28-9"><a href="https://beej.us/guide/bgnet/html/#cb28-9"></a>hints<span class="op">.</span>ai_flags <span class="op">=</span> AI_PASSIVE<span class="op">;</span>     <span class="co">// fill in my IP for me</span></span>
<span id="cb28-10"><a href="https://beej.us/guide/bgnet/html/#cb28-10"></a></span>
<span id="cb28-11"><a href="https://beej.us/guide/bgnet/html/#cb28-11"></a>getaddrinfo<span class="op">(</span>NULL<span class="op">,</span> <span class="st">"3490"</span><span class="op">,</span> <span class="op">&amp;</span>hints<span class="op">,</span> <span class="op">&amp;</span>res<span class="op">);</span></span>
<span id="cb28-12"><a href="https://beej.us/guide/bgnet/html/#cb28-12"></a></span>
<span id="cb28-13"><a href="https://beej.us/guide/bgnet/html/#cb28-13"></a><span class="co">// make a socket:</span></span>
<span id="cb28-14"><a href="https://beej.us/guide/bgnet/html/#cb28-14"></a></span>
<span id="cb28-15"><a href="https://beej.us/guide/bgnet/html/#cb28-15"></a>sockfd <span class="op">=</span> socket<span class="op">(</span>res<span class="op">-&gt;</span>ai_family<span class="op">,</span> res<span class="op">-&gt;</span>ai_socktype<span class="op">,</span> res<span class="op">-&gt;</span>ai_protocol<span class="op">);</span></span>
<span id="cb28-16"><a href="https://beej.us/guide/bgnet/html/#cb28-16"></a></span>
<span id="cb28-17"><a href="https://beej.us/guide/bgnet/html/#cb28-17"></a><span class="co">// bind it to the port we passed in to getaddrinfo():</span></span>
<span id="cb28-18"><a href="https://beej.us/guide/bgnet/html/#cb28-18"></a></span>
<span id="cb28-19"><a href="https://beej.us/guide/bgnet/html/#cb28-19"></a>bind<span class="op">(</span>sockfd<span class="op">,</span> res<span class="op">-&gt;</span>ai_addr<span class="op">,</span> res<span class="op">-&gt;</span>ai_addrlen<span class="op">);</span></span></code></pre></div>
<p>By using the <code>AI_PASSIVE</code> flag, I’m telling the program to bind to the IP of the host it’s running on. If you want to bind to a specific local IP address, drop the <code>AI_PASSIVE</code> and put an IP address in for the first argument to <code>getaddrinfo()</code>.</p>
<p><code>bind()</code> also returns <code>-1</code> on error and sets <code>errno</code> to the error’s value.</p>
<p>Lots of old code manually packs the <code>struct sockaddr_in</code> before calling <code>bind()</code>. Obviously this is IPv4-specific, but there’s really nothing stopping you from doing the same thing with IPv6, except that using <code>getaddrinfo()</code> is going to be easier, generally. Anyway, the old code looks something like this:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb29-1"><a href="https://beej.us/guide/bgnet/html/#cb29-1"></a><span class="co">// !!! THIS IS THE OLD WAY !!!</span></span>
<span id="cb29-2"><a href="https://beej.us/guide/bgnet/html/#cb29-2"></a></span>
<span id="cb29-3"><a href="https://beej.us/guide/bgnet/html/#cb29-3"></a><span class="dt">int</span> sockfd<span class="op">;</span></span>
<span id="cb29-4"><a href="https://beej.us/guide/bgnet/html/#cb29-4"></a><span class="kw">struct</span> sockaddr_in my_addr<span class="op">;</span></span>
<span id="cb29-5"><a href="https://beej.us/guide/bgnet/html/#cb29-5"></a></span>
<span id="cb29-6"><a href="https://beej.us/guide/bgnet/html/#cb29-6"></a>sockfd <span class="op">=</span> socket<span class="op">(</span>PF_INET<span class="op">,</span> SOCK_STREAM<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb29-7"><a href="https://beej.us/guide/bgnet/html/#cb29-7"></a></span>
<span id="cb29-8"><a href="https://beej.us/guide/bgnet/html/#cb29-8"></a>my_addr<span class="op">.</span>sin_family <span class="op">=</span> AF_INET<span class="op">;</span></span>
<span id="cb29-9"><a href="https://beej.us/guide/bgnet/html/#cb29-9"></a>my_addr<span class="op">.</span>sin_port <span class="op">=</span> htons<span class="op">(</span>MYPORT<span class="op">);</span>     <span class="co">// short, network byte order</span></span>
<span id="cb29-10"><a href="https://beej.us/guide/bgnet/html/#cb29-10"></a>my_addr<span class="op">.</span>sin_addr<span class="op">.</span>s_addr <span class="op">=</span> inet_addr<span class="op">(</span><span class="st">"10.12.110.57"</span><span class="op">);</span></span>
<span id="cb29-11"><a href="https://beej.us/guide/bgnet/html/#cb29-11"></a>memset<span class="op">(</span>my_addr<span class="op">.</span>sin_zero<span class="op">,</span> <span class="ch">'</span><span class="sc">\0</span><span class="ch">'</span><span class="op">,</span> <span class="kw">sizeof</span> my_addr<span class="op">.</span>sin_zero<span class="op">);</span></span>
<span id="cb29-12"><a href="https://beej.us/guide/bgnet/html/#cb29-12"></a></span>
<span id="cb29-13"><a href="https://beej.us/guide/bgnet/html/#cb29-13"></a>bind<span class="op">(</span>sockfd<span class="op">,</span> <span class="op">(</span><span class="kw">struct</span> sockaddr <span class="op">*)&amp;</span>my_addr<span class="op">,</span> <span class="kw">sizeof</span> my_addr<span class="op">);</span></span></code></pre></div>
<p>In the above code, you could also assign <code>INADDR_ANY</code> to the <code>s_addr</code> field if you wanted to bind to your local IP address (like the <code>AI_PASSIVE</code> flag, above). The IPv6 version of <code>INADDR_ANY</code> is a global variable <code>in6addr_any</code> that is assigned into the <code>sin6_addr</code> field of your <code>struct sockaddr_in6</code>. (There is also a macro <code>IN6ADDR_ANY_INIT</code> that you can use in a variable initializer.)</p>
<p>Another thing to watch out for when calling <code>bind()</code>: don’t go underboard with your port numbers. All ports below 1024 are RESERVED (unless you’re the superuser)! You can have any port number above that, right up to 65535 (provided they aren’t already being used by another program).</p>
<p>Sometimes, you might notice, you try to rerun a server and <code>bind()</code> fails, claiming “Address already in use.” What does that mean? Well, a little bit of a socket that was connected is still hanging around in the kernel, and it’s hogging the port. You can either wait for it to clear (a minute or so), or add code to your program allowing it to reuse the port, like this:</p>
<p> </p>
<div class="sourceCode" id="cb30"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb30-1"><a href="https://beej.us/guide/bgnet/html/#cb30-1"></a><span class="dt">int</span> yes<span class="op">=</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb30-2"><a href="https://beej.us/guide/bgnet/html/#cb30-2"></a><span class="co">//char yes='1'; // Solaris people use this</span></span>
<span id="cb30-3"><a href="https://beej.us/guide/bgnet/html/#cb30-3"></a></span>
<span id="cb30-4"><a href="https://beej.us/guide/bgnet/html/#cb30-4"></a><span class="co">// lose the pesky "Address already in use" error message</span></span>
<span id="cb30-5"><a href="https://beej.us/guide/bgnet/html/#cb30-5"></a><span class="cf">if</span> <span class="op">(</span>setsockopt<span class="op">(</span>listener<span class="op">,</span>SOL_SOCKET<span class="op">,</span>SO_REUSEADDR<span class="op">,&amp;</span>yes<span class="op">,</span><span class="kw">sizeof</span> yes<span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb30-6"><a href="https://beej.us/guide/bgnet/html/#cb30-6"></a>    perror<span class="op">(</span><span class="st">"setsockopt"</span><span class="op">);</span></span>
<span id="cb30-7"><a href="https://beej.us/guide/bgnet/html/#cb30-7"></a>    exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb30-8"><a href="https://beej.us/guide/bgnet/html/#cb30-8"></a><span class="op">}</span> </span></code></pre></div>
<p> One small extra final note about <code>bind()</code>: there are times when you won’t absolutely have to call it. If you are <code>connect()</code>ing to a remote machine and you don’t care what your local port is (as is the case with <code>telnet</code> where you only care about the remote port), you can simply call <code>connect()</code>, it’ll check to see if the socket is unbound, and will <code>bind()</code> it to an unused local port if necessary.</p>
<h2 data-number="5.4" id="connect"><span class="header-section-number">5.4</span> <code>connect()</code>—Hey, you!</h2>
<p> Let’s just pretend for a few minutes that you’re a telnet application. Your user commands you (just like in the movie <em>TRON</em>) to get a socket file descriptor. You comply and call <code>socket()</code>. Next, the user tells you to connect to “<code>10.12.110.57</code>” on port “<code>23</code>” (the standard telnet port). Yow! What do you do now?</p>
<p>Lucky for you, program, you’re now perusing the section on <code>connect()</code>—how to connect to a remote host. So read furiously onward! No time to lose!</p>
<p>The <code>connect()</code> call is as follows:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb31-1"><a href="https://beej.us/guide/bgnet/html/#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb31-2"><a href="https://beej.us/guide/bgnet/html/#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/socket.h&gt;</span></span>
<span id="cb31-3"><a href="https://beej.us/guide/bgnet/html/#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="https://beej.us/guide/bgnet/html/#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> connect<span class="op">(</span><span class="dt">int</span> sockfd<span class="op">,</span> <span class="kw">struct</span> sockaddr <span class="op">*</span>serv_addr<span class="op">,</span> <span class="dt">int</span> addrlen<span class="op">);</span> </span></code></pre></div>
<p><code>sockfd</code> is our friendly neighborhood socket file descriptor, as returned by the <code>socket()</code> call, <code>serv_addr</code> is a <code>struct sockaddr</code> containing the destination port and IP address, and <code>addrlen</code> is the length in bytes of the server address structure.</p>
<p>All of this information can be gleaned from the results of the <code>getaddrinfo()</code> call, which rocks.</p>
<p>Is this starting to make more sense? I can’t hear you from here, so I’ll just have to hope that it is. Let’s have an example where we make a socket connection to “<code>www.example.com</code>”, port <code>3490</code>:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb32-1"><a href="https://beej.us/guide/bgnet/html/#cb32-1"></a><span class="kw">struct</span> addrinfo hints<span class="op">,</span> <span class="op">*</span>res<span class="op">;</span></span>
<span id="cb32-2"><a href="https://beej.us/guide/bgnet/html/#cb32-2"></a><span class="dt">int</span> sockfd<span class="op">;</span></span>
<span id="cb32-3"><a href="https://beej.us/guide/bgnet/html/#cb32-3"></a></span>
<span id="cb32-4"><a href="https://beej.us/guide/bgnet/html/#cb32-4"></a><span class="co">// first, load up address structs with getaddrinfo():</span></span>
<span id="cb32-5"><a href="https://beej.us/guide/bgnet/html/#cb32-5"></a></span>
<span id="cb32-6"><a href="https://beej.us/guide/bgnet/html/#cb32-6"></a>memset<span class="op">(&amp;</span>hints<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">sizeof</span> hints<span class="op">);</span></span>
<span id="cb32-7"><a href="https://beej.us/guide/bgnet/html/#cb32-7"></a>hints<span class="op">.</span>ai_family <span class="op">=</span> AF_UNSPEC<span class="op">;</span></span>
<span id="cb32-8"><a href="https://beej.us/guide/bgnet/html/#cb32-8"></a>hints<span class="op">.</span>ai_socktype <span class="op">=</span> SOCK_STREAM<span class="op">;</span></span>
<span id="cb32-9"><a href="https://beej.us/guide/bgnet/html/#cb32-9"></a></span>
<span id="cb32-10"><a href="https://beej.us/guide/bgnet/html/#cb32-10"></a>getaddrinfo<span class="op">(</span><span class="st">"www.example.com"</span><span class="op">,</span> <span class="st">"3490"</span><span class="op">,</span> <span class="op">&amp;</span>hints<span class="op">,</span> <span class="op">&amp;</span>res<span class="op">);</span></span>
<span id="cb32-11"><a href="https://beej.us/guide/bgnet/html/#cb32-11"></a></span>
<span id="cb32-12"><a href="https://beej.us/guide/bgnet/html/#cb32-12"></a><span class="co">// make a socket:</span></span>
<span id="cb32-13"><a href="https://beej.us/guide/bgnet/html/#cb32-13"></a></span>
<span id="cb32-14"><a href="https://beej.us/guide/bgnet/html/#cb32-14"></a>sockfd <span class="op">=</span> socket<span class="op">(</span>res<span class="op">-&gt;</span>ai_family<span class="op">,</span> res<span class="op">-&gt;</span>ai_socktype<span class="op">,</span> res<span class="op">-&gt;</span>ai_protocol<span class="op">);</span></span>
<span id="cb32-15"><a href="https://beej.us/guide/bgnet/html/#cb32-15"></a></span>
<span id="cb32-16"><a href="https://beej.us/guide/bgnet/html/#cb32-16"></a><span class="co">// connect!</span></span>
<span id="cb32-17"><a href="https://beej.us/guide/bgnet/html/#cb32-17"></a></span>
<span id="cb32-18"><a href="https://beej.us/guide/bgnet/html/#cb32-18"></a>connect<span class="op">(</span>sockfd<span class="op">,</span> res<span class="op">-&gt;</span>ai_addr<span class="op">,</span> res<span class="op">-&gt;</span>ai_addrlen<span class="op">);</span></span></code></pre></div>
<p>Again, old-school programs filled out their own <code>struct sockaddr_in</code>s to pass to <code>connect()</code>. You can do that if you want to. See the similar note in the <a href="https://beej.us/guide/bgnet/html/#bind"><code>bind()</code> section</a>, above.</p>
<p>Be sure to check the return value from <code>connect()</code>—it’ll return <code>-1</code> on error and set the variable <code>errno</code>.</p>
<p></p>
<p>Also, notice that we didn’t call <code>bind()</code>. Basically, we don’t care about our local port number; we only care where we’re going (the remote port). The kernel will choose a local port for us, and the site we connect to will automatically get this information from us. No worries.</p>
<h2 data-number="5.5" id="listen"><span class="header-section-number">5.5</span> <code>listen()</code>—Will somebody please call me?</h2>
<p> OK, time for a change of pace. What if you don’t want to connect to a remote host. Say, just for kicks, that you want to wait for incoming connections and handle them in some way. The process is two step: first you <code>listen()</code>, then you <code>accept()</code> (see below).</p>
<p>The <code>listen()</code> call is fairly simple, but requires a bit of explanation:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb33-1"><a href="https://beej.us/guide/bgnet/html/#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> listen<span class="op">(</span><span class="dt">int</span> sockfd<span class="op">,</span> <span class="dt">int</span> backlog<span class="op">);</span> </span></code></pre></div>
<p><code>sockfd</code> is the usual socket file descriptor from the <code>socket()</code> system call. <code>backlog</code> is the number of connections allowed on the incoming queue. What does that mean? Well, incoming connections are going to wait in this queue until you <code>accept()</code> them (see below) and this is the limit on how many can queue up. Most systems silently limit this number to about 20; you can probably get away with setting it to <code>5</code> or <code>10</code>.</p>
<p>Again, as per usual, <code>listen()</code> returns <code>-1</code> and sets <code>errno</code> on error.</p>
<p>Well, as you can probably imagine, we need to call <code>bind()</code> before we call <code>listen()</code> so that the server is running on a specific port. (You have to be able to tell your buddies which port to connect to!) So if you’re going to be listening for incoming connections, the sequence of system calls you’ll make is:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb34-1"><a href="https://beej.us/guide/bgnet/html/#cb34-1"></a>getaddrinfo<span class="op">();</span></span>
<span id="cb34-2"><a href="https://beej.us/guide/bgnet/html/#cb34-2"></a>socket<span class="op">();</span></span>
<span id="cb34-3"><a href="https://beej.us/guide/bgnet/html/#cb34-3"></a>bind<span class="op">();</span></span>
<span id="cb34-4"><a href="https://beej.us/guide/bgnet/html/#cb34-4"></a>listen<span class="op">();</span></span>
<span id="cb34-5"><a href="https://beej.us/guide/bgnet/html/#cb34-5"></a><span class="co">/* accept() goes here */</span> </span></code></pre></div>
<p>I’ll just leave that in the place of sample code, since it’s fairly self-explanatory. (The code in the <code>accept()</code> section, below, is more complete.) The really tricky part of this whole sha-bang is the call to <code>accept()</code>.</p>
<h2 data-number="5.6" id="acceptthank-you-for-calling-port-3490."><span class="header-section-number">5.6</span> <code>accept()</code>—“Thank you for calling port 3490.”</h2>
<p> Get ready—the <code>accept()</code> call is kinda weird! What’s going to happen is this: someone far far away will try to <code>connect()</code> to your machine on a port that you are <code>listen()</code>ing on. Their connection will be queued up waiting to be <code>accept()</code>ed.&nbsp;You call <code>accept()</code> and you tell it to get the pending connection. It’ll return to you a <em>brand new socket file descriptor</em> to use for this single connection! That’s right, suddenly you have <em>two socket file descriptors</em> for the price of one! The original one is still listening for more new connections, and the newly created one is finally ready to <code>send()</code> and <code>recv()</code>. We’re there!</p>
<p>The call is as follows:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb35-1"><a href="https://beej.us/guide/bgnet/html/#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb35-2"><a href="https://beej.us/guide/bgnet/html/#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/socket.h&gt;</span></span>
<span id="cb35-3"><a href="https://beej.us/guide/bgnet/html/#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="https://beej.us/guide/bgnet/html/#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> accept<span class="op">(</span><span class="dt">int</span> sockfd<span class="op">,</span> <span class="kw">struct</span> sockaddr <span class="op">*</span>addr<span class="op">,</span> socklen_t <span class="op">*</span>addrlen<span class="op">);</span> </span></code></pre></div>
<p><code>sockfd</code> is the <code>listen()</code>ing socket descriptor. Easy enough. <code>addr</code> will usually be a pointer to a local <code>struct sockaddr_storage</code>. This is where the information about the incoming connection will go (and with it you can determine which host is calling you from which port). <code>addrlen</code> is a local integer variable that should be set to <code>sizeof(struct sockaddr_storage)</code> before its address is passed to <code>accept()</code>. <code>accept()</code> will not put more than that many bytes into <code>addr</code>. If it puts fewer in, it’ll change the value of <code>addrlen</code> to reflect that.</p>
<p>Guess what? <code>accept()</code> returns <code>-1</code> and sets <code>errno</code> if an error occurs. Betcha didn’t figure that.</p>
<p>Like before, this is a bunch to absorb in one chunk, so here’s a sample code fragment for your perusal:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb36-1"><a href="https://beej.us/guide/bgnet/html/#cb36-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb36-2"><a href="https://beej.us/guide/bgnet/html/#cb36-2"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb36-3"><a href="https://beej.us/guide/bgnet/html/#cb36-3"></a><span class="pp">#include </span><span class="im">&lt;sys/socket.h&gt;</span></span>
<span id="cb36-4"><a href="https://beej.us/guide/bgnet/html/#cb36-4"></a><span class="pp">#include </span><span class="im">&lt;netdb.h&gt;</span></span>
<span id="cb36-5"><a href="https://beej.us/guide/bgnet/html/#cb36-5"></a></span>
<span id="cb36-6"><a href="https://beej.us/guide/bgnet/html/#cb36-6"></a><span class="pp">#define MYPORT </span><span class="st">"3490"</span><span class="pp">  </span><span class="co">// the port users will be connecting to</span></span>
<span id="cb36-7"><a href="https://beej.us/guide/bgnet/html/#cb36-7"></a><span class="pp">#define BACKLOG </span><span class="dv">10</span><span class="pp">     </span><span class="co">// how many pending connections queue will hold</span></span>
<span id="cb36-8"><a href="https://beej.us/guide/bgnet/html/#cb36-8"></a></span>
<span id="cb36-9"><a href="https://beej.us/guide/bgnet/html/#cb36-9"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb36-10"><a href="https://beej.us/guide/bgnet/html/#cb36-10"></a><span class="op">{</span></span>
<span id="cb36-11"><a href="https://beej.us/guide/bgnet/html/#cb36-11"></a>    <span class="kw">struct</span> sockaddr_storage their_addr<span class="op">;</span></span>
<span id="cb36-12"><a href="https://beej.us/guide/bgnet/html/#cb36-12"></a>    socklen_t addr_size<span class="op">;</span></span>
<span id="cb36-13"><a href="https://beej.us/guide/bgnet/html/#cb36-13"></a>    <span class="kw">struct</span> addrinfo hints<span class="op">,</span> <span class="op">*</span>res<span class="op">;</span></span>
<span id="cb36-14"><a href="https://beej.us/guide/bgnet/html/#cb36-14"></a>    <span class="dt">int</span> sockfd<span class="op">,</span> new_fd<span class="op">;</span></span>
<span id="cb36-15"><a href="https://beej.us/guide/bgnet/html/#cb36-15"></a></span>
<span id="cb36-16"><a href="https://beej.us/guide/bgnet/html/#cb36-16"></a>    <span class="co">// !! don't forget your error checking for these calls !!</span></span>
<span id="cb36-17"><a href="https://beej.us/guide/bgnet/html/#cb36-17"></a></span>
<span id="cb36-18"><a href="https://beej.us/guide/bgnet/html/#cb36-18"></a>    <span class="co">// first, load up address structs with getaddrinfo():</span></span>
<span id="cb36-19"><a href="https://beej.us/guide/bgnet/html/#cb36-19"></a></span>
<span id="cb36-20"><a href="https://beej.us/guide/bgnet/html/#cb36-20"></a>    memset<span class="op">(&amp;</span>hints<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">sizeof</span> hints<span class="op">);</span></span>
<span id="cb36-21"><a href="https://beej.us/guide/bgnet/html/#cb36-21"></a>    hints<span class="op">.</span>ai_family <span class="op">=</span> AF_UNSPEC<span class="op">;</span>  <span class="co">// use IPv4 or IPv6, whichever</span></span>
<span id="cb36-22"><a href="https://beej.us/guide/bgnet/html/#cb36-22"></a>    hints<span class="op">.</span>ai_socktype <span class="op">=</span> SOCK_STREAM<span class="op">;</span></span>
<span id="cb36-23"><a href="https://beej.us/guide/bgnet/html/#cb36-23"></a>    hints<span class="op">.</span>ai_flags <span class="op">=</span> AI_PASSIVE<span class="op">;</span>     <span class="co">// fill in my IP for me</span></span>
<span id="cb36-24"><a href="https://beej.us/guide/bgnet/html/#cb36-24"></a></span>
<span id="cb36-25"><a href="https://beej.us/guide/bgnet/html/#cb36-25"></a>    getaddrinfo<span class="op">(</span>NULL<span class="op">,</span> MYPORT<span class="op">,</span> <span class="op">&amp;</span>hints<span class="op">,</span> <span class="op">&amp;</span>res<span class="op">);</span></span>
<span id="cb36-26"><a href="https://beej.us/guide/bgnet/html/#cb36-26"></a></span>
<span id="cb36-27"><a href="https://beej.us/guide/bgnet/html/#cb36-27"></a>    <span class="co">// make a socket, bind it, and listen on it:</span></span>
<span id="cb36-28"><a href="https://beej.us/guide/bgnet/html/#cb36-28"></a></span>
<span id="cb36-29"><a href="https://beej.us/guide/bgnet/html/#cb36-29"></a>    sockfd <span class="op">=</span> socket<span class="op">(</span>res<span class="op">-&gt;</span>ai_family<span class="op">,</span> res<span class="op">-&gt;</span>ai_socktype<span class="op">,</span> res<span class="op">-&gt;</span>ai_protocol<span class="op">);</span></span>
<span id="cb36-30"><a href="https://beej.us/guide/bgnet/html/#cb36-30"></a>    bind<span class="op">(</span>sockfd<span class="op">,</span> res<span class="op">-&gt;</span>ai_addr<span class="op">,</span> res<span class="op">-&gt;</span>ai_addrlen<span class="op">);</span></span>
<span id="cb36-31"><a href="https://beej.us/guide/bgnet/html/#cb36-31"></a>    listen<span class="op">(</span>sockfd<span class="op">,</span> BACKLOG<span class="op">);</span></span>
<span id="cb36-32"><a href="https://beej.us/guide/bgnet/html/#cb36-32"></a></span>
<span id="cb36-33"><a href="https://beej.us/guide/bgnet/html/#cb36-33"></a>    <span class="co">// now accept an incoming connection:</span></span>
<span id="cb36-34"><a href="https://beej.us/guide/bgnet/html/#cb36-34"></a></span>
<span id="cb36-35"><a href="https://beej.us/guide/bgnet/html/#cb36-35"></a>    addr_size <span class="op">=</span> <span class="kw">sizeof</span> their_addr<span class="op">;</span></span>
<span id="cb36-36"><a href="https://beej.us/guide/bgnet/html/#cb36-36"></a>    new_fd <span class="op">=</span> accept<span class="op">(</span>sockfd<span class="op">,</span> <span class="op">(</span><span class="kw">struct</span> sockaddr <span class="op">*)&amp;</span>their_addr<span class="op">,</span> <span class="op">&amp;</span>addr_size<span class="op">);</span></span>
<span id="cb36-37"><a href="https://beej.us/guide/bgnet/html/#cb36-37"></a></span>
<span id="cb36-38"><a href="https://beej.us/guide/bgnet/html/#cb36-38"></a>    <span class="co">// ready to communicate on socket descriptor new_fd!</span></span>
<span id="cb36-39"><a href="https://beej.us/guide/bgnet/html/#cb36-39"></a>    <span class="op">.</span></span>
<span id="cb36-40"><a href="https://beej.us/guide/bgnet/html/#cb36-40"></a>    <span class="op">.</span></span>
<span id="cb36-41"><a href="https://beej.us/guide/bgnet/html/#cb36-41"></a>    <span class="op">.</span></span></code></pre></div>
<p>Again, note that we will use the socket descriptor <code>new_fd</code> for all <code>send()</code> and <code>recv()</code> calls. If you’re only getting one single connection ever, you can <code>close()</code> the listening <code>sockfd</code> in order to prevent more incoming connections on the same port, if you so desire.</p>
<h2 data-number="5.7" id="sendrecv"><span class="header-section-number">5.7</span> <code>send()</code> and <code>recv()</code>—Talk to me, baby!</h2>
<p>These two functions are for communicating over stream sockets or connected datagram sockets. If you want to use regular unconnected datagram sockets, you’ll need to see the section on <a href="https://beej.us/guide/bgnet/html/#sendtorecv"><code>sendto()</code> and <code>recvfrom()</code></a>, below.</p>
<blockquote>
<p> Here’s something that might (or might not) be new to you: these are <em>blocking</em> calls. That is, <code>recv()</code> will <em>block</em> until there is some data ready to receive. “But what does ‘block’ mean, already?!” It means your program is going to stop there, on that system call, until someone sends you something. (The OS techie jargon for “stop” in that sentence is actually <em>sleep</em>, so I might use those terms interchangeably.) <code>send()</code> can also block if the stuff you’re sending is all jammed up somehow, but that’s rarer. We’ll <a href="https://beej.us/guide/bgnet/html/#blocking">revisit this concept later</a>, and talk about how to avoid it when you need to.</p>
</blockquote>
<p> Here’s the <code>send()</code> call:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb37-1"><a href="https://beej.us/guide/bgnet/html/#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> send<span class="op">(</span><span class="dt">int</span> sockfd<span class="op">,</span> <span class="dt">const</span> <span class="dt">void</span> <span class="op">*</span>msg<span class="op">,</span> <span class="dt">int</span> len<span class="op">,</span> <span class="dt">int</span> flags<span class="op">);</span> </span></code></pre></div>
<p><code>sockfd</code> is the socket descriptor you want to send data to (whether it’s the one returned by <code>socket()</code> or the one you got with <code>accept()</code>). <code>msg</code> is a pointer to the data you want to send, and <code>len</code> is the length of that data in bytes. Just set <code>flags</code> to <code>0</code>. (See the <code>send()</code> man page for more information concerning flags.)</p>
<p>Some sample code might be:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb38-1"><a href="https://beej.us/guide/bgnet/html/#cb38-1"></a><span class="dt">char</span> <span class="op">*</span>msg <span class="op">=</span> <span class="st">"Beej was here!"</span><span class="op">;</span></span>
<span id="cb38-2"><a href="https://beej.us/guide/bgnet/html/#cb38-2"></a><span class="dt">int</span> len<span class="op">,</span> bytes_sent<span class="op">;</span></span>
<span id="cb38-3"><a href="https://beej.us/guide/bgnet/html/#cb38-3"></a><span class="op">.</span></span>
<span id="cb38-4"><a href="https://beej.us/guide/bgnet/html/#cb38-4"></a><span class="op">.</span></span>
<span id="cb38-5"><a href="https://beej.us/guide/bgnet/html/#cb38-5"></a><span class="op">.</span></span>
<span id="cb38-6"><a href="https://beej.us/guide/bgnet/html/#cb38-6"></a>len <span class="op">=</span> strlen<span class="op">(</span>msg<span class="op">);</span></span>
<span id="cb38-7"><a href="https://beej.us/guide/bgnet/html/#cb38-7"></a>bytes_sent <span class="op">=</span> send<span class="op">(</span>sockfd<span class="op">,</span> msg<span class="op">,</span> len<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb38-8"><a href="https://beej.us/guide/bgnet/html/#cb38-8"></a><span class="op">.</span></span>
<span id="cb38-9"><a href="https://beej.us/guide/bgnet/html/#cb38-9"></a><span class="op">.</span></span>
<span id="cb38-10"><a href="https://beej.us/guide/bgnet/html/#cb38-10"></a><span class="op">.</span> </span></code></pre></div>
<p><code>send()</code> returns the number of bytes actually sent out—<em>this might be less than the number you told it to send!</em> See, sometimes you tell it to send a whole gob of data and it just can’t handle it. It’ll fire off as much of the data as it can, and trust you to send the rest later. Remember, if the value returned by <code>send()</code> doesn’t match the value in <code>len</code>, it’s up to you to send the rest of the string. The good news is this: if the packet is small (less than 1K or so) it will <em>probably</em> manage to send the whole thing all in one go. Again, <code>-1</code> is returned on error, and <code>errno</code> is set to the error number.</p>
<p> The <code>recv()</code> call is similar in many respects:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb39-1"><a href="https://beej.us/guide/bgnet/html/#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> recv<span class="op">(</span><span class="dt">int</span> sockfd<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>buf<span class="op">,</span> <span class="dt">int</span> len<span class="op">,</span> <span class="dt">int</span> flags<span class="op">);</span></span></code></pre></div>
<p><code>sockfd</code> is the socket descriptor to read from, <code>buf</code> is the buffer to read the information into, <code>len</code> is the maximum length of the buffer, and <code>flags</code> can again be set to <code>0</code>. (See the <code>recv()</code> man page for flag information.)</p>
<p><code>recv()</code> returns the number of bytes actually read into the buffer, or <code>-1</code> on error (with <code>errno</code> set, accordingly).</p>
<p>Wait! <code>recv()</code> can return <code>0</code>. This can mean only one thing: the remote side has closed the connection on you! A return value of <code>0</code> is <code>recv()</code>’s way of letting you know this has occurred.</p>
<p>There, that was easy, wasn’t it? You can now pass data back and forth on stream sockets! Whee! You’re a Unix Network Programmer!</p>
<h2 data-number="5.8" id="sendtorecv"><span class="header-section-number">5.8</span> <code>sendto()</code> and <code>recvfrom()</code>—Talk to me, DGRAM-style</h2>
<p> “This is all fine and dandy,” I hear you saying, “but where does this leave me with unconnected datagram sockets?” No problemo, amigo. We have just the thing.</p>
<p>Since datagram sockets aren’t connected to a remote host, guess which piece of information we need to give before we send a packet? That’s right! The destination address! Here’s the scoop:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb40-1"><a href="https://beej.us/guide/bgnet/html/#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> sendto<span class="op">(</span><span class="dt">int</span> sockfd<span class="op">,</span> <span class="dt">const</span> <span class="dt">void</span> <span class="op">*</span>msg<span class="op">,</span> <span class="dt">int</span> len<span class="op">,</span> <span class="dt">unsigned</span> <span class="dt">int</span> flags<span class="op">,</span></span>
<span id="cb40-2"><a href="https://beej.us/guide/bgnet/html/#cb40-2" aria-hidden="true" tabindex="-1"></a>           <span class="dt">const</span> <span class="kw">struct</span> sockaddr <span class="op">*</span>to<span class="op">,</span> socklen_t tolen<span class="op">);</span> </span></code></pre></div>
<p>As you can see, this call is basically the same as the call to <code>send()</code> with the addition of two other pieces of information. <code>to</code> is a pointer to a <code>struct sockaddr</code> (which will probably be another <code>struct sockaddr_in</code> or <code>struct sockaddr_in6</code> or <code>struct sockaddr_storage</code> that you cast at the last minute) which contains the destination IP address and port. <code>tolen</code>, an <code>int</code> deep-down, can simply be set to <code>sizeof *to</code> or <code>sizeof(struct sockaddr_storage)</code>.</p>
<p>To get your hands on the destination address structure, you’ll probably either get it from <code>getaddrinfo()</code>, or from <code>recvfrom()</code>, below, or you’ll fill it out by hand.</p>
<p>Just like with <code>send()</code>, <code>sendto()</code> returns the number of bytes actually sent (which, again, might be less than the number of bytes you told it to send!), or <code>-1</code> on error.</p>
<p>Equally similar are <code>recv()</code> and <code>recvfrom()</code>. The synopsis of <code>recvfrom()</code> is:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb41-1"><a href="https://beej.us/guide/bgnet/html/#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> recvfrom<span class="op">(</span><span class="dt">int</span> sockfd<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>buf<span class="op">,</span> <span class="dt">int</span> len<span class="op">,</span> <span class="dt">unsigned</span> <span class="dt">int</span> flags<span class="op">,</span></span>
<span id="cb41-2"><a href="https://beej.us/guide/bgnet/html/#cb41-2" aria-hidden="true" tabindex="-1"></a>             <span class="kw">struct</span> sockaddr <span class="op">*</span>from<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>fromlen<span class="op">);</span> </span></code></pre></div>
<p>Again, this is just like <code>recv()</code> with the addition of a couple fields. <code>from</code> is a pointer to a local <code>struct sockaddr_storage</code> that will be filled with the IP address and port of the originating machine. <code>fromlen</code> is a pointer to a local <code>int</code> that should be initialized to <code>sizeof *from</code> or <code>sizeof(struct sockaddr_storage)</code>. When the function returns, <code>fromlen</code> will contain the length of the address actually stored in <code>from</code>.</p>
<p><code>recvfrom()</code> returns the number of bytes received, or <code>-1</code> on error (with <code>errno</code> set accordingly).</p>
<p>So, here’s a question: why do we use <code>struct sockaddr_storage</code> as the socket type? Why not <code>struct sockaddr_in</code>? Because, you see, we want to not tie ourselves down to IPv4 or IPv6. So we use the generic <code>struct sockaddr_storage</code> which we know will be big enough for either.</p>
<p>(So… here’s another question: why isn’t <code>struct sockaddr</code> itself big enough for any address? We even cast the general-purpose <code>struct sockaddr_storage</code> to the general-purpose <code>struct sockaddr</code>! Seems extraneous and redundant, huh. The answer is, it just isn’t big enough, and I’d guess that changing it at this point would be Problematic. So they made a new one.)</p>
<p>Remember, if you <code>connect()</code> a datagram socket, you can then simply use <code>send()</code> and <code>recv()</code> for all your transactions. The socket itself is still a datagram socket and the packets still use UDP, but the socket interface will automatically add the destination and source information for you.</p>
<h2 data-number="5.9" id="close-and-shutdownget-outta-my-face"><span class="header-section-number">5.9</span> <code>close()</code> and <code>shutdown()</code>—Get outta my face!</h2>
<p>Whew! You’ve been <code>send()</code>ing and <code>recv()</code>ing data all day long, and you’ve had it. You’re ready to close the connection on your socket descriptor. This is easy. You can just use the regular Unix file descriptor <code>close()</code> function:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb42-1"><a href="https://beej.us/guide/bgnet/html/#cb42-1" aria-hidden="true" tabindex="-1"></a>close<span class="op">(</span>sockfd<span class="op">);</span> </span></code></pre></div>
<p>This will prevent any more reads and writes to the socket. Anyone attempting to read or write the socket on the remote end will receive an error.</p>
<p>Just in case you want a little more control over how the socket closes, you can use the <code>shutdown()</code> function. It allows you to cut off communication in a certain direction, or both ways (just like <code>close()</code> does). Synopsis:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb43-1"><a href="https://beej.us/guide/bgnet/html/#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> shutdown<span class="op">(</span><span class="dt">int</span> sockfd<span class="op">,</span> <span class="dt">int</span> how<span class="op">);</span> </span></code></pre></div>
<p><code>sockfd</code> is the socket file descriptor you want to shutdown, and <code>how</code> is one of the following:</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;"><code>how</code></th>
<th>Effect</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code>0</code></td>
<td>Further receives are disallowed</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>1</code></td>
<td>Further sends are disallowed</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>2</code></td>
<td>Further sends and receives are disallowed (like <code>close()</code>)</td>
</tr>
</tbody>
</table>
<p><code>shutdown()</code> returns <code>0</code> on success, and <code>-1</code> on error (with <code>errno</code> set accordingly).</p>
<p>If you deign to use <code>shutdown()</code> on unconnected datagram sockets, it will simply make the socket unavailable for further <code>send()</code> and <code>recv()</code> calls (remember that you can use these if you <code>connect()</code> your datagram socket).</p>
<p>It’s important to note that <code>shutdown()</code> doesn’t actually close the file descriptor—it just changes its usability. To free a socket descriptor, you need to use <code>close()</code>.</p>
<p>Nothing to it.</p>
<p>(Except to remember that if you’re using Windows and Winsock that you should call <code>closesocket()</code> instead of <code>close()</code>.)</p>
<h2 data-number="5.10" id="getpeernamewho-are-you"><span class="header-section-number">5.10</span> <code>getpeername()</code>—Who are you?</h2>
<p> This function is so easy.</p>
<p>It’s so easy, I almost didn’t give it its own section. But here it is anyway.</p>
<p>The function <code>getpeername()</code> will tell you who is at the other end of a connected stream socket. The synopsis:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb44-1"><a href="https://beej.us/guide/bgnet/html/#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/socket.h&gt;</span></span>
<span id="cb44-2"><a href="https://beej.us/guide/bgnet/html/#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="https://beej.us/guide/bgnet/html/#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> getpeername<span class="op">(</span><span class="dt">int</span> sockfd<span class="op">,</span> <span class="kw">struct</span> sockaddr <span class="op">*</span>addr<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>addrlen<span class="op">);</span> </span></code></pre></div>
<p><code>sockfd</code> is the descriptor of the connected stream socket, <code>addr</code> is a pointer to a <code>struct sockaddr</code> (or a <code>struct sockaddr_in</code>) that will hold the information about the other side of the connection, and <code>addrlen</code> is a pointer to an <code>int</code>, that should be initialized to <code>sizeof *addr</code> or <code>sizeof(struct sockaddr)</code>.</p>
<p>The function returns <code>-1</code> on error and sets <code>errno</code> accordingly.</p>
<p>Once you have their address, you can use <code>inet_ntop()</code>, <code>getnameinfo()</code>, or <code>gethostbyaddr()</code> to print or get more information. No, you can’t get their login name. (Ok, ok. If the other computer is running an ident daemon, this is possible. This, however, is beyond the scope of this document. Check out <a href="https://tools.ietf.org/html/rfc1413">RFC 1413</a><a href="https://beej.us/guide/bgnet/html/#fn23" class="footnote-ref" id="fnref23" role="doc-noteref"><sup>23</sup></a> for more info.)</p>
<h2 data-number="5.11" id="gethostnamewho-am-i"><span class="header-section-number">5.11</span> <code>gethostname()</code>—Who am I?</h2>
<p> Even easier than <code>getpeername()</code> is the function <code>gethostname()</code>. It returns the name of the computer that your program is running on. The name can then be used by <code>getaddrinfo()</code>, above, to determine the IP address of your local machine.</p>
<p>What could be more fun? I could think of a few things, but they don’t pertain to socket programming. Anyway, here’s the breakdown:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb45-1"><a href="https://beej.us/guide/bgnet/html/#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb45-2"><a href="https://beej.us/guide/bgnet/html/#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="https://beej.us/guide/bgnet/html/#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> gethostname<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>hostname<span class="op">,</span> <span class="dt">size_t</span> size<span class="op">);</span> </span></code></pre></div>
<p>The arguments are simple: <code>hostname</code> is a pointer to an array of chars that will contain the hostname upon the function’s return, and <code>size</code> is the length in bytes of the <code>hostname</code> array.</p>
<p>The function returns <code>0</code> on successful completion, and <code>-1</code> on error, setting <code>errno</code> as usual.</p>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="6" id="client-server-background"><span class="header-section-number">6</span> Client-Server Background</h1>
<p></p>
<p>It’s a client-server world, baby. Just about everything on the network deals with client processes talking to server processes and vice-versa. Take <code>telnet</code>, for instance. When you connect to a remote host on port 23 with telnet (the client), a program on that host (called <code>telnetd</code>, the server) springs to life. It handles the incoming telnet connection, sets you up with a login prompt, etc.</p>
<figure>
<embed src="cs.svg" title="[Client-Server Interaction Diagram]">
<figcaption aria-hidden="true">Client-Server Interaction.</figcaption>
</figure>
<p>The exchange of information between client and server is summarized in the above diagram.</p>
<p>Note that the client-server pair can speak <code>SOCK_STREAM</code>, <code>SOCK_DGRAM</code>, or anything else (as long as they’re speaking the same thing). Some good examples of client-server pairs are <code>telnet</code>/<code>telnetd</code>, <code>ftp</code>/<code>ftpd</code>, or <code>Firefox</code>/<code>Apache</code>. Every time you use <code>ftp</code>, there’s a remote program, <code>ftpd</code>, that serves you.</p>
<p>Often, there will only be one server on a machine, and that server will handle multiple clients using <code>fork()</code>. The basic routine is: server will wait for a connection, <code>accept()</code> it, and <code>fork()</code> a child process to handle it. This is what our sample server does in the next section.</p>
<h2 data-number="6.1" id="a-simple-stream-server"><span class="header-section-number">6.1</span> A Simple Stream Server</h2>
<p></p>
<p>All this server does is send the string “<code>Hello, world!</code>” out over a stream connection. All you need to do to test this server is run it in one window, and telnet to it from another with:</p>
<pre><code>$ telnet remotehostname 3490</code></pre>
<p>where <code>remotehostname</code> is the name of the machine you’re running it on.</p>
<p><a href="https://beej.us/guide/bgnet/source/examples/server.c">The server code</a><a href="https://beej.us/guide/bgnet/html/#fn24" class="footnote-ref" id="fnref24" role="doc-noteref"><sup>24</sup></a>:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb47-1"><a href="https://beej.us/guide/bgnet/html/#cb47-1"></a><span class="co">/*</span></span>
<span id="cb47-2"><a href="https://beej.us/guide/bgnet/html/#cb47-2"></a><span class="co">** server.c -- a stream socket server demo</span></span>
<span id="cb47-3"><a href="https://beej.us/guide/bgnet/html/#cb47-3"></a><span class="co">*/</span></span>
<span id="cb47-4"><a href="https://beej.us/guide/bgnet/html/#cb47-4"></a></span>
<span id="cb47-5"><a href="https://beej.us/guide/bgnet/html/#cb47-5"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb47-6"><a href="https://beej.us/guide/bgnet/html/#cb47-6"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb47-7"><a href="https://beej.us/guide/bgnet/html/#cb47-7"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb47-8"><a href="https://beej.us/guide/bgnet/html/#cb47-8"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb47-9"><a href="https://beej.us/guide/bgnet/html/#cb47-9"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb47-10"><a href="https://beej.us/guide/bgnet/html/#cb47-10"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb47-11"><a href="https://beej.us/guide/bgnet/html/#cb47-11"></a><span class="pp">#include </span><span class="im">&lt;sys/socket.h&gt;</span></span>
<span id="cb47-12"><a href="https://beej.us/guide/bgnet/html/#cb47-12"></a><span class="pp">#include </span><span class="im">&lt;netinet/in.h&gt;</span></span>
<span id="cb47-13"><a href="https://beej.us/guide/bgnet/html/#cb47-13"></a><span class="pp">#include </span><span class="im">&lt;netdb.h&gt;</span></span>
<span id="cb47-14"><a href="https://beej.us/guide/bgnet/html/#cb47-14"></a><span class="pp">#include </span><span class="im">&lt;arpa/inet.h&gt;</span></span>
<span id="cb47-15"><a href="https://beej.us/guide/bgnet/html/#cb47-15"></a><span class="pp">#include </span><span class="im">&lt;sys/wait.h&gt;</span></span>
<span id="cb47-16"><a href="https://beej.us/guide/bgnet/html/#cb47-16"></a><span class="pp">#include </span><span class="im">&lt;signal.h&gt;</span></span>
<span id="cb47-17"><a href="https://beej.us/guide/bgnet/html/#cb47-17"></a></span>
<span id="cb47-18"><a href="https://beej.us/guide/bgnet/html/#cb47-18"></a><span class="pp">#define PORT </span><span class="st">"3490"</span><span class="pp">  </span><span class="co">// the port users will be connecting to</span></span>
<span id="cb47-19"><a href="https://beej.us/guide/bgnet/html/#cb47-19"></a></span>
<span id="cb47-20"><a href="https://beej.us/guide/bgnet/html/#cb47-20"></a><span class="pp">#define BACKLOG </span><span class="dv">10</span><span class="pp">   </span><span class="co">// how many pending connections queue will hold</span></span>
<span id="cb47-21"><a href="https://beej.us/guide/bgnet/html/#cb47-21"></a></span>
<span id="cb47-22"><a href="https://beej.us/guide/bgnet/html/#cb47-22"></a><span class="dt">void</span> sigchld_handler<span class="op">(</span><span class="dt">int</span> s<span class="op">)</span></span>
<span id="cb47-23"><a href="https://beej.us/guide/bgnet/html/#cb47-23"></a><span class="op">{</span></span>
<span id="cb47-24"><a href="https://beej.us/guide/bgnet/html/#cb47-24"></a>    <span class="co">// waitpid() might overwrite errno, so we save and restore it:</span></span>
<span id="cb47-25"><a href="https://beej.us/guide/bgnet/html/#cb47-25"></a>    <span class="dt">int</span> saved_errno <span class="op">=</span> errno<span class="op">;</span></span>
<span id="cb47-26"><a href="https://beej.us/guide/bgnet/html/#cb47-26"></a></span>
<span id="cb47-27"><a href="https://beej.us/guide/bgnet/html/#cb47-27"></a>    <span class="cf">while</span><span class="op">(</span>waitpid<span class="op">(-</span><span class="dv">1</span><span class="op">,</span> NULL<span class="op">,</span> WNOHANG<span class="op">)</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb47-28"><a href="https://beej.us/guide/bgnet/html/#cb47-28"></a></span>
<span id="cb47-29"><a href="https://beej.us/guide/bgnet/html/#cb47-29"></a>    errno <span class="op">=</span> saved_errno<span class="op">;</span></span>
<span id="cb47-30"><a href="https://beej.us/guide/bgnet/html/#cb47-30"></a><span class="op">}</span></span>
<span id="cb47-31"><a href="https://beej.us/guide/bgnet/html/#cb47-31"></a></span>
<span id="cb47-32"><a href="https://beej.us/guide/bgnet/html/#cb47-32"></a></span>
<span id="cb47-33"><a href="https://beej.us/guide/bgnet/html/#cb47-33"></a><span class="co">// get sockaddr, IPv4 or IPv6:</span></span>
<span id="cb47-34"><a href="https://beej.us/guide/bgnet/html/#cb47-34"></a><span class="dt">void</span> <span class="op">*</span>get_in_addr<span class="op">(</span><span class="kw">struct</span> sockaddr <span class="op">*</span>sa<span class="op">)</span></span>
<span id="cb47-35"><a href="https://beej.us/guide/bgnet/html/#cb47-35"></a><span class="op">{</span></span>
<span id="cb47-36"><a href="https://beej.us/guide/bgnet/html/#cb47-36"></a>    <span class="cf">if</span> <span class="op">(</span>sa<span class="op">-&gt;</span>sa_family <span class="op">==</span> AF_INET<span class="op">)</span> <span class="op">{</span></span>
<span id="cb47-37"><a href="https://beej.us/guide/bgnet/html/#cb47-37"></a>        <span class="cf">return</span> <span class="op">&amp;(((</span><span class="kw">struct</span> sockaddr_in<span class="op">*)</span>sa<span class="op">)-&gt;</span>sin_addr<span class="op">);</span></span>
<span id="cb47-38"><a href="https://beej.us/guide/bgnet/html/#cb47-38"></a>    <span class="op">}</span></span>
<span id="cb47-39"><a href="https://beej.us/guide/bgnet/html/#cb47-39"></a></span>
<span id="cb47-40"><a href="https://beej.us/guide/bgnet/html/#cb47-40"></a>    <span class="cf">return</span> <span class="op">&amp;(((</span><span class="kw">struct</span> sockaddr_in6<span class="op">*)</span>sa<span class="op">)-&gt;</span>sin6_addr<span class="op">);</span></span>
<span id="cb47-41"><a href="https://beej.us/guide/bgnet/html/#cb47-41"></a><span class="op">}</span></span>
<span id="cb47-42"><a href="https://beej.us/guide/bgnet/html/#cb47-42"></a></span>
<span id="cb47-43"><a href="https://beej.us/guide/bgnet/html/#cb47-43"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb47-44"><a href="https://beej.us/guide/bgnet/html/#cb47-44"></a><span class="op">{</span></span>
<span id="cb47-45"><a href="https://beej.us/guide/bgnet/html/#cb47-45"></a>    <span class="dt">int</span> sockfd<span class="op">,</span> new_fd<span class="op">;</span>  <span class="co">// listen on sock_fd, new connection on new_fd</span></span>
<span id="cb47-46"><a href="https://beej.us/guide/bgnet/html/#cb47-46"></a>    <span class="kw">struct</span> addrinfo hints<span class="op">,</span> <span class="op">*</span>servinfo<span class="op">,</span> <span class="op">*</span>p<span class="op">;</span></span>
<span id="cb47-47"><a href="https://beej.us/guide/bgnet/html/#cb47-47"></a>    <span class="kw">struct</span> sockaddr_storage their_addr<span class="op">;</span> <span class="co">// connector's address information</span></span>
<span id="cb47-48"><a href="https://beej.us/guide/bgnet/html/#cb47-48"></a>    socklen_t sin_size<span class="op">;</span></span>
<span id="cb47-49"><a href="https://beej.us/guide/bgnet/html/#cb47-49"></a>    <span class="kw">struct</span> sigaction sa<span class="op">;</span></span>
<span id="cb47-50"><a href="https://beej.us/guide/bgnet/html/#cb47-50"></a>    <span class="dt">int</span> yes<span class="op">=</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb47-51"><a href="https://beej.us/guide/bgnet/html/#cb47-51"></a>    <span class="dt">char</span> s<span class="op">[</span>INET6_ADDRSTRLEN<span class="op">];</span></span>
<span id="cb47-52"><a href="https://beej.us/guide/bgnet/html/#cb47-52"></a>    <span class="dt">int</span> rv<span class="op">;</span></span>
<span id="cb47-53"><a href="https://beej.us/guide/bgnet/html/#cb47-53"></a></span>
<span id="cb47-54"><a href="https://beej.us/guide/bgnet/html/#cb47-54"></a>    memset<span class="op">(&amp;</span>hints<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">sizeof</span> hints<span class="op">);</span></span>
<span id="cb47-55"><a href="https://beej.us/guide/bgnet/html/#cb47-55"></a>    hints<span class="op">.</span>ai_family <span class="op">=</span> AF_UNSPEC<span class="op">;</span></span>
<span id="cb47-56"><a href="https://beej.us/guide/bgnet/html/#cb47-56"></a>    hints<span class="op">.</span>ai_socktype <span class="op">=</span> SOCK_STREAM<span class="op">;</span></span>
<span id="cb47-57"><a href="https://beej.us/guide/bgnet/html/#cb47-57"></a>    hints<span class="op">.</span>ai_flags <span class="op">=</span> AI_PASSIVE<span class="op">;</span> <span class="co">// use my IP</span></span>
<span id="cb47-58"><a href="https://beej.us/guide/bgnet/html/#cb47-58"></a></span>
<span id="cb47-59"><a href="https://beej.us/guide/bgnet/html/#cb47-59"></a>    <span class="cf">if</span> <span class="op">((</span>rv <span class="op">=</span> getaddrinfo<span class="op">(</span>NULL<span class="op">,</span> PORT<span class="op">,</span> <span class="op">&amp;</span>hints<span class="op">,</span> <span class="op">&amp;</span>servinfo<span class="op">))</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb47-60"><a href="https://beej.us/guide/bgnet/html/#cb47-60"></a>        fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">"getaddrinfo: </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> gai_strerror<span class="op">(</span>rv<span class="op">));</span></span>
<span id="cb47-61"><a href="https://beej.us/guide/bgnet/html/#cb47-61"></a>        <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb47-62"><a href="https://beej.us/guide/bgnet/html/#cb47-62"></a>    <span class="op">}</span></span>
<span id="cb47-63"><a href="https://beej.us/guide/bgnet/html/#cb47-63"></a></span>
<span id="cb47-64"><a href="https://beej.us/guide/bgnet/html/#cb47-64"></a>    <span class="co">// loop through all the results and bind to the first we can</span></span>
<span id="cb47-65"><a href="https://beej.us/guide/bgnet/html/#cb47-65"></a>    <span class="cf">for</span><span class="op">(</span>p <span class="op">=</span> servinfo<span class="op">;</span> p <span class="op">!=</span> NULL<span class="op">;</span> p <span class="op">=</span> p<span class="op">-&gt;</span>ai_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb47-66"><a href="https://beej.us/guide/bgnet/html/#cb47-66"></a>        <span class="cf">if</span> <span class="op">((</span>sockfd <span class="op">=</span> socket<span class="op">(</span>p<span class="op">-&gt;</span>ai_family<span class="op">,</span> p<span class="op">-&gt;</span>ai_socktype<span class="op">,</span></span>
<span id="cb47-67"><a href="https://beej.us/guide/bgnet/html/#cb47-67"></a>                p<span class="op">-&gt;</span>ai_protocol<span class="op">))</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb47-68"><a href="https://beej.us/guide/bgnet/html/#cb47-68"></a>            perror<span class="op">(</span><span class="st">"server: socket"</span><span class="op">);</span></span>
<span id="cb47-69"><a href="https://beej.us/guide/bgnet/html/#cb47-69"></a>            <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb47-70"><a href="https://beej.us/guide/bgnet/html/#cb47-70"></a>        <span class="op">}</span></span>
<span id="cb47-71"><a href="https://beej.us/guide/bgnet/html/#cb47-71"></a></span>
<span id="cb47-72"><a href="https://beej.us/guide/bgnet/html/#cb47-72"></a>        <span class="cf">if</span> <span class="op">(</span>setsockopt<span class="op">(</span>sockfd<span class="op">,</span> SOL_SOCKET<span class="op">,</span> SO_REUSEADDR<span class="op">,</span> <span class="op">&amp;</span>yes<span class="op">,</span></span>
<span id="cb47-73"><a href="https://beej.us/guide/bgnet/html/#cb47-73"></a>                <span class="kw">sizeof</span><span class="op">(</span><span class="dt">int</span><span class="op">))</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb47-74"><a href="https://beej.us/guide/bgnet/html/#cb47-74"></a>            perror<span class="op">(</span><span class="st">"setsockopt"</span><span class="op">);</span></span>
<span id="cb47-75"><a href="https://beej.us/guide/bgnet/html/#cb47-75"></a>            exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb47-76"><a href="https://beej.us/guide/bgnet/html/#cb47-76"></a>        <span class="op">}</span></span>
<span id="cb47-77"><a href="https://beej.us/guide/bgnet/html/#cb47-77"></a></span>
<span id="cb47-78"><a href="https://beej.us/guide/bgnet/html/#cb47-78"></a>        <span class="cf">if</span> <span class="op">(</span>bind<span class="op">(</span>sockfd<span class="op">,</span> p<span class="op">-&gt;</span>ai_addr<span class="op">,</span> p<span class="op">-&gt;</span>ai_addrlen<span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb47-79"><a href="https://beej.us/guide/bgnet/html/#cb47-79"></a>            close<span class="op">(</span>sockfd<span class="op">);</span></span>
<span id="cb47-80"><a href="https://beej.us/guide/bgnet/html/#cb47-80"></a>            perror<span class="op">(</span><span class="st">"server: bind"</span><span class="op">);</span></span>
<span id="cb47-81"><a href="https://beej.us/guide/bgnet/html/#cb47-81"></a>            <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb47-82"><a href="https://beej.us/guide/bgnet/html/#cb47-82"></a>        <span class="op">}</span></span>
<span id="cb47-83"><a href="https://beej.us/guide/bgnet/html/#cb47-83"></a></span>
<span id="cb47-84"><a href="https://beej.us/guide/bgnet/html/#cb47-84"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb47-85"><a href="https://beej.us/guide/bgnet/html/#cb47-85"></a>    <span class="op">}</span></span>
<span id="cb47-86"><a href="https://beej.us/guide/bgnet/html/#cb47-86"></a></span>
<span id="cb47-87"><a href="https://beej.us/guide/bgnet/html/#cb47-87"></a>    freeaddrinfo<span class="op">(</span>servinfo<span class="op">);</span> <span class="co">// all done with this structure</span></span>
<span id="cb47-88"><a href="https://beej.us/guide/bgnet/html/#cb47-88"></a></span>
<span id="cb47-89"><a href="https://beej.us/guide/bgnet/html/#cb47-89"></a>    <span class="cf">if</span> <span class="op">(</span>p <span class="op">==</span> NULL<span class="op">)</span>  <span class="op">{</span></span>
<span id="cb47-90"><a href="https://beej.us/guide/bgnet/html/#cb47-90"></a>        fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">"server: failed to bind</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb47-91"><a href="https://beej.us/guide/bgnet/html/#cb47-91"></a>        exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb47-92"><a href="https://beej.us/guide/bgnet/html/#cb47-92"></a>    <span class="op">}</span></span>
<span id="cb47-93"><a href="https://beej.us/guide/bgnet/html/#cb47-93"></a></span>
<span id="cb47-94"><a href="https://beej.us/guide/bgnet/html/#cb47-94"></a>    <span class="cf">if</span> <span class="op">(</span>listen<span class="op">(</span>sockfd<span class="op">,</span> BACKLOG<span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb47-95"><a href="https://beej.us/guide/bgnet/html/#cb47-95"></a>        perror<span class="op">(</span><span class="st">"listen"</span><span class="op">);</span></span>
<span id="cb47-96"><a href="https://beej.us/guide/bgnet/html/#cb47-96"></a>        exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb47-97"><a href="https://beej.us/guide/bgnet/html/#cb47-97"></a>    <span class="op">}</span></span>
<span id="cb47-98"><a href="https://beej.us/guide/bgnet/html/#cb47-98"></a></span>
<span id="cb47-99"><a href="https://beej.us/guide/bgnet/html/#cb47-99"></a>    sa<span class="op">.</span>sa_handler <span class="op">=</span> sigchld_handler<span class="op">;</span> <span class="co">// reap all dead processes</span></span>
<span id="cb47-100"><a href="https://beej.us/guide/bgnet/html/#cb47-100"></a>    sigemptyset<span class="op">(&amp;</span>sa<span class="op">.</span>sa_mask<span class="op">);</span></span>
<span id="cb47-101"><a href="https://beej.us/guide/bgnet/html/#cb47-101"></a>    sa<span class="op">.</span>sa_flags <span class="op">=</span> SA_RESTART<span class="op">;</span></span>
<span id="cb47-102"><a href="https://beej.us/guide/bgnet/html/#cb47-102"></a>    <span class="cf">if</span> <span class="op">(</span>sigaction<span class="op">(</span>SIGCHLD<span class="op">,</span> <span class="op">&amp;</span>sa<span class="op">,</span> NULL<span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb47-103"><a href="https://beej.us/guide/bgnet/html/#cb47-103"></a>        perror<span class="op">(</span><span class="st">"sigaction"</span><span class="op">);</span></span>
<span id="cb47-104"><a href="https://beej.us/guide/bgnet/html/#cb47-104"></a>        exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb47-105"><a href="https://beej.us/guide/bgnet/html/#cb47-105"></a>    <span class="op">}</span></span>
<span id="cb47-106"><a href="https://beej.us/guide/bgnet/html/#cb47-106"></a></span>
<span id="cb47-107"><a href="https://beej.us/guide/bgnet/html/#cb47-107"></a>    printf<span class="op">(</span><span class="st">"server: waiting for connections...</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb47-108"><a href="https://beej.us/guide/bgnet/html/#cb47-108"></a></span>
<span id="cb47-109"><a href="https://beej.us/guide/bgnet/html/#cb47-109"></a>    <span class="cf">while</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span>  <span class="co">// main accept() loop</span></span>
<span id="cb47-110"><a href="https://beej.us/guide/bgnet/html/#cb47-110"></a>        sin_size <span class="op">=</span> <span class="kw">sizeof</span> their_addr<span class="op">;</span></span>
<span id="cb47-111"><a href="https://beej.us/guide/bgnet/html/#cb47-111"></a>        new_fd <span class="op">=</span> accept<span class="op">(</span>sockfd<span class="op">,</span> <span class="op">(</span><span class="kw">struct</span> sockaddr <span class="op">*)&amp;</span>their_addr<span class="op">,</span> <span class="op">&amp;</span>sin_size<span class="op">);</span></span>
<span id="cb47-112"><a href="https://beej.us/guide/bgnet/html/#cb47-112"></a>        <span class="cf">if</span> <span class="op">(</span>new_fd <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb47-113"><a href="https://beej.us/guide/bgnet/html/#cb47-113"></a>            perror<span class="op">(</span><span class="st">"accept"</span><span class="op">);</span></span>
<span id="cb47-114"><a href="https://beej.us/guide/bgnet/html/#cb47-114"></a>            <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb47-115"><a href="https://beej.us/guide/bgnet/html/#cb47-115"></a>        <span class="op">}</span></span>
<span id="cb47-116"><a href="https://beej.us/guide/bgnet/html/#cb47-116"></a></span>
<span id="cb47-117"><a href="https://beej.us/guide/bgnet/html/#cb47-117"></a>        inet_ntop<span class="op">(</span>their_addr<span class="op">.</span>ss_family<span class="op">,</span></span>
<span id="cb47-118"><a href="https://beej.us/guide/bgnet/html/#cb47-118"></a>            get_in_addr<span class="op">((</span><span class="kw">struct</span> sockaddr <span class="op">*)&amp;</span>their_addr<span class="op">),</span></span>
<span id="cb47-119"><a href="https://beej.us/guide/bgnet/html/#cb47-119"></a>            s<span class="op">,</span> <span class="kw">sizeof</span> s<span class="op">);</span></span>
<span id="cb47-120"><a href="https://beej.us/guide/bgnet/html/#cb47-120"></a>        printf<span class="op">(</span><span class="st">"server: got connection from </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> s<span class="op">);</span></span>
<span id="cb47-121"><a href="https://beej.us/guide/bgnet/html/#cb47-121"></a></span>
<span id="cb47-122"><a href="https://beej.us/guide/bgnet/html/#cb47-122"></a>        <span class="cf">if</span> <span class="op">(!</span>fork<span class="op">())</span> <span class="op">{</span> <span class="co">// this is the child process</span></span>
<span id="cb47-123"><a href="https://beej.us/guide/bgnet/html/#cb47-123"></a>            close<span class="op">(</span>sockfd<span class="op">);</span> <span class="co">// child doesn't need the listener</span></span>
<span id="cb47-124"><a href="https://beej.us/guide/bgnet/html/#cb47-124"></a>            <span class="cf">if</span> <span class="op">(</span>send<span class="op">(</span>new_fd<span class="op">,</span> <span class="st">"Hello, world!"</span><span class="op">,</span> <span class="dv">13</span><span class="op">,</span> <span class="dv">0</span><span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb47-125"><a href="https://beej.us/guide/bgnet/html/#cb47-125"></a>                perror<span class="op">(</span><span class="st">"send"</span><span class="op">);</span></span>
<span id="cb47-126"><a href="https://beej.us/guide/bgnet/html/#cb47-126"></a>            close<span class="op">(</span>new_fd<span class="op">);</span></span>
<span id="cb47-127"><a href="https://beej.us/guide/bgnet/html/#cb47-127"></a>            exit<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb47-128"><a href="https://beej.us/guide/bgnet/html/#cb47-128"></a>        <span class="op">}</span></span>
<span id="cb47-129"><a href="https://beej.us/guide/bgnet/html/#cb47-129"></a>        close<span class="op">(</span>new_fd<span class="op">);</span>  <span class="co">// parent doesn't need this</span></span>
<span id="cb47-130"><a href="https://beej.us/guide/bgnet/html/#cb47-130"></a>    <span class="op">}</span></span>
<span id="cb47-131"><a href="https://beej.us/guide/bgnet/html/#cb47-131"></a></span>
<span id="cb47-132"><a href="https://beej.us/guide/bgnet/html/#cb47-132"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb47-133"><a href="https://beej.us/guide/bgnet/html/#cb47-133"></a><span class="op">}</span></span></code></pre></div>
<p>In case you’re curious, I have the code in one big <code>main()</code> function for (I feel) syntactic clarity. Feel free to split it into smaller functions if it makes you feel better.</p>
<p>(Also, this whole <code>sigaction()</code> thing might be new to you—that’s OK. The code that’s there is responsible for reaping zombie processes that appear as the <code>fork()</code>ed child processes exit. If you make lots of zombies and don’t reap them, your system administrator will become agitated.)</p>
<p>You can get the data from this server by using the client listed in the next section.</p>
<p></p>
<h2 data-number="6.2" id="a-simple-stream-client"><span class="header-section-number">6.2</span> A Simple Stream Client</h2>
<p></p>
<p>This guy’s even easier than the server. All this client does is connect to the host you specify on the command line, port 3490. It gets the string that the server sends.</p>
<p><a href="https://beej.us/guide/bgnet/source/examples/client.c">The client source</a><a href="https://beej.us/guide/bgnet/html/#fn25" class="footnote-ref" id="fnref25" role="doc-noteref"><sup>25</sup></a>:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb48-1"><a href="https://beej.us/guide/bgnet/html/#cb48-1"></a><span class="co">/*</span></span>
<span id="cb48-2"><a href="https://beej.us/guide/bgnet/html/#cb48-2"></a><span class="co">** client.c -- a stream socket client demo</span></span>
<span id="cb48-3"><a href="https://beej.us/guide/bgnet/html/#cb48-3"></a><span class="co">*/</span></span>
<span id="cb48-4"><a href="https://beej.us/guide/bgnet/html/#cb48-4"></a></span>
<span id="cb48-5"><a href="https://beej.us/guide/bgnet/html/#cb48-5"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb48-6"><a href="https://beej.us/guide/bgnet/html/#cb48-6"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb48-7"><a href="https://beej.us/guide/bgnet/html/#cb48-7"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb48-8"><a href="https://beej.us/guide/bgnet/html/#cb48-8"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb48-9"><a href="https://beej.us/guide/bgnet/html/#cb48-9"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb48-10"><a href="https://beej.us/guide/bgnet/html/#cb48-10"></a><span class="pp">#include </span><span class="im">&lt;netdb.h&gt;</span></span>
<span id="cb48-11"><a href="https://beej.us/guide/bgnet/html/#cb48-11"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb48-12"><a href="https://beej.us/guide/bgnet/html/#cb48-12"></a><span class="pp">#include </span><span class="im">&lt;netinet/in.h&gt;</span></span>
<span id="cb48-13"><a href="https://beej.us/guide/bgnet/html/#cb48-13"></a><span class="pp">#include </span><span class="im">&lt;sys/socket.h&gt;</span></span>
<span id="cb48-14"><a href="https://beej.us/guide/bgnet/html/#cb48-14"></a></span>
<span id="cb48-15"><a href="https://beej.us/guide/bgnet/html/#cb48-15"></a><span class="pp">#include </span><span class="im">&lt;arpa/inet.h&gt;</span></span>
<span id="cb48-16"><a href="https://beej.us/guide/bgnet/html/#cb48-16"></a></span>
<span id="cb48-17"><a href="https://beej.us/guide/bgnet/html/#cb48-17"></a><span class="pp">#define PORT </span><span class="st">"3490"</span><span class="pp"> </span><span class="co">// the port client will be connecting to </span></span>
<span id="cb48-18"><a href="https://beej.us/guide/bgnet/html/#cb48-18"></a></span>
<span id="cb48-19"><a href="https://beej.us/guide/bgnet/html/#cb48-19"></a><span class="pp">#define MAXDATASIZE </span><span class="dv">100</span><span class="pp"> </span><span class="co">// max number of bytes we can get at once </span></span>
<span id="cb48-20"><a href="https://beej.us/guide/bgnet/html/#cb48-20"></a></span>
<span id="cb48-21"><a href="https://beej.us/guide/bgnet/html/#cb48-21"></a><span class="co">// get sockaddr, IPv4 or IPv6:</span></span>
<span id="cb48-22"><a href="https://beej.us/guide/bgnet/html/#cb48-22"></a><span class="dt">void</span> <span class="op">*</span>get_in_addr<span class="op">(</span><span class="kw">struct</span> sockaddr <span class="op">*</span>sa<span class="op">)</span></span>
<span id="cb48-23"><a href="https://beej.us/guide/bgnet/html/#cb48-23"></a><span class="op">{</span></span>
<span id="cb48-24"><a href="https://beej.us/guide/bgnet/html/#cb48-24"></a>    <span class="cf">if</span> <span class="op">(</span>sa<span class="op">-&gt;</span>sa_family <span class="op">==</span> AF_INET<span class="op">)</span> <span class="op">{</span></span>
<span id="cb48-25"><a href="https://beej.us/guide/bgnet/html/#cb48-25"></a>        <span class="cf">return</span> <span class="op">&amp;(((</span><span class="kw">struct</span> sockaddr_in<span class="op">*)</span>sa<span class="op">)-&gt;</span>sin_addr<span class="op">);</span></span>
<span id="cb48-26"><a href="https://beej.us/guide/bgnet/html/#cb48-26"></a>    <span class="op">}</span></span>
<span id="cb48-27"><a href="https://beej.us/guide/bgnet/html/#cb48-27"></a></span>
<span id="cb48-28"><a href="https://beej.us/guide/bgnet/html/#cb48-28"></a>    <span class="cf">return</span> <span class="op">&amp;(((</span><span class="kw">struct</span> sockaddr_in6<span class="op">*)</span>sa<span class="op">)-&gt;</span>sin6_addr<span class="op">);</span></span>
<span id="cb48-29"><a href="https://beej.us/guide/bgnet/html/#cb48-29"></a><span class="op">}</span></span>
<span id="cb48-30"><a href="https://beej.us/guide/bgnet/html/#cb48-30"></a></span>
<span id="cb48-31"><a href="https://beej.us/guide/bgnet/html/#cb48-31"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>argv<span class="op">[])</span></span>
<span id="cb48-32"><a href="https://beej.us/guide/bgnet/html/#cb48-32"></a><span class="op">{</span></span>
<span id="cb48-33"><a href="https://beej.us/guide/bgnet/html/#cb48-33"></a>    <span class="dt">int</span> sockfd<span class="op">,</span> numbytes<span class="op">;</span>  </span>
<span id="cb48-34"><a href="https://beej.us/guide/bgnet/html/#cb48-34"></a>    <span class="dt">char</span> buf<span class="op">[</span>MAXDATASIZE<span class="op">];</span></span>
<span id="cb48-35"><a href="https://beej.us/guide/bgnet/html/#cb48-35"></a>    <span class="kw">struct</span> addrinfo hints<span class="op">,</span> <span class="op">*</span>servinfo<span class="op">,</span> <span class="op">*</span>p<span class="op">;</span></span>
<span id="cb48-36"><a href="https://beej.us/guide/bgnet/html/#cb48-36"></a>    <span class="dt">int</span> rv<span class="op">;</span></span>
<span id="cb48-37"><a href="https://beej.us/guide/bgnet/html/#cb48-37"></a>    <span class="dt">char</span> s<span class="op">[</span>INET6_ADDRSTRLEN<span class="op">];</span></span>
<span id="cb48-38"><a href="https://beej.us/guide/bgnet/html/#cb48-38"></a></span>
<span id="cb48-39"><a href="https://beej.us/guide/bgnet/html/#cb48-39"></a>    <span class="cf">if</span> <span class="op">(</span>argc <span class="op">!=</span> <span class="dv">2</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb48-40"><a href="https://beej.us/guide/bgnet/html/#cb48-40"></a>        fprintf<span class="op">(</span>stderr<span class="op">,</span><span class="st">"usage: client hostname</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb48-41"><a href="https://beej.us/guide/bgnet/html/#cb48-41"></a>        exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb48-42"><a href="https://beej.us/guide/bgnet/html/#cb48-42"></a>    <span class="op">}</span></span>
<span id="cb48-43"><a href="https://beej.us/guide/bgnet/html/#cb48-43"></a></span>
<span id="cb48-44"><a href="https://beej.us/guide/bgnet/html/#cb48-44"></a>    memset<span class="op">(&amp;</span>hints<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">sizeof</span> hints<span class="op">);</span></span>
<span id="cb48-45"><a href="https://beej.us/guide/bgnet/html/#cb48-45"></a>    hints<span class="op">.</span>ai_family <span class="op">=</span> AF_UNSPEC<span class="op">;</span></span>
<span id="cb48-46"><a href="https://beej.us/guide/bgnet/html/#cb48-46"></a>    hints<span class="op">.</span>ai_socktype <span class="op">=</span> SOCK_STREAM<span class="op">;</span></span>
<span id="cb48-47"><a href="https://beej.us/guide/bgnet/html/#cb48-47"></a></span>
<span id="cb48-48"><a href="https://beej.us/guide/bgnet/html/#cb48-48"></a>    <span class="cf">if</span> <span class="op">((</span>rv <span class="op">=</span> getaddrinfo<span class="op">(</span>argv<span class="op">[</span><span class="dv">1</span><span class="op">],</span> PORT<span class="op">,</span> <span class="op">&amp;</span>hints<span class="op">,</span> <span class="op">&amp;</span>servinfo<span class="op">))</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb48-49"><a href="https://beej.us/guide/bgnet/html/#cb48-49"></a>        fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">"getaddrinfo: </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> gai_strerror<span class="op">(</span>rv<span class="op">));</span></span>
<span id="cb48-50"><a href="https://beej.us/guide/bgnet/html/#cb48-50"></a>        <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb48-51"><a href="https://beej.us/guide/bgnet/html/#cb48-51"></a>    <span class="op">}</span></span>
<span id="cb48-52"><a href="https://beej.us/guide/bgnet/html/#cb48-52"></a></span>
<span id="cb48-53"><a href="https://beej.us/guide/bgnet/html/#cb48-53"></a>    <span class="co">// loop through all the results and connect to the first we can</span></span>
<span id="cb48-54"><a href="https://beej.us/guide/bgnet/html/#cb48-54"></a>    <span class="cf">for</span><span class="op">(</span>p <span class="op">=</span> servinfo<span class="op">;</span> p <span class="op">!=</span> NULL<span class="op">;</span> p <span class="op">=</span> p<span class="op">-&gt;</span>ai_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb48-55"><a href="https://beej.us/guide/bgnet/html/#cb48-55"></a>        <span class="cf">if</span> <span class="op">((</span>sockfd <span class="op">=</span> socket<span class="op">(</span>p<span class="op">-&gt;</span>ai_family<span class="op">,</span> p<span class="op">-&gt;</span>ai_socktype<span class="op">,</span></span>
<span id="cb48-56"><a href="https://beej.us/guide/bgnet/html/#cb48-56"></a>                p<span class="op">-&gt;</span>ai_protocol<span class="op">))</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb48-57"><a href="https://beej.us/guide/bgnet/html/#cb48-57"></a>            perror<span class="op">(</span><span class="st">"client: socket"</span><span class="op">);</span></span>
<span id="cb48-58"><a href="https://beej.us/guide/bgnet/html/#cb48-58"></a>            <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb48-59"><a href="https://beej.us/guide/bgnet/html/#cb48-59"></a>        <span class="op">}</span></span>
<span id="cb48-60"><a href="https://beej.us/guide/bgnet/html/#cb48-60"></a></span>
<span id="cb48-61"><a href="https://beej.us/guide/bgnet/html/#cb48-61"></a>        <span class="cf">if</span> <span class="op">(</span>connect<span class="op">(</span>sockfd<span class="op">,</span> p<span class="op">-&gt;</span>ai_addr<span class="op">,</span> p<span class="op">-&gt;</span>ai_addrlen<span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb48-62"><a href="https://beej.us/guide/bgnet/html/#cb48-62"></a>            close<span class="op">(</span>sockfd<span class="op">);</span></span>
<span id="cb48-63"><a href="https://beej.us/guide/bgnet/html/#cb48-63"></a>            perror<span class="op">(</span><span class="st">"client: connect"</span><span class="op">);</span></span>
<span id="cb48-64"><a href="https://beej.us/guide/bgnet/html/#cb48-64"></a>            <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb48-65"><a href="https://beej.us/guide/bgnet/html/#cb48-65"></a>        <span class="op">}</span></span>
<span id="cb48-66"><a href="https://beej.us/guide/bgnet/html/#cb48-66"></a></span>
<span id="cb48-67"><a href="https://beej.us/guide/bgnet/html/#cb48-67"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb48-68"><a href="https://beej.us/guide/bgnet/html/#cb48-68"></a>    <span class="op">}</span></span>
<span id="cb48-69"><a href="https://beej.us/guide/bgnet/html/#cb48-69"></a></span>
<span id="cb48-70"><a href="https://beej.us/guide/bgnet/html/#cb48-70"></a>    <span class="cf">if</span> <span class="op">(</span>p <span class="op">==</span> NULL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb48-71"><a href="https://beej.us/guide/bgnet/html/#cb48-71"></a>        fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">"client: failed to connect</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb48-72"><a href="https://beej.us/guide/bgnet/html/#cb48-72"></a>        <span class="cf">return</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb48-73"><a href="https://beej.us/guide/bgnet/html/#cb48-73"></a>    <span class="op">}</span></span>
<span id="cb48-74"><a href="https://beej.us/guide/bgnet/html/#cb48-74"></a></span>
<span id="cb48-75"><a href="https://beej.us/guide/bgnet/html/#cb48-75"></a>    inet_ntop<span class="op">(</span>p<span class="op">-&gt;</span>ai_family<span class="op">,</span> get_in_addr<span class="op">((</span><span class="kw">struct</span> sockaddr <span class="op">*)</span>p<span class="op">-&gt;</span>ai_addr<span class="op">),</span></span>
<span id="cb48-76"><a href="https://beej.us/guide/bgnet/html/#cb48-76"></a>            s<span class="op">,</span> <span class="kw">sizeof</span> s<span class="op">);</span></span>
<span id="cb48-77"><a href="https://beej.us/guide/bgnet/html/#cb48-77"></a>    printf<span class="op">(</span><span class="st">"client: connecting to </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> s<span class="op">);</span></span>
<span id="cb48-78"><a href="https://beej.us/guide/bgnet/html/#cb48-78"></a></span>
<span id="cb48-79"><a href="https://beej.us/guide/bgnet/html/#cb48-79"></a>    freeaddrinfo<span class="op">(</span>servinfo<span class="op">);</span> <span class="co">// all done with this structure</span></span>
<span id="cb48-80"><a href="https://beej.us/guide/bgnet/html/#cb48-80"></a></span>
<span id="cb48-81"><a href="https://beej.us/guide/bgnet/html/#cb48-81"></a>    <span class="cf">if</span> <span class="op">((</span>numbytes <span class="op">=</span> recv<span class="op">(</span>sockfd<span class="op">,</span> buf<span class="op">,</span> MAXDATASIZE<span class="op">-</span><span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">))</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb48-82"><a href="https://beej.us/guide/bgnet/html/#cb48-82"></a>        perror<span class="op">(</span><span class="st">"recv"</span><span class="op">);</span></span>
<span id="cb48-83"><a href="https://beej.us/guide/bgnet/html/#cb48-83"></a>        exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb48-84"><a href="https://beej.us/guide/bgnet/html/#cb48-84"></a>    <span class="op">}</span></span>
<span id="cb48-85"><a href="https://beej.us/guide/bgnet/html/#cb48-85"></a></span>
<span id="cb48-86"><a href="https://beej.us/guide/bgnet/html/#cb48-86"></a>    buf<span class="op">[</span>numbytes<span class="op">]</span> <span class="op">=</span> <span class="ch">'</span><span class="sc">\0</span><span class="ch">'</span><span class="op">;</span></span>
<span id="cb48-87"><a href="https://beej.us/guide/bgnet/html/#cb48-87"></a></span>
<span id="cb48-88"><a href="https://beej.us/guide/bgnet/html/#cb48-88"></a>    printf<span class="op">(</span><span class="st">"client: received '</span><span class="sc">%s</span><span class="st">'</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span>buf<span class="op">);</span></span>
<span id="cb48-89"><a href="https://beej.us/guide/bgnet/html/#cb48-89"></a></span>
<span id="cb48-90"><a href="https://beej.us/guide/bgnet/html/#cb48-90"></a>    close<span class="op">(</span>sockfd<span class="op">);</span></span>
<span id="cb48-91"><a href="https://beej.us/guide/bgnet/html/#cb48-91"></a></span>
<span id="cb48-92"><a href="https://beej.us/guide/bgnet/html/#cb48-92"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb48-93"><a href="https://beej.us/guide/bgnet/html/#cb48-93"></a><span class="op">}</span></span></code></pre></div>
<p>Notice that if you don’t run the server before you run the client, <code>connect()</code> returns “Connection refused”. Very useful.</p>
<p></p>
<h2 data-number="6.3" id="datagram"><span class="header-section-number">6.3</span> Datagram Sockets</h2>
<p></p>
<p>We’ve already covered the basics of UDP datagram sockets with our discussion of <code>sendto()</code> and <code>recvfrom()</code>, above, so I’ll just present a couple of sample programs: <code>talker.c</code> and <code>listener.c</code>.</p>
<p><code>listener</code> sits on a machine waiting for an incoming packet on port 4950. <code>talker</code> sends a packet to that port, on the specified machine, that contains whatever the user enters on the command line.</p>
<p>Because datagram sockets are connectionless and just fire packets off into the ether with callous disregard for success, we are going to tell the client and server to use specifically IPv6. This way we avoid the situation where the server is listening on IPv6 and the client sends on IPv4; the data simply would not be received. (In our connected TCP stream sockets world, we might still have the mismatch, but the error on <code>connect()</code> for one address family would cause us to retry for the other.)</p>
<p>Here is the <a href="https://beej.us/guide/bgnet/source/examples/listener.c">source for <code>listener.c</code></a><a href="https://beej.us/guide/bgnet/html/#fn26" class="footnote-ref" id="fnref26" role="doc-noteref"><sup>26</sup></a>:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb49-1"><a href="https://beej.us/guide/bgnet/html/#cb49-1"></a><span class="co">/*</span></span>
<span id="cb49-2"><a href="https://beej.us/guide/bgnet/html/#cb49-2"></a><span class="co">** listener.c -- a datagram sockets "server" demo</span></span>
<span id="cb49-3"><a href="https://beej.us/guide/bgnet/html/#cb49-3"></a><span class="co">*/</span></span>
<span id="cb49-4"><a href="https://beej.us/guide/bgnet/html/#cb49-4"></a></span>
<span id="cb49-5"><a href="https://beej.us/guide/bgnet/html/#cb49-5"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb49-6"><a href="https://beej.us/guide/bgnet/html/#cb49-6"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb49-7"><a href="https://beej.us/guide/bgnet/html/#cb49-7"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb49-8"><a href="https://beej.us/guide/bgnet/html/#cb49-8"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb49-9"><a href="https://beej.us/guide/bgnet/html/#cb49-9"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb49-10"><a href="https://beej.us/guide/bgnet/html/#cb49-10"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb49-11"><a href="https://beej.us/guide/bgnet/html/#cb49-11"></a><span class="pp">#include </span><span class="im">&lt;sys/socket.h&gt;</span></span>
<span id="cb49-12"><a href="https://beej.us/guide/bgnet/html/#cb49-12"></a><span class="pp">#include </span><span class="im">&lt;netinet/in.h&gt;</span></span>
<span id="cb49-13"><a href="https://beej.us/guide/bgnet/html/#cb49-13"></a><span class="pp">#include </span><span class="im">&lt;arpa/inet.h&gt;</span></span>
<span id="cb49-14"><a href="https://beej.us/guide/bgnet/html/#cb49-14"></a><span class="pp">#include </span><span class="im">&lt;netdb.h&gt;</span></span>
<span id="cb49-15"><a href="https://beej.us/guide/bgnet/html/#cb49-15"></a></span>
<span id="cb49-16"><a href="https://beej.us/guide/bgnet/html/#cb49-16"></a><span class="pp">#define MYPORT </span><span class="st">"4950"</span><span class="pp">    </span><span class="co">// the port users will be connecting to</span></span>
<span id="cb49-17"><a href="https://beej.us/guide/bgnet/html/#cb49-17"></a></span>
<span id="cb49-18"><a href="https://beej.us/guide/bgnet/html/#cb49-18"></a><span class="pp">#define MAXBUFLEN </span><span class="dv">100</span></span>
<span id="cb49-19"><a href="https://beej.us/guide/bgnet/html/#cb49-19"></a></span>
<span id="cb49-20"><a href="https://beej.us/guide/bgnet/html/#cb49-20"></a><span class="co">// get sockaddr, IPv4 or IPv6:</span></span>
<span id="cb49-21"><a href="https://beej.us/guide/bgnet/html/#cb49-21"></a><span class="dt">void</span> <span class="op">*</span>get_in_addr<span class="op">(</span><span class="kw">struct</span> sockaddr <span class="op">*</span>sa<span class="op">)</span></span>
<span id="cb49-22"><a href="https://beej.us/guide/bgnet/html/#cb49-22"></a><span class="op">{</span></span>
<span id="cb49-23"><a href="https://beej.us/guide/bgnet/html/#cb49-23"></a>    <span class="cf">if</span> <span class="op">(</span>sa<span class="op">-&gt;</span>sa_family <span class="op">==</span> AF_INET<span class="op">)</span> <span class="op">{</span></span>
<span id="cb49-24"><a href="https://beej.us/guide/bgnet/html/#cb49-24"></a>        <span class="cf">return</span> <span class="op">&amp;(((</span><span class="kw">struct</span> sockaddr_in<span class="op">*)</span>sa<span class="op">)-&gt;</span>sin_addr<span class="op">);</span></span>
<span id="cb49-25"><a href="https://beej.us/guide/bgnet/html/#cb49-25"></a>    <span class="op">}</span></span>
<span id="cb49-26"><a href="https://beej.us/guide/bgnet/html/#cb49-26"></a></span>
<span id="cb49-27"><a href="https://beej.us/guide/bgnet/html/#cb49-27"></a>    <span class="cf">return</span> <span class="op">&amp;(((</span><span class="kw">struct</span> sockaddr_in6<span class="op">*)</span>sa<span class="op">)-&gt;</span>sin6_addr<span class="op">);</span></span>
<span id="cb49-28"><a href="https://beej.us/guide/bgnet/html/#cb49-28"></a><span class="op">}</span></span>
<span id="cb49-29"><a href="https://beej.us/guide/bgnet/html/#cb49-29"></a></span>
<span id="cb49-30"><a href="https://beej.us/guide/bgnet/html/#cb49-30"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb49-31"><a href="https://beej.us/guide/bgnet/html/#cb49-31"></a><span class="op">{</span></span>
<span id="cb49-32"><a href="https://beej.us/guide/bgnet/html/#cb49-32"></a>    <span class="dt">int</span> sockfd<span class="op">;</span></span>
<span id="cb49-33"><a href="https://beej.us/guide/bgnet/html/#cb49-33"></a>    <span class="kw">struct</span> addrinfo hints<span class="op">,</span> <span class="op">*</span>servinfo<span class="op">,</span> <span class="op">*</span>p<span class="op">;</span></span>
<span id="cb49-34"><a href="https://beej.us/guide/bgnet/html/#cb49-34"></a>    <span class="dt">int</span> rv<span class="op">;</span></span>
<span id="cb49-35"><a href="https://beej.us/guide/bgnet/html/#cb49-35"></a>    <span class="dt">int</span> numbytes<span class="op">;</span></span>
<span id="cb49-36"><a href="https://beej.us/guide/bgnet/html/#cb49-36"></a>    <span class="kw">struct</span> sockaddr_storage their_addr<span class="op">;</span></span>
<span id="cb49-37"><a href="https://beej.us/guide/bgnet/html/#cb49-37"></a>    <span class="dt">char</span> buf<span class="op">[</span>MAXBUFLEN<span class="op">];</span></span>
<span id="cb49-38"><a href="https://beej.us/guide/bgnet/html/#cb49-38"></a>    socklen_t addr_len<span class="op">;</span></span>
<span id="cb49-39"><a href="https://beej.us/guide/bgnet/html/#cb49-39"></a>    <span class="dt">char</span> s<span class="op">[</span>INET6_ADDRSTRLEN<span class="op">];</span></span>
<span id="cb49-40"><a href="https://beej.us/guide/bgnet/html/#cb49-40"></a></span>
<span id="cb49-41"><a href="https://beej.us/guide/bgnet/html/#cb49-41"></a>    memset<span class="op">(&amp;</span>hints<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">sizeof</span> hints<span class="op">);</span></span>
<span id="cb49-42"><a href="https://beej.us/guide/bgnet/html/#cb49-42"></a>    hints<span class="op">.</span>ai_family <span class="op">=</span> AF_INET6<span class="op">;</span> <span class="co">// set to AF_INET to use IPv4</span></span>
<span id="cb49-43"><a href="https://beej.us/guide/bgnet/html/#cb49-43"></a>    hints<span class="op">.</span>ai_socktype <span class="op">=</span> SOCK_DGRAM<span class="op">;</span></span>
<span id="cb49-44"><a href="https://beej.us/guide/bgnet/html/#cb49-44"></a>    hints<span class="op">.</span>ai_flags <span class="op">=</span> AI_PASSIVE<span class="op">;</span> <span class="co">// use my IP</span></span>
<span id="cb49-45"><a href="https://beej.us/guide/bgnet/html/#cb49-45"></a></span>
<span id="cb49-46"><a href="https://beej.us/guide/bgnet/html/#cb49-46"></a>    <span class="cf">if</span> <span class="op">((</span>rv <span class="op">=</span> getaddrinfo<span class="op">(</span>NULL<span class="op">,</span> MYPORT<span class="op">,</span> <span class="op">&amp;</span>hints<span class="op">,</span> <span class="op">&amp;</span>servinfo<span class="op">))</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb49-47"><a href="https://beej.us/guide/bgnet/html/#cb49-47"></a>        fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">"getaddrinfo: </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> gai_strerror<span class="op">(</span>rv<span class="op">));</span></span>
<span id="cb49-48"><a href="https://beej.us/guide/bgnet/html/#cb49-48"></a>        <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb49-49"><a href="https://beej.us/guide/bgnet/html/#cb49-49"></a>    <span class="op">}</span></span>
<span id="cb49-50"><a href="https://beej.us/guide/bgnet/html/#cb49-50"></a></span>
<span id="cb49-51"><a href="https://beej.us/guide/bgnet/html/#cb49-51"></a>    <span class="co">// loop through all the results and bind to the first we can</span></span>
<span id="cb49-52"><a href="https://beej.us/guide/bgnet/html/#cb49-52"></a>    <span class="cf">for</span><span class="op">(</span>p <span class="op">=</span> servinfo<span class="op">;</span> p <span class="op">!=</span> NULL<span class="op">;</span> p <span class="op">=</span> p<span class="op">-&gt;</span>ai_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb49-53"><a href="https://beej.us/guide/bgnet/html/#cb49-53"></a>        <span class="cf">if</span> <span class="op">((</span>sockfd <span class="op">=</span> socket<span class="op">(</span>p<span class="op">-&gt;</span>ai_family<span class="op">,</span> p<span class="op">-&gt;</span>ai_socktype<span class="op">,</span></span>
<span id="cb49-54"><a href="https://beej.us/guide/bgnet/html/#cb49-54"></a>                p<span class="op">-&gt;</span>ai_protocol<span class="op">))</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb49-55"><a href="https://beej.us/guide/bgnet/html/#cb49-55"></a>            perror<span class="op">(</span><span class="st">"listener: socket"</span><span class="op">);</span></span>
<span id="cb49-56"><a href="https://beej.us/guide/bgnet/html/#cb49-56"></a>            <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb49-57"><a href="https://beej.us/guide/bgnet/html/#cb49-57"></a>        <span class="op">}</span></span>
<span id="cb49-58"><a href="https://beej.us/guide/bgnet/html/#cb49-58"></a></span>
<span id="cb49-59"><a href="https://beej.us/guide/bgnet/html/#cb49-59"></a>        <span class="cf">if</span> <span class="op">(</span>bind<span class="op">(</span>sockfd<span class="op">,</span> p<span class="op">-&gt;</span>ai_addr<span class="op">,</span> p<span class="op">-&gt;</span>ai_addrlen<span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb49-60"><a href="https://beej.us/guide/bgnet/html/#cb49-60"></a>            close<span class="op">(</span>sockfd<span class="op">);</span></span>
<span id="cb49-61"><a href="https://beej.us/guide/bgnet/html/#cb49-61"></a>            perror<span class="op">(</span><span class="st">"listener: bind"</span><span class="op">);</span></span>
<span id="cb49-62"><a href="https://beej.us/guide/bgnet/html/#cb49-62"></a>            <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb49-63"><a href="https://beej.us/guide/bgnet/html/#cb49-63"></a>        <span class="op">}</span></span>
<span id="cb49-64"><a href="https://beej.us/guide/bgnet/html/#cb49-64"></a></span>
<span id="cb49-65"><a href="https://beej.us/guide/bgnet/html/#cb49-65"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb49-66"><a href="https://beej.us/guide/bgnet/html/#cb49-66"></a>    <span class="op">}</span></span>
<span id="cb49-67"><a href="https://beej.us/guide/bgnet/html/#cb49-67"></a></span>
<span id="cb49-68"><a href="https://beej.us/guide/bgnet/html/#cb49-68"></a>    <span class="cf">if</span> <span class="op">(</span>p <span class="op">==</span> NULL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb49-69"><a href="https://beej.us/guide/bgnet/html/#cb49-69"></a>        fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">"listener: failed to bind socket</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb49-70"><a href="https://beej.us/guide/bgnet/html/#cb49-70"></a>        <span class="cf">return</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb49-71"><a href="https://beej.us/guide/bgnet/html/#cb49-71"></a>    <span class="op">}</span></span>
<span id="cb49-72"><a href="https://beej.us/guide/bgnet/html/#cb49-72"></a></span>
<span id="cb49-73"><a href="https://beej.us/guide/bgnet/html/#cb49-73"></a>    freeaddrinfo<span class="op">(</span>servinfo<span class="op">);</span></span>
<span id="cb49-74"><a href="https://beej.us/guide/bgnet/html/#cb49-74"></a></span>
<span id="cb49-75"><a href="https://beej.us/guide/bgnet/html/#cb49-75"></a>    printf<span class="op">(</span><span class="st">"listener: waiting to recvfrom...</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb49-76"><a href="https://beej.us/guide/bgnet/html/#cb49-76"></a></span>
<span id="cb49-77"><a href="https://beej.us/guide/bgnet/html/#cb49-77"></a>    addr_len <span class="op">=</span> <span class="kw">sizeof</span> their_addr<span class="op">;</span></span>
<span id="cb49-78"><a href="https://beej.us/guide/bgnet/html/#cb49-78"></a>    <span class="cf">if</span> <span class="op">((</span>numbytes <span class="op">=</span> recvfrom<span class="op">(</span>sockfd<span class="op">,</span> buf<span class="op">,</span> MAXBUFLEN<span class="op">-</span><span class="dv">1</span> <span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb49-79"><a href="https://beej.us/guide/bgnet/html/#cb49-79"></a>        <span class="op">(</span><span class="kw">struct</span> sockaddr <span class="op">*)&amp;</span>their_addr<span class="op">,</span> <span class="op">&amp;</span>addr_len<span class="op">))</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb49-80"><a href="https://beej.us/guide/bgnet/html/#cb49-80"></a>        perror<span class="op">(</span><span class="st">"recvfrom"</span><span class="op">);</span></span>
<span id="cb49-81"><a href="https://beej.us/guide/bgnet/html/#cb49-81"></a>        exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb49-82"><a href="https://beej.us/guide/bgnet/html/#cb49-82"></a>    <span class="op">}</span></span>
<span id="cb49-83"><a href="https://beej.us/guide/bgnet/html/#cb49-83"></a></span>
<span id="cb49-84"><a href="https://beej.us/guide/bgnet/html/#cb49-84"></a>    printf<span class="op">(</span><span class="st">"listener: got packet from </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span></span>
<span id="cb49-85"><a href="https://beej.us/guide/bgnet/html/#cb49-85"></a>        inet_ntop<span class="op">(</span>their_addr<span class="op">.</span>ss_family<span class="op">,</span></span>
<span id="cb49-86"><a href="https://beej.us/guide/bgnet/html/#cb49-86"></a>            get_in_addr<span class="op">((</span><span class="kw">struct</span> sockaddr <span class="op">*)&amp;</span>their_addr<span class="op">),</span></span>
<span id="cb49-87"><a href="https://beej.us/guide/bgnet/html/#cb49-87"></a>            s<span class="op">,</span> <span class="kw">sizeof</span> s<span class="op">));</span></span>
<span id="cb49-88"><a href="https://beej.us/guide/bgnet/html/#cb49-88"></a>    printf<span class="op">(</span><span class="st">"listener: packet is </span><span class="sc">%d</span><span class="st"> bytes long</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> numbytes<span class="op">);</span></span>
<span id="cb49-89"><a href="https://beej.us/guide/bgnet/html/#cb49-89"></a>    buf<span class="op">[</span>numbytes<span class="op">]</span> <span class="op">=</span> <span class="ch">'</span><span class="sc">\0</span><span class="ch">'</span><span class="op">;</span></span>
<span id="cb49-90"><a href="https://beej.us/guide/bgnet/html/#cb49-90"></a>    printf<span class="op">(</span><span class="st">"listener: packet contains </span><span class="sc">\"%s\"\n</span><span class="st">"</span><span class="op">,</span> buf<span class="op">);</span></span>
<span id="cb49-91"><a href="https://beej.us/guide/bgnet/html/#cb49-91"></a></span>
<span id="cb49-92"><a href="https://beej.us/guide/bgnet/html/#cb49-92"></a>    close<span class="op">(</span>sockfd<span class="op">);</span></span>
<span id="cb49-93"><a href="https://beej.us/guide/bgnet/html/#cb49-93"></a></span>
<span id="cb49-94"><a href="https://beej.us/guide/bgnet/html/#cb49-94"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb49-95"><a href="https://beej.us/guide/bgnet/html/#cb49-95"></a><span class="op">}</span></span></code></pre></div>
<p>Notice that in our call to <code>getaddrinfo()</code> we’re finally using <code>SOCK_DGRAM</code>. Also, note that there’s no need to <code>listen()</code> or <code>accept()</code>. This is one of the perks of using unconnected datagram sockets!</p>
<p></p>
<p></p>
<p>Next comes the <a href="https://beej.us/guide/bgnet/source/examples/talker.c">source for <code>talker.c</code></a><a href="https://beej.us/guide/bgnet/html/#fn27" class="footnote-ref" id="fnref27" role="doc-noteref"><sup>27</sup></a>:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb50-1"><a href="https://beej.us/guide/bgnet/html/#cb50-1"></a><span class="co">/*</span></span>
<span id="cb50-2"><a href="https://beej.us/guide/bgnet/html/#cb50-2"></a><span class="co">** talker.c -- a datagram "client" demo</span></span>
<span id="cb50-3"><a href="https://beej.us/guide/bgnet/html/#cb50-3"></a><span class="co">*/</span></span>
<span id="cb50-4"><a href="https://beej.us/guide/bgnet/html/#cb50-4"></a></span>
<span id="cb50-5"><a href="https://beej.us/guide/bgnet/html/#cb50-5"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb50-6"><a href="https://beej.us/guide/bgnet/html/#cb50-6"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb50-7"><a href="https://beej.us/guide/bgnet/html/#cb50-7"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb50-8"><a href="https://beej.us/guide/bgnet/html/#cb50-8"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb50-9"><a href="https://beej.us/guide/bgnet/html/#cb50-9"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb50-10"><a href="https://beej.us/guide/bgnet/html/#cb50-10"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb50-11"><a href="https://beej.us/guide/bgnet/html/#cb50-11"></a><span class="pp">#include </span><span class="im">&lt;sys/socket.h&gt;</span></span>
<span id="cb50-12"><a href="https://beej.us/guide/bgnet/html/#cb50-12"></a><span class="pp">#include </span><span class="im">&lt;netinet/in.h&gt;</span></span>
<span id="cb50-13"><a href="https://beej.us/guide/bgnet/html/#cb50-13"></a><span class="pp">#include </span><span class="im">&lt;arpa/inet.h&gt;</span></span>
<span id="cb50-14"><a href="https://beej.us/guide/bgnet/html/#cb50-14"></a><span class="pp">#include </span><span class="im">&lt;netdb.h&gt;</span></span>
<span id="cb50-15"><a href="https://beej.us/guide/bgnet/html/#cb50-15"></a></span>
<span id="cb50-16"><a href="https://beej.us/guide/bgnet/html/#cb50-16"></a><span class="pp">#define SERVERPORT </span><span class="st">"4950"</span><span class="pp">    </span><span class="co">// the port users will be connecting to</span></span>
<span id="cb50-17"><a href="https://beej.us/guide/bgnet/html/#cb50-17"></a></span>
<span id="cb50-18"><a href="https://beej.us/guide/bgnet/html/#cb50-18"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>argv<span class="op">[])</span></span>
<span id="cb50-19"><a href="https://beej.us/guide/bgnet/html/#cb50-19"></a><span class="op">{</span></span>
<span id="cb50-20"><a href="https://beej.us/guide/bgnet/html/#cb50-20"></a>    <span class="dt">int</span> sockfd<span class="op">;</span></span>
<span id="cb50-21"><a href="https://beej.us/guide/bgnet/html/#cb50-21"></a>    <span class="kw">struct</span> addrinfo hints<span class="op">,</span> <span class="op">*</span>servinfo<span class="op">,</span> <span class="op">*</span>p<span class="op">;</span></span>
<span id="cb50-22"><a href="https://beej.us/guide/bgnet/html/#cb50-22"></a>    <span class="dt">int</span> rv<span class="op">;</span></span>
<span id="cb50-23"><a href="https://beej.us/guide/bgnet/html/#cb50-23"></a>    <span class="dt">int</span> numbytes<span class="op">;</span></span>
<span id="cb50-24"><a href="https://beej.us/guide/bgnet/html/#cb50-24"></a></span>
<span id="cb50-25"><a href="https://beej.us/guide/bgnet/html/#cb50-25"></a>    <span class="cf">if</span> <span class="op">(</span>argc <span class="op">!=</span> <span class="dv">3</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb50-26"><a href="https://beej.us/guide/bgnet/html/#cb50-26"></a>        fprintf<span class="op">(</span>stderr<span class="op">,</span><span class="st">"usage: talker hostname message</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb50-27"><a href="https://beej.us/guide/bgnet/html/#cb50-27"></a>        exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb50-28"><a href="https://beej.us/guide/bgnet/html/#cb50-28"></a>    <span class="op">}</span></span>
<span id="cb50-29"><a href="https://beej.us/guide/bgnet/html/#cb50-29"></a></span>
<span id="cb50-30"><a href="https://beej.us/guide/bgnet/html/#cb50-30"></a>    memset<span class="op">(&amp;</span>hints<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">sizeof</span> hints<span class="op">);</span></span>
<span id="cb50-31"><a href="https://beej.us/guide/bgnet/html/#cb50-31"></a>    hints<span class="op">.</span>ai_family <span class="op">=</span> AF_INET6<span class="op">;</span> <span class="co">// set to AF_INET to use IPv4</span></span>
<span id="cb50-32"><a href="https://beej.us/guide/bgnet/html/#cb50-32"></a>    hints<span class="op">.</span>ai_socktype <span class="op">=</span> SOCK_DGRAM<span class="op">;</span></span>
<span id="cb50-33"><a href="https://beej.us/guide/bgnet/html/#cb50-33"></a></span>
<span id="cb50-34"><a href="https://beej.us/guide/bgnet/html/#cb50-34"></a>    <span class="cf">if</span> <span class="op">((</span>rv <span class="op">=</span> getaddrinfo<span class="op">(</span>argv<span class="op">[</span><span class="dv">1</span><span class="op">],</span> SERVERPORT<span class="op">,</span> <span class="op">&amp;</span>hints<span class="op">,</span> <span class="op">&amp;</span>servinfo<span class="op">))</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb50-35"><a href="https://beej.us/guide/bgnet/html/#cb50-35"></a>        fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">"getaddrinfo: </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> gai_strerror<span class="op">(</span>rv<span class="op">));</span></span>
<span id="cb50-36"><a href="https://beej.us/guide/bgnet/html/#cb50-36"></a>        <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb50-37"><a href="https://beej.us/guide/bgnet/html/#cb50-37"></a>    <span class="op">}</span></span>
<span id="cb50-38"><a href="https://beej.us/guide/bgnet/html/#cb50-38"></a></span>
<span id="cb50-39"><a href="https://beej.us/guide/bgnet/html/#cb50-39"></a>    <span class="co">// loop through all the results and make a socket</span></span>
<span id="cb50-40"><a href="https://beej.us/guide/bgnet/html/#cb50-40"></a>    <span class="cf">for</span><span class="op">(</span>p <span class="op">=</span> servinfo<span class="op">;</span> p <span class="op">!=</span> NULL<span class="op">;</span> p <span class="op">=</span> p<span class="op">-&gt;</span>ai_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb50-41"><a href="https://beej.us/guide/bgnet/html/#cb50-41"></a>        <span class="cf">if</span> <span class="op">((</span>sockfd <span class="op">=</span> socket<span class="op">(</span>p<span class="op">-&gt;</span>ai_family<span class="op">,</span> p<span class="op">-&gt;</span>ai_socktype<span class="op">,</span></span>
<span id="cb50-42"><a href="https://beej.us/guide/bgnet/html/#cb50-42"></a>                p<span class="op">-&gt;</span>ai_protocol<span class="op">))</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb50-43"><a href="https://beej.us/guide/bgnet/html/#cb50-43"></a>            perror<span class="op">(</span><span class="st">"talker: socket"</span><span class="op">);</span></span>
<span id="cb50-44"><a href="https://beej.us/guide/bgnet/html/#cb50-44"></a>            <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb50-45"><a href="https://beej.us/guide/bgnet/html/#cb50-45"></a>        <span class="op">}</span></span>
<span id="cb50-46"><a href="https://beej.us/guide/bgnet/html/#cb50-46"></a></span>
<span id="cb50-47"><a href="https://beej.us/guide/bgnet/html/#cb50-47"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb50-48"><a href="https://beej.us/guide/bgnet/html/#cb50-48"></a>    <span class="op">}</span></span>
<span id="cb50-49"><a href="https://beej.us/guide/bgnet/html/#cb50-49"></a></span>
<span id="cb50-50"><a href="https://beej.us/guide/bgnet/html/#cb50-50"></a>    <span class="cf">if</span> <span class="op">(</span>p <span class="op">==</span> NULL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb50-51"><a href="https://beej.us/guide/bgnet/html/#cb50-51"></a>        fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">"talker: failed to create socket</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb50-52"><a href="https://beej.us/guide/bgnet/html/#cb50-52"></a>        <span class="cf">return</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb50-53"><a href="https://beej.us/guide/bgnet/html/#cb50-53"></a>    <span class="op">}</span></span>
<span id="cb50-54"><a href="https://beej.us/guide/bgnet/html/#cb50-54"></a></span>
<span id="cb50-55"><a href="https://beej.us/guide/bgnet/html/#cb50-55"></a>    <span class="cf">if</span> <span class="op">((</span>numbytes <span class="op">=</span> sendto<span class="op">(</span>sockfd<span class="op">,</span> argv<span class="op">[</span><span class="dv">2</span><span class="op">],</span> strlen<span class="op">(</span>argv<span class="op">[</span><span class="dv">2</span><span class="op">]),</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb50-56"><a href="https://beej.us/guide/bgnet/html/#cb50-56"></a>             p<span class="op">-&gt;</span>ai_addr<span class="op">,</span> p<span class="op">-&gt;</span>ai_addrlen<span class="op">))</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb50-57"><a href="https://beej.us/guide/bgnet/html/#cb50-57"></a>        perror<span class="op">(</span><span class="st">"talker: sendto"</span><span class="op">);</span></span>
<span id="cb50-58"><a href="https://beej.us/guide/bgnet/html/#cb50-58"></a>        exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb50-59"><a href="https://beej.us/guide/bgnet/html/#cb50-59"></a>    <span class="op">}</span></span>
<span id="cb50-60"><a href="https://beej.us/guide/bgnet/html/#cb50-60"></a></span>
<span id="cb50-61"><a href="https://beej.us/guide/bgnet/html/#cb50-61"></a>    freeaddrinfo<span class="op">(</span>servinfo<span class="op">);</span></span>
<span id="cb50-62"><a href="https://beej.us/guide/bgnet/html/#cb50-62"></a></span>
<span id="cb50-63"><a href="https://beej.us/guide/bgnet/html/#cb50-63"></a>    printf<span class="op">(</span><span class="st">"talker: sent </span><span class="sc">%d</span><span class="st"> bytes to </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> numbytes<span class="op">,</span> argv<span class="op">[</span><span class="dv">1</span><span class="op">]);</span></span>
<span id="cb50-64"><a href="https://beej.us/guide/bgnet/html/#cb50-64"></a>    close<span class="op">(</span>sockfd<span class="op">);</span></span>
<span id="cb50-65"><a href="https://beej.us/guide/bgnet/html/#cb50-65"></a></span>
<span id="cb50-66"><a href="https://beej.us/guide/bgnet/html/#cb50-66"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb50-67"><a href="https://beej.us/guide/bgnet/html/#cb50-67"></a><span class="op">}</span></span></code></pre></div>
<p>And that’s all there is to it! Run <code>listener</code> on some machine, then run <code>talker</code> on another. Watch them communicate! Fun G-rated excitement for the entire nuclear family!</p>
<p>You don’t even have to run the server this time! You can run <code>talker</code> by itself, and it just happily fires packets off into the ether where they disappear if no one is ready with a <code>recvfrom()</code> on the other side. Remember: data sent using UDP datagram sockets isn’t guaranteed to arrive!</p>
<p></p>
<p>Except for one more tiny detail that I’ve mentioned many times in the past: connected datagram sockets. I need to talk about this here, since we’re in the datagram section of the document. Let’s say that <code>talker</code> calls <code>connect()</code> and specifies the <code>listener</code>’s address. From that point on, <code>talker</code> may only send to and receive from the address specified by <code>connect()</code>. For this reason, you don’t have to use <code>sendto()</code> and <code>recvfrom()</code>; you can simply use <code>send()</code> and <code>recv()</code>.</p>
<p></p>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="7" id="slightly-advanced-techniques"><span class="header-section-number">7</span> Slightly Advanced Techniques</h1>
<p>These aren’t <em>really</em> advanced, but they’re getting out of the more basic levels we’ve already covered. In fact, if you’ve gotten this far, you should consider yourself fairly accomplished in the basics of Unix network programming! Congratulations!</p>
<p>So here we go into the brave new world of some of the more esoteric things you might want to learn about sockets. Have at it!</p>
<h2 data-number="7.1" id="blocking"><span class="header-section-number">7.1</span> Blocking</h2>
<p></p>
<p>Blocking. You’ve heard about it—now what the heck is it? In a nutshell, “block” is techie jargon for “sleep”. You probably noticed that when you run <code>listener</code>, above, it just sits there until a packet arrives. What happened is that it called <code>recvfrom()</code>, there was no data, and so <code>recvfrom()</code> is said to “block” (that is, sleep there) until some data arrives.</p>
<p>Lots of functions block. <code>accept()</code> blocks. All the <code>recv()</code> functions block. The reason they can do this is because they’re allowed to. When you first create the socket descriptor with <code>socket()</code>, the kernel sets it to blocking. If you don’t want a socket to be blocking, you have to make a call to <code>fcntl()</code>:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb51-1"><a href="https://beej.us/guide/bgnet/html/#cb51-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb51-2"><a href="https://beej.us/guide/bgnet/html/#cb51-2"></a><span class="pp">#include </span><span class="im">&lt;fcntl.h&gt;</span></span>
<span id="cb51-3"><a href="https://beej.us/guide/bgnet/html/#cb51-3"></a><span class="op">.</span></span>
<span id="cb51-4"><a href="https://beej.us/guide/bgnet/html/#cb51-4"></a><span class="op">.</span></span>
<span id="cb51-5"><a href="https://beej.us/guide/bgnet/html/#cb51-5"></a><span class="op">.</span></span>
<span id="cb51-6"><a href="https://beej.us/guide/bgnet/html/#cb51-6"></a>sockfd <span class="op">=</span> socket<span class="op">(</span>PF_INET<span class="op">,</span> SOCK_STREAM<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb51-7"><a href="https://beej.us/guide/bgnet/html/#cb51-7"></a>fcntl<span class="op">(</span>sockfd<span class="op">,</span> F_SETFL<span class="op">,</span> O_NONBLOCK<span class="op">);</span></span>
<span id="cb51-8"><a href="https://beej.us/guide/bgnet/html/#cb51-8"></a><span class="op">.</span></span>
<span id="cb51-9"><a href="https://beej.us/guide/bgnet/html/#cb51-9"></a><span class="op">.</span></span>
<span id="cb51-10"><a href="https://beej.us/guide/bgnet/html/#cb51-10"></a><span class="op">.</span> </span></code></pre></div>
<p>By setting a socket to non-blocking, you can effectively “poll” the socket for information. If you try to read from a non-blocking socket and there’s no data there, it’s not allowed to block—it will return <code>-1</code> and <code>errno</code> will be set to <code>EAGAIN</code> or <code>EWOULDBLOCK</code>.</p>
<p>(Wait—it can return <code>EAGAIN</code> <em>or</em> <code>EWOULDBLOCK</code>? Which do you check for? The specification doesn’t actually specify which your system will return, so for portability, check them both.)</p>
<p>Generally speaking, however, this type of polling is a bad idea. If you put your program in a busy-wait looking for data on the socket, you’ll suck up CPU time like it was going out of style. A more elegant solution for checking to see if there’s data waiting to be read comes in the following section on <code>poll()</code>.</p>
<p></p>
<h2 data-number="7.2" id="poll"><span class="header-section-number">7.2</span> <code>poll()</code>—Synchronous I/O Multiplexing</h2>
<p></p>
<p>What you really want to be able to do is somehow monitor a <em>bunch</em> of sockets at once and then handle the ones that have data ready. This way you don’t have to continuously poll all those sockets to see which are ready to read.</p>
<blockquote>
<p><em>A word of warning: <code>poll()</code> is horribly slow when it comes to giant numbers of connections. In those circumstances, you’ll get better performance out of an event library such as <a href="https://libevent.org/">libevent</a><a href="https://beej.us/guide/bgnet/html/#fn28" class="footnote-ref" id="fnref28" role="doc-noteref"><sup>28</sup></a> that attempts to use the fastest possible method availabile on your system.</em></p>
</blockquote>
<p>So how can you avoid polling? Not slightly ironically, you can avoid polling by using the <code>poll()</code> system call. In a nutshell, we’re going to ask the operating system to do all the dirty work for us, and just let us know when some data is ready to read on which sockets. In the meantime, our process can go to sleep, saving system resources.</p>
<p>The general gameplan is to keep an array of <code>struct pollfd</code>s with information about which socket descriptors we want to monitor, and what kind of events we want to monitor for. The OS will block on the <code>poll()</code> call until one of those events occurs (e.g.&nbsp;“socket ready to read!”) or until a user-specified timeout occurs.</p>
<p>Usefully, a <code>listen()</code>ing socket will return “ready to read” when a new incoming connection is ready to be <code>accept()</code>ed.</p>
<p>That’s enough banter. How do we use this?</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb52-1"><a href="https://beej.us/guide/bgnet/html/#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;poll.h&gt;</span></span>
<span id="cb52-2"><a href="https://beej.us/guide/bgnet/html/#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="https://beej.us/guide/bgnet/html/#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> poll<span class="op">(</span><span class="kw">struct</span> pollfd fds<span class="op">[],</span> nfds_t nfds<span class="op">,</span> <span class="dt">int</span> timeout<span class="op">);</span></span></code></pre></div>
<p><code>fds</code> is our array of information (which sockets to monitor for what), <code>nfds</code> is the count of elements in the array, and <code>timeout</code> is a timeout in milliseconds. It returns the number of elements in the array that have had an event occur.</p>
<p>Let’s have a look at that <code>struct</code>:</p>
<p></p>
<div class="sourceCode" id="cb53"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb53-1"><a href="https://beej.us/guide/bgnet/html/#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> pollfd <span class="op">{</span></span>
<span id="cb53-2"><a href="https://beej.us/guide/bgnet/html/#cb53-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> fd<span class="op">;</span>         <span class="co">// the socket descriptor</span></span>
<span id="cb53-3"><a href="https://beej.us/guide/bgnet/html/#cb53-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">short</span> events<span class="op">;</span>   <span class="co">// bitmap of events we're interested in</span></span>
<span id="cb53-4"><a href="https://beej.us/guide/bgnet/html/#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">short</span> revents<span class="op">;</span>  <span class="co">// when poll() returns, bitmap of events that occurred</span></span>
<span id="cb53-5"><a href="https://beej.us/guide/bgnet/html/#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>So we’re going to have an array of those, and we’ll set the <code>fd</code> field for each element to a socket descriptor we’re interested in monitoring. And then we’ll set the <code>events</code> field to indicate the type of events we’re interested in.</p>
<p>The <code>events</code> field is the bitwise-OR of the following:</p>
<table>
<colgroup>
<col style="width: 15%">
<col style="width: 84%">
</colgroup>
<thead>
<tr class="header">
<th>Macro</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>POLLIN</code></td>
<td>Alert me when data is ready to <code>recv()</code> on this socket.</td>
</tr>
<tr class="even">
<td><code>POLLOUT</code></td>
<td>Alert me when I can <code>send()</code> data to this socket without blocking.</td>
</tr>
<tr class="odd">
<td><code>POLLHUP</code></td>
<td>Alert me when the remote closed the connection.</td>
</tr>
</tbody>
</table>
<p>Once you have your array of <code>struct pollfd</code>s in order, then you can pass it to <code>poll()</code>, also passing the size of the array, as well as a timeout value in milliseconds. (You can specify a negative timeout to wait forever.)</p>
<p>After <code>poll()</code> returns, you can check the <code>revents</code> field to see if <code>POLLIN</code> or <code>POLLOUT</code> is set, indicating that event occurred.</p>
<p>(There’s actually more that you can do with the <code>poll()</code> call. See the <a href="https://beej.us/guide/bgnet/html/#pollman"><code>poll()</code> man page, below</a>, for more details.)</p>
<p>Here’s <a href="https://beej.us/guide/bgnet/source/examples/poll.c">an example</a><a href="https://beej.us/guide/bgnet/html/#fn29" class="footnote-ref" id="fnref29" role="doc-noteref"><sup>29</sup></a> where we’ll wait 2.5 seconds for data to be ready to read from standard input, i.e.&nbsp;when you hit <code>RETURN</code>:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb54-1"><a href="https://beej.us/guide/bgnet/html/#cb54-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb54-2"><a href="https://beej.us/guide/bgnet/html/#cb54-2"></a><span class="pp">#include </span><span class="im">&lt;poll.h&gt;</span></span>
<span id="cb54-3"><a href="https://beej.us/guide/bgnet/html/#cb54-3"></a></span>
<span id="cb54-4"><a href="https://beej.us/guide/bgnet/html/#cb54-4"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb54-5"><a href="https://beej.us/guide/bgnet/html/#cb54-5"></a><span class="op">{</span></span>
<span id="cb54-6"><a href="https://beej.us/guide/bgnet/html/#cb54-6"></a>    <span class="kw">struct</span> pollfd pfds<span class="op">[</span><span class="dv">1</span><span class="op">];</span> <span class="co">// More if you want to monitor more</span></span>
<span id="cb54-7"><a href="https://beej.us/guide/bgnet/html/#cb54-7"></a></span>
<span id="cb54-8"><a href="https://beej.us/guide/bgnet/html/#cb54-8"></a>    pfds<span class="op">[</span><span class="dv">0</span><span class="op">].</span>fd <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>          <span class="co">// Standard input</span></span>
<span id="cb54-9"><a href="https://beej.us/guide/bgnet/html/#cb54-9"></a>    pfds<span class="op">[</span><span class="dv">0</span><span class="op">].</span>events <span class="op">=</span> POLLIN<span class="op">;</span> <span class="co">// Tell me when ready to read</span></span>
<span id="cb54-10"><a href="https://beej.us/guide/bgnet/html/#cb54-10"></a></span>
<span id="cb54-11"><a href="https://beej.us/guide/bgnet/html/#cb54-11"></a>    <span class="co">// If you needed to monitor other things, as well:</span></span>
<span id="cb54-12"><a href="https://beej.us/guide/bgnet/html/#cb54-12"></a>    <span class="co">//pfds[1].fd = some_socket; // Some socket descriptor</span></span>
<span id="cb54-13"><a href="https://beej.us/guide/bgnet/html/#cb54-13"></a>    <span class="co">//pfds[1].events = POLLIN;  // Tell me when ready to read</span></span>
<span id="cb54-14"><a href="https://beej.us/guide/bgnet/html/#cb54-14"></a></span>
<span id="cb54-15"><a href="https://beej.us/guide/bgnet/html/#cb54-15"></a>    printf<span class="op">(</span><span class="st">"Hit RETURN or wait 2.5 seconds for timeout</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb54-16"><a href="https://beej.us/guide/bgnet/html/#cb54-16"></a></span>
<span id="cb54-17"><a href="https://beej.us/guide/bgnet/html/#cb54-17"></a>    <span class="dt">int</span> num_events <span class="op">=</span> poll<span class="op">(</span>pfds<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2500</span><span class="op">);</span> <span class="co">// 2.5 second timeout</span></span>
<span id="cb54-18"><a href="https://beej.us/guide/bgnet/html/#cb54-18"></a></span>
<span id="cb54-19"><a href="https://beej.us/guide/bgnet/html/#cb54-19"></a>    <span class="cf">if</span> <span class="op">(</span>num_events <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb54-20"><a href="https://beej.us/guide/bgnet/html/#cb54-20"></a>        printf<span class="op">(</span><span class="st">"Poll timed out!</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb54-21"><a href="https://beej.us/guide/bgnet/html/#cb54-21"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb54-22"><a href="https://beej.us/guide/bgnet/html/#cb54-22"></a>        <span class="dt">int</span> pollin_happened <span class="op">=</span> pfds<span class="op">[</span><span class="dv">0</span><span class="op">].</span>revents <span class="op">&amp;</span> POLLIN<span class="op">;</span></span>
<span id="cb54-23"><a href="https://beej.us/guide/bgnet/html/#cb54-23"></a></span>
<span id="cb54-24"><a href="https://beej.us/guide/bgnet/html/#cb54-24"></a>        <span class="cf">if</span> <span class="op">(</span>pollin_happened<span class="op">)</span> <span class="op">{</span></span>
<span id="cb54-25"><a href="https://beej.us/guide/bgnet/html/#cb54-25"></a>            printf<span class="op">(</span><span class="st">"File descriptor </span><span class="sc">%d</span><span class="st"> is ready to read</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> pfds<span class="op">[</span><span class="dv">0</span><span class="op">].</span>fd<span class="op">);</span></span>
<span id="cb54-26"><a href="https://beej.us/guide/bgnet/html/#cb54-26"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb54-27"><a href="https://beej.us/guide/bgnet/html/#cb54-27"></a>            printf<span class="op">(</span><span class="st">"Unexpected event occurred: </span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> pfds<span class="op">[</span><span class="dv">0</span><span class="op">].</span>revents<span class="op">);</span></span>
<span id="cb54-28"><a href="https://beej.us/guide/bgnet/html/#cb54-28"></a>        <span class="op">}</span></span>
<span id="cb54-29"><a href="https://beej.us/guide/bgnet/html/#cb54-29"></a>    <span class="op">}</span></span>
<span id="cb54-30"><a href="https://beej.us/guide/bgnet/html/#cb54-30"></a></span>
<span id="cb54-31"><a href="https://beej.us/guide/bgnet/html/#cb54-31"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb54-32"><a href="https://beej.us/guide/bgnet/html/#cb54-32"></a><span class="op">}</span></span></code></pre></div>
<p>Notice again that <code>poll()</code> returns the number of elements in the <code>pfds</code> array for which events have occurred. It doesn’t tell you <em>which</em> elements in the array (you still have to scan for that), but it does tell you how many entries have a non-zero <code>revents</code> field (so you can stop scanning after you find that many).</p>
<p>A couple questions might come up here: how to add new file descriptors to the set I pass to <code>poll()</code>? For this, simply make sur</p></body></html>